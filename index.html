<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Job Helper – Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; max-width: 900px; margin: 40px auto; }
    button { padding: 10px 14px; border: 1px solid #ccc; border-radius: 8px; cursor: pointer; }
    #rows { margin-top: 16px; border: 1px solid #eee; border-radius: 10px; padding: 16px; }
    .row { padding: 10px 8px; border-bottom: 1px solid #eee; }
    .row:last-child { border-bottom: none; }
    .muted { color: #666; font-size: 12px; }
    input, select { padding: 8px; border: 1px solid #ddd; border-radius: 6px; }
    .stack { display: flex; gap: 8px; flex-wrap: wrap; margin: 10px 0; }
    .bar { display:flex; align-items:center; justify-content:space-between; gap: 12px; }
    .pill { background:#f5f5f5; padding:4px 10px; border-radius: 999px; font-size:12px;}
    pre { background:#fafafa; padding:10px; border-radius:8px; overflow:auto; }
  </style>
</head>
<body>
  <h1>Graduate Job Helper</h1>

  <div class="bar">
    <div id="who" class="pill">Not signed in</div>
    <div class="stack">
      <button id="btn-google">Sign in with Google</button>
      <button id="btn-email">Send magic link</button>
      <button id="btn-signout" style="display:none;">Sign out</button>
    </div>
  </div>

  <div id="dev" class="muted" style="margin-top:6px;"></div>

  <h2>Your applications</h2>

  <div class="stack">
    <input id="title" placeholder="Title e.g. Graduate Analyst" />
    <input id="company" placeholder="Company e.g. Elixirr" />
    <select id="status">
      <option>Draft</option>
      <option>Applied</option>
      <option>Online assessment</option>
      <option>Interview</option>
      <option>Offer</option>
      <option>Rejected</option>
    </select>
    <button id="btn-insert">+ Add row</button>
  </div>

  <div id="rows">Loading…</div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ⬇️ Fill these in from your Supabase project settings
    const SUPABASE_URL = 'https://YOUR-PROJECT-REF.supabase.co';
    const SUPABASE_ANON_KEY = 'YOUR-ANON-KEY';

    // Why: this talks to the Supabase REST API & Auth
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const whoEl = document.getElementById('who');
    const devEl = document.getElementById('dev');
    const rowsEl = document.getElementById('rows');

    const btnGoogle = document.getElementById('btn-google');
    const btnEmail  = document.getElementById('btn-email');
    const btnSignout= document.getElementById('btn-signout');
    const btnInsert = document.getElementById('btn-insert');

    const titleEl   = document.getElementById('title');
    const companyEl = document.getElementById('company');
    const statusEl  = document.getElementById('status');

    // show helper text
    devEl.textContent = 'Tip: if Google sign-in returns to a blank page, add this page URL to Auth → Providers → Google → Redirect URLs.';

    // auth state handler
    supabase.auth.onAuthStateChange(async (_evt, session) => {
      const user = session?.user || null;
      renderUser(user);
      if (user) { await refreshRows(); }
      else { rowsEl.innerHTML = 'Sign in to see your rows.'; }
    });

    // initial load
    (async () => {
      const { data } = await supabase.auth.getSession();
      renderUser(data.session?.user || null);
      if (data.session?.user) await refreshRows();
    })();

    function renderUser(user) {
      if (user) {
        whoEl.textContent = `Signed in as ${user.email} · id ${user.id.slice(0,8)}…`;
        btnSignout.style.display = '';
      } else {
        whoEl.textContent = 'Not signed in';
        btnSignout.style.display = 'none';
      }
    }

    btnGoogle.onclick = async () => {
      // Why: starts Google OAuth; Supabase will redirect back here
      const { error } = await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: { redirectTo: window.location.origin }
      });
      if (error) alert(error.message);
    };

    btnEmail.onclick = async () => {
      const email = prompt('Email to send a magic link to:', 'ogpheard2@gmail.com');
      if (!email) return;
      const { error } = await supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: window.location.origin }});
      if (error) return alert(error.message);
      alert('Check your inbox for the sign-in link.');
    };

    btnSignout.onclick = async () => {
      await supabase.auth.signOut();
    };

    btnInsert.onclick = async () => {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return alert('Please sign in first.');
      const title = titleEl.value.trim() || 'Untitled';
      const company = companyEl.value.trim() || 'Unknown';
      const status = statusEl.value;

      // Why: include user_id so the RLS “insert_own” policy passes
      const { error } = await supabase
        .from('graduate_job_helper')
        .insert([{ title, company_name: company, status, user_id: user.id }]);

      if (error) { alert('Insert error: ' + error.message); return; }

      titleEl.value = ''; companyEl.value = '';
      await refreshRows();
    };

    async function refreshRows() {
      // Why: RLS ensures you only see your rows
      const { data, error } = await supabase
        .from('graduate_job_helper')
        .select('application_id,title,company_name,status,status_update_date')
        .order('status_update_date', { ascending: false, nullsFirst: false })
        .limit(50);

      if (error) {
        rowsEl.innerHTML = `<div class="muted">Error: ${error.message}</div>`;
        return;
      }
      if (!data || data.length === 0) {
        rowsEl.innerHTML = `<div class="muted">No rows yet. Add one above.</div>`;
        return;
      }
      rowsEl.innerHTML = data.map(r => `
        <div class="row">
          <strong>${r.title || '(no title)'}</strong> · ${r.company_name || '(no company)'}
          <div class="muted">status: ${r.status || '—'} · id: ${r.application_id}</div>
        </div>
      `).join('');
    }
  </script>
</body>
</html>
