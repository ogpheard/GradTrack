<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Graduate Applications Tracker â€” Cloud Backup (v11)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <!-- Firebase (compat versions for maximum browser compatibility) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    :root{
      /* Light theme palette */
      --bg:#f7f7fb; --card:#ffffff; --muted:#64748b; --text:#0f172a;
      --accent1:#4f46e5; --accent2:#06b6d4; --shadow:0 6px 18px rgba(15,23,42,.08);
      --radius:16px;
      --applied:#2563eb; --aptitude:#d97706; --interview:#16a34a; --offer:#7c3aed; --rejected:#dc2626; --ghosted:#6b7280;
      --border:#e5e7eb; --border-strong:#d1d5db; --chip:#f1f5f9;
    }
    *{ box-sizing:border-box } html,body{ height:100% }
    body{ margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--text); background:var(--bg) }
    .app{ max-width:1200px; margin:28px auto; padding:0 20px 40px }
    header.appbar{ display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:20px }
    .logo{ display:flex; align-items:center; gap:14px }
    .logo .dot{ width:12px; height:12px; border-radius:50%; background:linear-gradient(135deg,var(--accent1),var(--accent2)); box-shadow:0 0 0 6px rgba(79,70,229,.10),0 0 0 12px rgba(6,182,212,.08) }
    h1{ font-size:clamp(22px,3vw,30px); margin:0; font-weight:800; letter-spacing:.3px }
    .sub{ color:var(--muted); font-size:14px }

    .controls{ display:flex; flex-wrap:wrap; gap:10px; align-items:center }
    button,.btn{ background:linear-gradient(135deg,#ffffff,#f8fafc); border:1px solid var(--border);
      color:var(--text); padding:10px 14px; border-radius:12px; font-weight:600; cursor:pointer; transition:transform .06s ease, box-shadow .2s ease, border-color .2s ease; box-shadow:0 2px 0 rgba(15,23,42,.03) }
    button:hover{ transform:translateY(-1px); border-color:var(--border-strong) }
    .btn-danger{ background:linear-gradient(135deg,#fee2e2,#fff1f2); border-color:#fecaca; color:#991b1b }
    .btn-ghost{ background:#ffffff; border-color:var(--border) }
    input,select,textarea{ width:100%; padding:12px; border-radius:12px; border:1px solid var(--border); background:#fff; color:var(--text) }
    input:focus,select:focus,textarea:focus{ border-color:#94a3b8; outline:none; box-shadow:0 0 0 4px rgba(148,163,184,.2) }

    .grid{ display:grid; grid-template-columns:1.3fr .9fr; gap:18px; align-items:start }
    @media (max-width:1050px){ .grid{ grid-template-columns:1fr } }

    .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden; animation:fadeUp .6s ease both }
    @keyframes fadeUp{ from{ opacity:0; transform:translateY(10px)} to{ opacity:1; transform:translateY(0)} }
    .card header{ padding:14px 16px; border-bottom:1px solid var(--border) }
    .card header h2{ margin:0; font-size:18px; font-weight:700 }
    .card .content{ padding:16px }

    .badge{ display:inline-flex; align-items:center; gap:6px; padding:8px 10px; border-radius:999px; font-size:12px; border:1px solid var(--border); background:#fff }
    .badge.ok{ border-color:#bbf7d0; background:#f0fdf4; color:#166534 }
    .badge.warn{ border-color:#fde68a; background:#fffbeb; color:#92400e }
    .badge.off{ border-color:#fecaca; background:#fff1f2; color:#991b1b }

    /* Table */
    .table-toolbar{ display:flex; flex-wrap:wrap; gap:10px; align-items:end; margin-bottom:10px }
    .table-toolbar .field{ display:flex; flex-direction:column; gap:6px }
    .table-toolbar label{ font-size:12px; color:var(--muted) }
    table{ width:100%; border-collapse:separate; border-spacing:0 8px }
    thead th{ text-align:left; font-size:12px; color:var(--muted); font-weight:700; padding:0 10px; user-select:none; cursor:pointer }
    thead th.sortable:hover{ color:#0f172a }
    thead th .arrow{ opacity:.6; font-size:10px; margin-left:6px }
    tbody tr{ background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); transition:transform .12s ease }
    tbody tr:hover{ transform:translateY(-2px) }
    tbody td{ padding:12px 10px; vertical-align:top }
    tbody td:first-child{ border-top-left-radius:12px; border-bottom-left-radius:12px }
    tbody td:last-child{ border-top-right-radius:12px; border-bottom-right-radius:12px }

    /* Left accent by status */
    .row-status-Applied{ box-shadow: inset 4px 0 0 var(--applied), var(--shadow) }
    .row-status-Aptitude-Test{ box-shadow: inset 4px 0 0 var(--aptitude), var(--shadow) }
    .row-status-Interview{ box-shadow: inset 4px 0 0 var(--interview), var(--shadow) }
    .row-status-Offer{ box-shadow: inset 4px 0 0 var(--offer), var(--shadow) }
    .row-status-Rejected{ box-shadow: inset 4px 0 0 var(--rejected), var(--shadow) }
    .row-status-Ghosted{ box-shadow: inset 4px 0 0 var(--ghosted), var(--shadow) }

    .row-actions{ display:flex; gap:8px }

    /* Charts */
    .charts{ display:grid; grid-template-columns:1.2fr 1fr; gap:14px }
    @media (max-width:900px){ .charts{ grid-template-columns:1fr } }
    .chart-wrap{ padding:12px; background:#fff; border:1px solid var(--border); border-radius:14px; position:relative; min-width:0; overflow:hidden }
    .chart-wrap.enlargeable{ cursor:zoom-in }
    .chart-wrap .expand-hint{ position:absolute; right:10px; top:8px; font-size:12px; color:var(--muted) }
    #statusPie{ min-height:280px; width:100% }

    a.link{ color:var(--accent1); text-decoration:none } a.link:hover{ text-decoration:underline }

    .sector-chip{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:var(--chip); border:1px solid var(--border) }
    .sector-chip .del{ background:transparent; border:none; color:#ef4444; cursor:pointer; font-weight:800; line-height:1 }

    /* Modal */
    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:50 }
    .modal.show{ display:flex }
    .backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.3) }
    .modal-card{ position:relative; width:min(1100px,92vw); height:min(72vh,720px); background:#fff; border:1px solid var(--border); border-radius:16px; box-shadow:0 20px 50px rgba(0,0,0,.15); overflow:hidden }
    .modal-card header{ display:flex; align-items:center; justify-content:space-between; padding:10px 14px; border-bottom:1px solid var(--border) }
    .modal-card h3{ margin:0; font-size:16px }
    .modal-card .close{ background:#fff; border:1px solid var(--border); color:#0f172a; padding:6px 10px; border-radius:10px; cursor:pointer }
    .modal-card .body{ padding:12px; height:calc(100% - 48px) }

    /* Range controls */
    .rangebar{ display:flex; gap:8px; align-items:end; flex-wrap:wrap; margin-bottom:10px }
    .rangebar .field{ display:flex; flex-direction:column; gap:6px }
  </style>
</head>
<body>
  <div class="app" id="app">
    <header class="appbar">
      <div class="logo">
        <span class="dot"></span>
        <div>
          <h1>Graduate Applications Tracker</h1>
          <div class="sub">Light theme â€¢ Date range on daily chart â€¢ Search â€¢ Role type â€¢ Cloud backup</div>
        </div>
      </div>
      <div class="controls">
        <span id="syncBadge" class="badge off" title="Cloud sync status">Offline</span>
        <button id="signinBtn" type="button">Sign in with Google</button>
        <button id="signoutBtn" class="btn-ghost hidden" type="button">Sign out</button>
        <button id="exportJsonBtn" title="Download a local backup" type="button">Export JSON</button>
        <button id="importJsonBtn" class="btn-ghost" title="Restore from a JSON backup" type="button">Import JSON</button>
        <input type="file" id="importFile" accept="application/json" class="hidden" />
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <header>
          <h2>Applications</h2>
        </header>
        <div class="content">

          <div class="rangebar">
            <div class="field">
              <label for="rangeSelect">Chart range</label>
              <select id="rangeSelect">
                <option value="7d">Last 7 days</option>
                <option value="30d" selected>Last 30 days</option>
                <option value="90d">Last 90 days</option>
                <option value="ytd">Year to date</option>
                <option value="all">All time</option>
                <option value="custom">Customâ€¦</option>
              </select>
            </div>
            <div id="customRangeFields" class="field" style="display:none">
              <label>Custom range</label>
              <div style="display:flex; gap:8px">
                <input type="date" id="rangeFrom">
                <input type="date" id="rangeTo">
                <button id="applyRangeBtn" type="button">Apply</button>
              </div>
            </div>
            <div class="field" style="margin-left:auto">
              <label for="searchInput">Search (company or role)</label>
              <input id="searchInput" placeholder="e.g., Barclays or Analyst" />
            </div>
          </div>

          <div class="charts">
            <div class="chart-wrap enlargeable" id="dailyWrap" title="Click to enlarge">
              <span class="expand-hint">Click to enlarge</span>
              <canvas id="dailyChart" height="150" aria-label="Applications per day and cumulative"></canvas>
            </div>
            <div class="chart-wrap" id="statusWrap">
              <canvas id="statusPie" height="150" aria-label="Applications by status"></canvas>
            </div>
          </div>

          <div class="table-toolbar">
            <div class="field">
              <label for="sectorFilter">Filter by sector</label>
              <select id="sectorFilter"></select>
            </div>
            <div class="field">
              <label for="typeFilter">Filter by role type</label>
              <select id="typeFilter"></select>
            </div>
            <div class="field">
              <label for="sortKey">Sort by</label>
              <select id="sortKey">
                <option value="applied">Applied date</option>
                <option value="company">Company</option>
                <option value="role">Role</option>
                <option value="location">Location</option>
                <option value="sector">Sector</option>
                <option value="type">Type</option>
                <option value="closing">Closing date</option>
                <option value="start">Start date</option>
              </select>
            </div>
            <div class="field">
              <label for="sortDir">Direction</label>
              <select id="sortDir">
                <option value="desc">Descending</option>
                <option value="asc">Ascending</option>
              </select>
            </div>
            <div style="align-self:end; padding-bottom:2px">
              <button id="applySortBtn" class="btn-ghost" type="button">Apply</button>
              <button id="clearFilterBtn" class="btn-ghost" type="button">Clear</button>
            </div>
          </div>

          <div style="overflow:auto">
            <table id="appsTable">
              <thead>
                <tr>
                  <th class="sortable" data-key="company">Company <span class="arrow" id="arrow-company"></span></th>
                  <th class="sortable" data-key="role">Role <span class="arrow" id="arrow-role"></span></th>
                  <th class="sortable" data-key="type">Type <span class="arrow" id="arrow-type"></span></th>
                  <th class="sortable" data-key="sector">Sector <span class="arrow" id="arrow-sector"></span></th>
                  <th>Status</th>
                  <th class="sortable" data-key="applied">Applied <span class="arrow" id="arrow-applied"></span></th>
                  <th class="sortable" data-key="closing">Closing <span class="arrow" id="arrow-closing"></span></th>
                  <th class="sortable" data-key="start">Start <span class="arrow" id="arrow-start"></span></th>
                  <th class="sortable" data-key="location">Location <span class="arrow" id="arrow-location"></span></th>
                  <th>Link</th>
                  <th>Description</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="sub" style="margin-top:10px">
            <span id="lastBackup" class="badge warn">No cloud backup yet</span>
          </div>
        </div>
      </section>

      <aside class="card">
        <header>
          <h2 id="formTitle">Add Application</h2>
        </header>
        <div class="content">
          <form id="appForm">
            <input type="hidden" id="appId" />

            <div>
              <label for="company">Company</label>
              <input id="company" required placeholder="e.g., Acme Corp" />
            </div>
            <div>
              <label for="role">Role Title</label>
              <input id="role" required placeholder="e.g., Graduate Analyst" />
            </div>

            <div>
              <label for="type">Role Type</label>
              <select id="type" required></select>
            </div>
            <div>
              <label for="sector">Sector</label>
              <select id="sector" required></select>
            </div>

            <div>
              <label for="status">Status</label>
              <select id="status" required>
                <option>Applied</option>
                <option>Aptitude Test</option>
                <option>Interview</option>
                <option>Offer</option>
                <option>Rejected</option>
                <option>Ghosted</option>
              </select>
            </div>

            <div>
              <label for="applied">Applied Date</label>
              <input id="applied" type="date" required />
            </div>
            <div>
              <label for="closing">Closing Date</label>
              <input id="closing" type="date" />
            </div>

            <div>
              <label for="start">Start Date</label>
              <input id="start" type="date" />
            </div>
            <div>
              <label for="location">Location</label>
              <input id="location" placeholder="e.g., London" />
            </div>

            <div class="full">
              <label for="url">Job Link (optional)</label>
              <input id="url" type="url" placeholder="https://company.com/graduate-role" />
            </div>

            <div class="full">
              <label for="description">Role Description</label>
              <textarea id="description" placeholder="Short summary or notes"></textarea>
            </div>

            <div class="full" style="display:flex; gap:10px; margin-top:4px">
              <button type="submit" id="saveBtn">Save</button>
              <button type="button" id="cancelEditBtn" class="btn-ghost hidden">Cancel Edit</button>
            </div>
          </form>

          <hr style="border:none; border-top:1px solid var(--border); margin:18px 0">

          <div>
            <h3 style="margin:0 0 8px; font-size:14px">Manage Sectors</h3>
            <div class="controls" style="gap:8px">
              <input id="newSector" placeholder="Add sector (e.g., Finance)"/>
              <button id="addSectorBtn" type="button">Add</button>
            </div>
            <div id="sectorsList" style="margin-top:10px; display:flex; flex-wrap:wrap; gap:8px"></div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Modal for enlarged Daily chart -->
  <div class="modal" id="dailyModal" aria-hidden="true">
    <div class="backdrop" id="modalBackdrop"></div>
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <header>
        <h3 id="modalTitle">Applications per Day (Cumulative)</h3>
        <button class="close" id="modalClose" type="button">Close âœ•</button>
      </header>
      <div class="body">
        <canvas id="modalDailyCanvas"></canvas>
      </div>
    </div>
  </div>

  <script>
    // ============================
    // Local storage + UI + new features (v11)
    // ============================
    const STORAGE_KEY = 'gradAppTracker:data:v11';
    const SECTORS_KEY = 'gradAppTracker:sectors:v3';
    const TYPES_KEY = 'gradAppTracker:types:v1';
    const DEFAULT_SECTORS = ['Finance','Consulting','Engineering','Sales'];
    const DEFAULT_TYPES = ['Graduate Job','Internship','Placement','Apprenticeship','Job','Other'];
    const STAGES = ['Applied','Aptitude Test','Interview','Offer','Rejected','Ghosted'];

    // --- Date helpers (use LOCAL dates so "today" shows correctly in UK time) ---
    const toYMDLocal = (d)=>{
      const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      const y = x.getFullYear(), m = String(x.getMonth()+1).padStart(2,'0'), da = String(x.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    }
    const parseYMDLocal = (ymd)=> new Date(ymd+'T00:00:00');

    function uuid(){ return crypto.randomUUID ? crypto.randomUUID() : (Date.now().toString(36)+Math.random().toString(36).slice(2,8)) }

    function loadData(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw) return JSON.parse(raw);
      const keys = ['gradAppTracker:data:v10','gradAppTracker:data:v9','gradAppTracker:data:v8'];
      for(const k of keys){ const v = localStorage.getItem(k); if(v) return JSON.parse(v); }
      return [];
    }
    function saveData(data){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); queueCloudSave(); }

    function loadSectors(){
      const raw = localStorage.getItem(SECTORS_KEY);
      if(raw) return JSON.parse(raw);
      const keys = ['gradAppTracker:sectors:v2','gradAppTracker:sectors:v1'];
      for(const k of keys){ const v = localStorage.getItem(k); if(v) return JSON.parse(v); }
      return [...DEFAULT_SECTORS];
    }
    function saveSectors(sectors){ localStorage.setItem(SECTORS_KEY, JSON.stringify([...new Set(sectors)].filter(Boolean))); queueCloudSave(); }

    function loadTypes(){ const raw = localStorage.getItem(TYPES_KEY); return raw?JSON.parse(raw):[...DEFAULT_TYPES]; }
    function saveTypes(types){ localStorage.setItem(TYPES_KEY, JSON.stringify([...new Set(types)].filter(Boolean))); queueCloudSave(); }

    let applications = loadData();
    let sectors = loadSectors();
    let roleTypes = loadTypes();

    // --- UI refs ---
    const appsTableBody = document.querySelector('#appsTable tbody');
    const sectorSelect = document.querySelector('#sector');
    const typeSelect = document.querySelector('#type');
    const sectorsList = document.querySelector('#sectorsList');
    const sectorFilter = document.querySelector('#sectorFilter');
    const typeFilter = document.querySelector('#typeFilter');
    const searchInput = document.querySelector('#searchInput');

    const form = document.querySelector('#appForm');
    const formTitle = document.querySelector('#formTitle');
    const cancelEditBtn = document.querySelector('#cancelEditBtn');

    const exportBtn = document.querySelector('#exportJsonBtn');
    const importBtn = document.querySelector('#importJsonBtn');
    const importFile = document.querySelector('#importFile');

    const sortKeySel = document.querySelector('#sortKey');
    const sortDirSel = document.querySelector('#sortDir');
    const applySortBtn = document.querySelector('#applySortBtn');
    const clearFilterBtn = document.querySelector('#clearFilterBtn');

    const dailyWrap = document.getElementById('dailyWrap');
    const statusWrap = document.getElementById('statusWrap');
    const dailyModal = document.getElementById('dailyModal');
    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalClose = document.getElementById('modalClose');

    const rangeSelect = document.getElementById('rangeSelect');
    const customRangeFields = document.getElementById('customRangeFields');
    const rangeFromInp = document.getElementById('rangeFrom');
    const rangeToInp = document.getElementById('rangeTo');
    const applyRangeBtn = document.getElementById('applyRangeBtn');

    const signinBtn = document.getElementById('signinBtn');
    const signoutBtn = document.getElementById('signoutBtn');
    const syncBadge = document.getElementById('syncBadge');
    const lastBackupEl = document.getElementById('lastBackup');

    let dailyChart, statusPie, modalDailyChart;
    let currentSort = { key: 'applied', dir: 'desc' };

    // Range state
    let rangeMode = '30d';
    let rangeFrom = null; // 'YYYY-MM-DD' when custom
    let rangeTo = null;

    function escapeHtml(str){ return (str||'').replace(/[&<>\"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[c])); }
    function formatDate(d){ if(!d) return ''; try{ const x = parseYMDLocal(d); return x.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'2-digit'}); } catch { return d } }
    function normalizeStatusForClass(status){ return (status||'Applied').replace(/\s+/g,'-'); }
    function renderLink(u){ if(!u) return ''; const safe = escapeHtml(u); return `<a class="link" href="${safe}" target="_blank" rel="noopener">Open</a>` }

    // --- Sector & type management ---
    function renderSectorOptions(){
      sectorSelect.innerHTML = sectors.map(s => `<option>${escapeHtml(s)}</option>`).join('');
      sectorFilter.innerHTML = `<option value="">All sectors</option>` + sectors.map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join('');
    }
    function renderTypeOptions(){
      typeSelect.innerHTML = roleTypes.map(t => `<option>${escapeHtml(t)}</option>`).join('');
      typeFilter.innerHTML = `<option value="">All types</option>` + roleTypes.map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');
    }
    function renderSectorsPills(){
      sectorsList.innerHTML = '';
      sectors.forEach(s => {
        const chip = document.createElement('span');
        chip.className = 'sector-chip';
        const lbl = document.createElement('span'); lbl.textContent = `ðŸ·ï¸ ${s}`;
        const btn = document.createElement('button'); btn.type = 'button'; btn.className = 'del'; btn.textContent = 'Ã—'; btn.title = `Delete ${s}`; btn.dataset.name = s;
        chip.append(lbl, btn); sectorsList.appendChild(chip);
      });
    }
    sectorsList.addEventListener('click', (e) => {
      const btn = e.target.closest('button.del');
      if(!btn) return; const name = btn.dataset.name; if(!name) return; deleteSectorFlow(name);
    });
    function ensureOtherSector(){ if(!sectors.includes('Other')) { sectors.push('Other'); saveSectors(sectors); } }
    function deleteSectorFlow(name){
      const count = applications.filter(a => a.sector===name).length;
      const proceed = confirm(`Delete sector "${name}"?${count?`\n\n${count} application(s) currently use this sector. They will be reassigned to "Other".`:''}`);
      if(!proceed) return;
      if(count){ ensureOtherSector(); applications = applications.map(a => a.sector===name ? { ...a, sector:'Other' } : a); saveData(applications); }
      sectors = sectors.filter(s => s!==name); saveSectors(sectors);
      renderSectorOptions(); renderSectorsPills(); renderTable(); renderCharts();
    }
    document.getElementById('addSectorBtn').addEventListener('click', () => {
      const inp = document.getElementById('newSector');
      const val = inp.value.trim(); if(!val) return;
      if(sectors.includes(val)) { alert('Sector already exists.'); return; }
      sectors.push(val); saveSectors(sectors); inp.value=''; renderSectorOptions(); renderSectorsPills();
    });

    // --- Sorting & filtering ---
    function cmp(a,b){ return a<b?-1:a>b?1:0; }
    function dateCmp(da,db){ if(!da&&!db) return 0; if(!da) return -1; if(!db) return 1; return cmp(da,db); }

    function applySortAndFilter(rows){
      const fSector = sectorFilter.value;
      const fType = typeFilter.value;
      const term = searchInput.value.trim().toLowerCase();
      let arr = [...rows];
      if(fSector) arr = arr.filter(r => r.sector===fSector);
      if(fType) arr = arr.filter(r => (r.type||'')===fType);
      if(term) arr = arr.filter(r => (r.company||'').toLowerCase().includes(term) || (r.role||'').toLowerCase().includes(term));
      const { key, dir } = currentSort; const sgn = dir==='asc'?1:-1;
      arr.sort((x,y)=>{
        if(['applied','closing','start'].includes(key)) return sgn*dateCmp(x[key]||'', y[key]||'');
        return sgn*cmp((x[key]||'').toLowerCase(), (y[key]||'').toLowerCase());
      });
      return arr;
    }

    function updateHeaderArrows(){ document.querySelectorAll('thead th .arrow').forEach(el => el.textContent=''); const arr = document.getElementById('arrow-' + currentSort.key); if(arr) arr.textContent = currentSort.dir==='asc' ? 'â–²' : 'â–¼'; }

    document.querySelectorAll('#appsTable thead th.sortable').forEach(th => {
      th.addEventListener('click', () => {
        const key = th.getAttribute('data-key');
        if(currentSort.key===key){ currentSort.dir = currentSort.dir==='asc'?'desc':'asc'; } else { currentSort.key = key; currentSort.dir = key==='applied'?'desc':'asc'; }
        sortKeySel.value = currentSort.key; sortDirSel.value = currentSort.dir; renderTable();
      });
    });

    ;['input','change'].forEach(ev => searchInput.addEventListener(ev, ()=> renderTable()));
    applySortBtn.addEventListener('click', () => { currentSort.key = sortKeySel.value; currentSort.dir = sortDirSel.value; renderTable(); });
    clearFilterBtn.addEventListener('click', () => { sectorFilter.value=''; typeFilter.value=''; searchInput.value=''; renderTable(); });

    // --- Table rendering ---
    function renderTable(){
      appsTableBody.innerHTML = '';
      const frag = document.createDocumentFragment();
      updateHeaderArrows();
      const rows = applySortAndFilter(applications);

      rows.forEach(app => {
        const tr = document.createElement('tr');
        tr.className = 'row-status-' + normalizeStatusForClass(app.status);
        tr.innerHTML = `
          <td><strong>${escapeHtml(app.company)}</strong></td>
          <td>${escapeHtml(app.role)}</td>
          <td>${escapeHtml(app.type||'')}</td>
          <td><span class="pill">${escapeHtml(app.sector)}</span></td>
          <td>
            <select data-id="${app.id}" class="statusSelect">
              ${STAGES.map(s => `<option ${s===app.status?'selected':''}>${s}</option>`).join('')}
            </select>
          </td>
          <td>${formatDate(app.applied)}</td>
          <td>${formatDate(app.closing)}</td>
          <td>${formatDate(app.start)}</td>
          <td>${escapeHtml(app.location||'')}</td>
          <td>${renderLink(app.url)}</td>
          <td style="max-width:260px">${escapeHtml(app.description||'')}</td>
          <td>
            <div class="row-actions">
              <button class="btn-ghost" data-action="edit" data-id="${app.id}" type="button">Edit</button>
              <button class="btn-danger" data-action="delete" data-id="${app.id}" type="button">Delete</button>
            </div>
          </td>`;
        frag.appendChild(tr);
      });

      appsTableBody.appendChild(frag);
      appsTableBody.querySelectorAll('button[data-action]').forEach(btn => btn.addEventListener('click', onRowAction));
      appsTableBody.querySelectorAll('select.statusSelect').forEach(sel => sel.addEventListener('change', onStatusChange));
      renderCharts();
    }

    function onRowAction(e){
      const id = e.currentTarget.getAttribute('data-id');
      const action = e.currentTarget.getAttribute('data-action');
      if(action==='delete'){
        if(!confirm('Delete this application?')) return;
        applications = applications.filter(a => a.id!==id);
        saveData(applications); renderTable();
      }
      if(action==='edit'){
        const app = applications.find(a => a.id===id); if(!app) return;
        document.getElementById('appId').value = app.id;
        document.getElementById('company').value = app.company;
        document.getElementById('role').value = app.role;
        document.getElementById('type').value = app.type || roleTypes[0];
        document.getElementById('sector').value = app.sector;
        document.getElementById('status').value = app.status;
        document.getElementById('applied').value = app.applied || '';
        document.getElementById('closing').value = app.closing || '';
        document.getElementById('start').value = app.start || '';
        document.getElementById('location').value = app.location || '';
        document.getElementById('description').value = app.description || '';
        document.getElementById('url').value = app.url || '';
        formTitle.textContent = 'Edit Application';
        cancelEditBtn.classList.remove('hidden');
        document.getElementById('company').focus();
      }
    }

    function onStatusChange(e){
      const id = e.currentTarget.getAttribute('data-id');
      const app = applications.find(a => a.id===id); if(!app) return;
      app.status = e.currentTarget.value; saveData(applications); renderTable();
    }

    cancelEditBtn.addEventListener('click', () => {
      form.reset(); document.getElementById('appId').value=''; formTitle.textContent='Add Application'; cancelEditBtn.classList.add('hidden');
    });

    // --- Form submit ---
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const id = document.getElementById('appId').value || uuid();
      const rawUrl = document.getElementById('url').value.trim();
      const safeUrl = rawUrl && !/^https?:\/\//i.test(rawUrl) ? 'https://' + rawUrl : rawUrl;
      const app = {
        id,
        company: document.getElementById('company').value.trim(),
        role: document.getElementById('role').value.trim(),
        type: document.getElementById('type').value,
        sector: document.getElementById('sector').value,
        status: document.getElementById('status').value,
        applied: document.getElementById('applied').value,
        closing: document.getElementById('closing').value,
        start: document.getElementById('start').value,
        location: document.getElementById('location').value.trim(),
        description: document.getElementById('description').value.trim(),
        url: safeUrl,
      };
      const exists = applications.some(a => a.id===id);
      if(exists){ applications = applications.map(a => a.id===id ? app : a); } else { applications.push(app); }
      saveData(applications); renderTable(); form.reset(); document.getElementById('appId').value=''; formTitle.textContent='Add Application'; cancelEditBtn.classList.add('hidden');
    });

    // --- Charts with range ---
    function buildDailySeries(){
      const allDates = applications.filter(a=>a.applied).map(a=>a.applied).sort();
      const todayYMD = toYMDLocal(new Date());
      const maxYMD = allDates.length? allDates[allDates.length-1] : todayYMD;
      const endYMD = maxYMD < todayYMD ? todayYMD : maxYMD; // include today even if no apps

      let startYMD = allDates.length ? allDates[0] : todayYMD;
      let from = null, to = null;

      if(rangeMode==='all'){
        from = startYMD; to = endYMD;
      } else if(rangeMode==='ytd'){
        const y = new Date().getFullYear(); from = `${y}-01-01`; to = endYMD;
      } else if(['7d','30d','90d'].includes(rangeMode)){
        const days = { '7d':7, '30d':30, '90d':90 }[rangeMode];
        const toDate = parseYMDLocal(endYMD);
        const fromDate = new Date(toDate); fromDate.setDate(fromDate.getDate() - (days - 1));
        from = toYMDLocal(fromDate); to = endYMD;
      } else if(rangeMode==='custom'){
        from = rangeFrom || startYMD; to = rangeTo || endYMD;
      }

      const labels = [];
      const counts = new Map();
      applications.forEach(a=>{ if(!a.applied) return; if(a.applied>=from && a.applied<=to){ counts.set(a.applied, (counts.get(a.applied)||0)+1); } });
      let d = parseYMDLocal(from); const end = parseYMDLocal(to);
      while(d<=end){ labels.push(toYMDLocal(d)); d = new Date(d.getFullYear(), d.getMonth(), d.getDate()+1); }
      const perDay = labels.map(key => counts.get(key)||0);
      const cumulative = []; let run = 0; perDay.forEach(n => { run += n; cumulative.push(run); });
      return { labels, perDay, cumulative };
    }

    function getDailyChartConfig(){
      const s = buildDailySeries();
      return {
        type:'bar',
        data:{
          labels: s.labels.map(x => parseYMDLocal(x)),
          datasets: [
            { type:'bar', label:'Applications per day', data: s.perDay, borderWidth:0, yAxisID:'y', barPercentage:0.6, categoryPercentage:0.8 },
            { type:'line', label:'Cumulative total', data: s.cumulative, tension:.35, fill:false, borderWidth:2, yAxisID:'y1' }
          ]
        },
        options:{
          animation:{ duration:500, easing:'easeOutQuart' },
          scales:{ x:{ type:'time', time:{ unit:'day' }, grid:{ display:false }, ticks:{ color:'#475569' } }, y:{ beginAtZero:true, ticks:{ precision:0, color:'#475569' }, grid:{ color:'#e2e8f0' } }, y1:{ position:'right', beginAtZero:true, ticks:{ precision:0, color:'#475569' }, grid:{ drawOnChartArea:false } } },
          plugins:{ legend:{ labels:{ color:'#334155' } }, tooltip:{ mode:'index', intersect:false } }, maintainAspectRatio:false
        }
      }
    }

    function legendPos(){ const w = statusWrap.offsetWidth || window.innerWidth; return w >= 520 ? 'right' : 'bottom'; }

    function renderDailyComboChart(){ if(typeof Chart === 'undefined') return; const ctx = document.getElementById('dailyChart'); if(!ctx) return; const cfg = getDailyChartConfig(); if(dailyChart){ dailyChart.data = cfg.data; dailyChart.options = cfg.options; dailyChart.update(); } else { dailyChart = new Chart(ctx, cfg); } }

    function renderStatusPie(){ if(typeof Chart === 'undefined') return; const ctx = document.getElementById('statusPie'); if(!ctx) return; const byStatus = STAGES.map(s => ({ s, n: applications.filter(a => (a.status||'Applied')===s).length })); const colors = { Applied:'var(--applied)','Aptitude Test':'var(--aptitude)',Interview:'var(--interview)',Offer:'var(--offer)',Rejected:'var(--rejected)',Ghosted:'var(--ghosted)' }; const data = { labels: byStatus.map(x=>x.s), datasets:[{ data: byStatus.map(x=>x.n), backgroundColor: byStatus.map(x=>colors[x.s]) }] }; const options = { responsive:true, maintainAspectRatio:false, layout:{ padding:8 }, plugins:{ legend:{ position:legendPos(), labels:{ color:'#334155', usePointStyle:true, boxWidth:10, boxHeight:10, padding:12, font:{ size:12 } } }, tooltip:{ callbacks:{ label:(c)=> `${c.label}: ${c.raw}` } } } }; if(statusPie){ statusPie.data=data; statusPie.options=options; statusPie.update(); } else { statusPie = new Chart(ctx,{ type:'pie', data, options }); } }

    function renderCharts(){ renderDailyComboChart(); renderStatusPie(); }
    window.addEventListener('resize', () => { if(statusPie){ statusPie.options.plugins.legend.position = legendPos(); statusPie.update(); } });

    // Range UI actions
    rangeSelect.addEventListener('change', () => {
      rangeMode = rangeSelect.value;
      const showCustom = rangeMode==='custom';
      customRangeFields.style.display = showCustom ? '' : 'none';
      if(!showCustom){ renderCharts(); }
    });
    applyRangeBtn.addEventListener('click', () => {
      rangeFrom = rangeFromInp.value || null; rangeTo = rangeToInp.value || null; if(rangeFrom && rangeTo && rangeFrom>rangeTo){ const t=rangeFrom; rangeFrom=rangeTo; rangeTo=t; rangeFromInp.value=rangeFrom; rangeToInp.value=rangeTo; }
      renderCharts();
    });

    // Import/Export
    exportBtn.addEventListener('click', () => { const ts = toYMDLocal(new Date()); const blob = new Blob([JSON.stringify({ applications, sectors, roleTypes, version:'v11' }, null, 2)], { type:'application/json' }); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`graduate-applications-backup-${ts}.json`; a.click(); URL.revokeObjectURL(url); });
    importBtn.addEventListener('click', () => importFile.click());
    importFile.addEventListener('change', async (e) => { const file = e.target.files[0]; if(!file) return; const text = await file.text(); try{ const parsed = JSON.parse(text); if(Array.isArray(parsed.applications)) applications = parsed.applications; else if(Array.isArray(parsed)) applications = parsed; if(Array.isArray(parsed.sectors)) sectors = parsed.sectors; if(Array.isArray(parsed.roleTypes)) roleTypes = parsed.roleTypes; saveData(applications); saveSectors(sectors); saveTypes(roleTypes); renderSectorOptions(); renderTypeOptions(); renderSectorsPills(); renderTable(); } catch(err){ alert('Invalid JSON file.'); } importFile.value=''; });

    // Modal enlarge behaviour
    function openDailyModal(){ dailyModal.classList.add('show'); const ctx = document.getElementById('modalDailyCanvas'); const cfg = getDailyChartConfig(); if(modalDailyChart){ modalDailyChart.destroy(); } modalDailyChart = new Chart(ctx, cfg); document.addEventListener('keydown', escHandler); }
    function closeDailyModal(){ dailyModal.classList.remove('show'); if(modalDailyChart){ modalDailyChart.destroy(); modalDailyChart=null; } document.removeEventListener('keydown', escHandler); }
    function escHandler(e){ if(e.key==='Escape') closeDailyModal(); }
    dailyWrap.addEventListener('click', openDailyModal); modalBackdrop.addEventListener('click', closeDailyModal); modalClose.addEventListener('click', closeDailyModal);

    // Init
    function init(){
      renderSectorOptions(); renderTypeOptions(); renderSectorsPills();
      sortKeySel.value = currentSort.key; sortDirSel.value = currentSort.dir; sectorFilter.value=''; typeFilter.value='';
      renderTable(); renderCharts();
      const today = toYMDLocal(new Date()); document.getElementById('applied').value = today; rangeToInp.value=today;
    }
    init();

    // ============================
    // Cloud sync (Firebase) â€“ unchanged API, now also stores roleTypes
    // ============================
    const firebaseConfig = {
      apiKey: "PASTE_HERE",
      authDomain: "PASTE_HERE",
      projectId: "PASTE_HERE",
      storageBucket: "PASTE_HERE",
      messagingSenderId: "PASTE_HERE",
      appId: "PASTE_HERE"
    };

    let auth=null, db=null, cloudReady=false, saveTimer=null;

    function configLooksFilled(){ return Object.values(firebaseConfig).every(v => v && !/PASTE_HERE/i.test(String(v))); }
    function setBadge(text, cls){ syncBadge.textContent = text; syncBadge.className = 'badge ' + cls; }
    function updateLastBackup(ts){ if(!ts){ lastBackupEl.textContent = 'No cloud backup yet'; lastBackupEl.className='badge warn'; return; } const d = ts.toLocaleString?.() || ts; lastBackupEl.textContent = 'Last cloud backup: ' + d; lastBackupEl.className='badge ok'; }
    function queueCloudSave(){ if(!cloudReady || !auth?.currentUser) return; clearTimeout(saveTimer); saveTimer = setTimeout(pushToCloud, 600); }

    async function pushToCloud(){ if(!cloudReady || !auth.currentUser) return; try{ const ref = db.collection('users').doc(auth.currentUser.uid).collection('tracker').doc('state'); await ref.set({ applications, sectors, roleTypes, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true }); setBadge('Synced', 'ok'); await autoDailyBackup(); } catch(err){ console.warn('Cloud save failed', err); setBadge('Sync error', 'warn'); } }
    async function autoDailyBackup(){ if(!auth.currentUser) return; const ymd = toYMDLocal(new Date()); const bref = db.collection('users').doc(auth.currentUser.uid).collection('backups').doc(ymd); await bref.set({ applications, sectors, roleTypes, ts: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true }); updateLastBackup(new Date()); }
    async function loadFromCloud(){ try{ const ref = db.collection('users').doc(auth.currentUser.uid).collection('tracker').doc('state'); const snap = await ref.get(); if(snap.exists){ const d = snap.data(); if(Array.isArray(d.applications)) applications = d.applications; if(Array.isArray(d.sectors)) sectors = d.sectors; if(Array.isArray(d.roleTypes)) roleTypes = d.roleTypes; saveData(applications); saveSectors(sectors); saveTypes(roleTypes); renderSectorOptions(); renderTypeOptions(); renderSectorsPills(); renderTable(); setBadge('Loaded from cloud', 'ok'); } else { await ref.set({ applications, sectors, roleTypes, createdAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true }); setBadge('Initialised cloud', 'ok'); } await autoDailyBackup(); } catch(err){ console.warn('Load from cloud failed', err); setBadge('Cloud unavailable', 'warn'); } }

    function setupAuth(){ const provider = new firebase.auth.GoogleAuthProvider(); signinBtn.onclick = () => auth.signInWithPopup(provider).catch(err => alert('Sign-in failed: ' + err.message)); signoutBtn.onclick = () => auth.signOut(); auth.onAuthStateChanged(async (u) => { if(u){ document.getElementById('signinBtn').classList.add('hidden'); document.getElementById('signoutBtn').classList.remove('hidden'); setBadge('Signed in', 'ok'); await loadFromCloud(); } else { document.getElementById('signinBtn').classList.remove('hidden'); document.getElementById('signoutBtn').classList.add('hidden'); setBadge('Offline', 'off'); updateLastBackup(null); } }); }

    (function initFirebase(){ if(!window.firebase) return; if(!configLooksFilled()){ setBadge('Offline (add Firebase config)', 'off'); return; } try{ firebase.initializeApp(firebaseConfig); auth = firebase.auth(); db = firebase.firestore(); db.enablePersistence().catch(()=>{}); cloudReady = true; setBadge('Ready (not signed in)', 'warn'); setupAuth(); } catch(err){ console.warn('Firebase init failed', err); setBadge('Cloud off', 'off'); } })();
  </script>
</body>
</html>
