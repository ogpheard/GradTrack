<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Grad Tracker ‚Äî Auth Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;padding:24px;line-height:1.4;background:#0b1020;color:#e9edf1}
    .card{max-width:720px;margin:0 auto;background:#111936;border:1px solid #1e2848;border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    h1{margin:0 0 6px;font-size:24px}
    .muted{color:#9fb0c9}
    button{background:#4c82fb;border:none;color:white;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin:16px 0}
    .ok{color:#6ee7a3}
    .warn{color:#f9c97a}
    pre{white-space:pre-wrap;background:#0d1328;border:1px solid #1d2750;border-radius:10px;padding:12px;color:#cfe3ff;max-height:320px;overflow:auto}
    code{color:#cfe3ff}
    .box{background:#0d1328;border:1px solid #1d2750;border-radius:10px;padding:12px}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:6px 12px}
    .kv b{color:#cfe3ff}
  </style>
</head>
<body>
  <div class="card">
    <h1>Grad Tracker ‚Äî Auth Test</h1>
    <p class="muted">If the Google button works, you‚Äôll see your session + profile below.</p>

    <div id="authed" class="box" style="display:none">
      <div class="kv">
        <b>Status</b><span class="ok">Signed in ‚úÖ</span>
        <b>Email</b><span id="email">‚Äî</span>
        <b>User ID</b><span id="uid">‚Äî</span>
        <b>Provider</b><span id="provider">‚Äî</span>
      </div>
      <div class="row">
        <button id="signOutBtn">Sign out</button>
        <button id="goAppBtn" title="Continue to your app UI">Go to App</button>
      </div>
    </div>

    <div id="anon" class="box" style="display:none">
      <div class="kv">
        <b>Status</b><span class="warn">Signed out</span>
        <b>What to do</b><span>Click the button to start Google sign-in.</span>
      </div>
      <div class="row">
        <button id="googleBtn">Sign in with Google</button>
      </div>
    </div>

    <h3>Debug</h3>
    <pre id="debug">loading‚Ä¶</pre>
  </div>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // üîß Your Supabase project details
    const SUPABASE_URL = "https://kudqgnpkznshcyvrwrpj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt1ZHFnbnBrem5zaGN5dnJ3cnBqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5NzY0MDcsImV4cCI6MjA3MjU1MjQwN30.mPK21uGKyBtgvWL0vl80l9bLG9SWoXDbnYAjPbPNn74";

    const debugEl = document.getElementById("debug");
    const btnGoogle = document.getElementById("googleBtn");
    const btnSignOut = document.getElementById("signOutBtn");
    const btnGoApp = document.getElementById("goAppBtn");
    const viewAnon = document.getElementById("anon");
    const viewAuthed = document.getElementById("authed");

    const emailEl = document.getElementById("email");
    const uidEl = document.getElementById("uid");
    const providerEl = document.getElementById("provider");

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        autoRefreshToken: true,
        persistSession: true,
        detectSessionInUrl: true, // important: parse #access_token or ?code on this page
      }
    });

    function log(...args){ debugEl.textContent += args.join(" ") + "\n"; }
    function resetLog(){ debugEl.textContent = ""; }

    function pageOrigin(){ return window.location.origin; }
    function appReturnUrl(){ return pageOrigin() + "/grad-tracker/"; }

    function showSession(session){
      if (session && session.user) {
        viewAuthed.style.display = "";
        viewAnon.style.display = "none";
        const u = session.user;
        emailEl.textContent = u.email || "(no email)";
        uidEl.textContent = u.id || "(no id)";
        providerEl.textContent = (u.app_metadata && u.app_metadata.provider) || "unknown";
      } else {
        viewAuthed.style.display = "none";
        viewAnon.style.display = "";
      }
    }

    async function boot(){
      resetLog();
      log("[boot] origin:", pageOrigin());
      log("[boot] path:", window.location.pathname);
      log("[boot] hash:", window.location.hash);

      // Listen for auth changes to update UI live
      supabase.auth.onAuthStateChange((event, session) => {
        log("[onAuthStateChange]", event, "session?", !!session);
        showSession(session);
      });

      // Get current (persisted) session after possible redirect
      const { data: { session }, error } = await supabase.auth.getSession();
      if (error) log("[getSession:error]", error.message);
      log("[getSession] session?", !!session);
      showSession(session);

      // Optional: clean up noisy hash once session exists
      if (session && window.location.hash) {
        history.replaceState({}, "", appReturnUrl());
        log("[hash] cleaned, now:", window.location.href);
      }
    }

    // üîò Sign in
    async function handleGoogle(){
      btnGoogle.disabled = true;
      log("[signIn] redirectTo:", appReturnUrl());
      const { error } = await supabase.auth.signInWithOAuth({
        provider: "google",
        options: {
          redirectTo: appReturnUrl(),
          // scopes: "email profile" // default is fine
        }
      });
      if (error) {
        log("[signIn:error]", error.message);
        btnGoogle.disabled = false;
      } else {
        // A full-page redirect will occur; no further code runs here
        log("[signIn] redirecting‚Ä¶");
      }
    }

    // üö™ Sign out
    async function handleSignOut(){
      btnSignOut.disabled = true;
      const { error } = await supabase.auth.signOut();
      if (error) log("[signOut:error]", error.message);
      btnSignOut.disabled = false;
    }

    // üéØ Wire events
    btnGoogle?.addEventListener("click", handleGoogle);
    btnSignOut?.addEventListener("click", handleSignOut);
    btnGoApp?.addEventListener("click", () => {
      // ‚§¥Ô∏è swap this to your real app page once auth test works
      window.location.href = appReturnUrl();
    });

    // üöÄ Start
    boot();
  </script>
</body>
</html>
