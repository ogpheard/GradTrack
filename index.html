<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grad Tracker — Job Applications</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background:#0d0f12; color:#eaeef3; }
    header { padding: 16px 20px; border-bottom: 1px solid #1f2937; background:#0f1115; position: sticky; top:0; z-index:1; }
    main { max-width: 1100px; margin: 0 auto; padding: 20px; }
    h1 { margin: 0; font-size: 20px; }

    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .card { background:#0f1115; border:1px solid #1f2937; border-radius: 10px; padding: 16px; margin: 16px 0; }
    .muted { color:#9aa4b2; }

    .btn { background:#2563eb; border:none; color:white; padding:10px 14px; border-radius:8px; cursor:pointer; }
    .btn:disabled { opacity: .6; cursor:not-allowed; }
    .btn.secondary { background:#334155; }
    .btn.danger { background:#b91c1c; }

    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:12px; }
    .field { display:flex; flex-direction:column; gap:6px; }
    label { font-size: 12px; color:#b7c1cc; }
    input, select, textarea { background:#0b0d11; color:#eaeef3; border:1px solid #263244; border-radius:8px; padding:10px; width:100%; }
    textarea { min-height: 70px; }

    .controls { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .grow { flex: 1 1 260px; }

    table { width:100%; border-collapse: collapse; }
    th, td { padding:10px; border-bottom:1px solid #1f2937; text-align:left; white-space:nowrap; }
    th { font-weight:600; font-size:13px; color:#c9d3df; }
    tr:hover { background:#11141a; }
    a { color:#7aa2ff; text-decoration:none; }

    .msg { margin-top:10px; padding:10px; border-radius:8px; font-size: 14px; }
    .msg.error { background:#311518; border:1px solid #7f1d1d; color:#fecaca; }
    .msg.ok { background:#0e2216; border:1px solid #166534; color:#bbf7d0; }

    dialog { border:none; border-radius:12px; max-width: 900px; width: min(900px, 92vw); background:#0f1115; color:#eaeef3; }
    dialog::backdrop { background: rgba(0,0,0,.6); }
    .dialog-head { display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom: 8px; }
  </style>
</head>
<body>
  <header>
    <div class="row">
      <h1>Grad Tracker — Job Applications</h1>
      <span class="muted">No login • Direct Supabase CRUD</span>
    </div>
  </header>
  <main>
    <div class="card">
      <div class="controls">
        <input id="search" class="grow" placeholder="Search title/company/keywords…" />
        <select id="statusFilter">
          <option value="">All status</option>
          <option>Saved</option>
          <option>Applied</option>
          <option>Interview</option>
          <option>Offer</option>
          <option>Rejected</option>
          <option>Withdrawn</option>
        </select>
        <button id="refreshBtn" class="btn secondary">Refresh</button>
        <button id="openAddBtn" class="btn">Add application</button>
      </div>
      <div id="topMsg"></div>
    </div>

    <div class="card">
      <div style="overflow:auto;">
        <table id="tbl">
          <thead>
            <tr>
              <th>Title</th>
              <th>Company</th>
              <th>Status</th>
              <th>Applied</th>
              <th>Created</th>
              <th>URL</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div id="empty" class="muted" style="padding: 14px; display:none;">No applications yet.</div>
    </div>
  </main>

  <!-- Add/Edit dialog -->
  <dialog id="editDlg">
    <form method="dialog" id="editForm">
      <div class="dialog-head">
        <h3 id="dlgTitle" style="margin:0;">Add application</h3>
        <div class="row">
          <button type="button" id="saveBtn" class="btn">Save</button>
          <button type="button" id="closeBtn" class="btn secondary">Close</button>
        </div>
      </div>
      <div id="dlgMsg"></div>
      <div id="formFields" class="grid"></div>
    </form>
  </dialog>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
  // ========= 1) Configure Supabase (no-auth) =========
  const SUPABASE_URL = 'https://bmudgeqzuhdjowcibwyx.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJtdWRnZXF6dWhkam93Y2lid3l4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MzExODUsImV4cCI6MjA3MzAwNzE4NX0.sGQ0YfX_TBKHVtrMSE77kifuXnRBdRjhaIcGZQpDLLc';
  const TABLE = 'graduate_job_helper';

  // IMPORTANT: In Supabase SQL, either disable RLS on this table, or add wide-open policies for the anon role
  // so this page can select/insert/update/delete without login.

  const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession:false, autoRefreshToken:false, detectSessionInUrl:false }
  });

  // ========= 2) Fields definition =========
  // List of possible fields taken from your CSV. We'll auto-hide any that don't exist in your table.
  const ALL_FIELDS = [
    // Core
    f('title', 'Title', 'text', { required:true }),
    f('company_name', 'Company', 'text', { required:true }),
    f('status', 'Status', 'select', { options:['Saved','Applied','Interview','Offer','Rejected','Withdrawn'] }),
    f('canonical_job_url', 'Job URL', 'url'),
    f('source_url', 'Source URL', 'url'),

    // Meta
    f('seniority', 'Seniority', 'text'),
    f('role_type', 'Role Type', 'text'),
    f('sector', 'Sector', 'text'),
    f('contact_email', 'Contact Email', 'email'),

    // Dates (use YYYY-MM-DD)
    f('date_posted', 'Date Posted', 'date'),
    f('date_deadline', 'Deadline', 'date'),
    f('start_date', 'Start Date', 'date'),
    f('applied_date', 'Applied Date', 'date'),

    // Salary
    f('salary_min', 'Salary Min', 'number', { step:'0.01' }),
    f('salary_max', 'Salary Max', 'number', { step:'0.01' }),
    f('salary_currency', 'Currency', 'text'),
    f('salary_period', 'Salary Period', 'text'),
    f('salary_raw', 'Salary Raw', 'text'),

    // Location
    f('locations', 'Locations', 'text'),

    // Ratings
    f('application_effort_rating', 'Application Effort (1-5)', 'number', { min:1, max:5, step:'1' }),
    f('application_chance_rating', 'Application Chance (1-5)', 'number', { min:1, max:5, step:'1' }),

    // Content
    f('job_description', 'Job Description', 'textarea'),
    f('key_requirements', 'Key Requirements', 'textarea'),
    f('other_requirements', 'Other Requirements', 'textarea'),
    f('fits', 'Fits', 'textarea'),
    f('gaps', 'Gaps', 'textarea'),
    f('job_summary', 'Summary', 'textarea'),
    f('keywords', 'Keywords', 'text'),

    // Optional AI fields (if present in your table)
    f('AI_fit_score', 'AI Fit Score', 'number', { step:'0.01' }),
    f('AI_alignment_score', 'AI Alignment Score', 'number', { step:'0.01' }),
    f('AI_cv_filename', 'AI CV Filename', 'text'),
    f('AI_cv_reason', 'AI CV Reason', 'textarea'),

    // Links
    f('cover_letter_url', 'Cover Letter URL', 'url'),
  ];

  function f(name, label, type, extra={}) { return { name, label, type, ...extra }; }

  let AVAILABLE_FIELDS = []; // subset of ALL_FIELDS that really exist in your table

  // ========= 3) State =========
  let rows = []; // current table rows
  let filter = { q:'', status:'' };
  let editingId = null; // application_id of row being edited (or null for new)

  // ========= 4) DOM helpers =========
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));
  function setMsg(elId, text, kind='error') {
    const el = document.getElementById(elId);
    if (!text) { el.innerHTML = ''; return; }
    el.innerHTML = `<div class="msg ${kind==='ok'?'ok':'error'}">${text}</div>`;
  }

  // ========= 5) Detect columns available in your table =========
  async function detectAvailableFields() {
    // Grab one row to see actual column names
    const { data, error } = await db.from(TABLE).select('*').limit(1);
    if (error) throw error;
    let names;
    if (data && data.length) {
      names = Object.keys(data[0]);
    } else {
      // If table is empty, assume all fields exist (you can tweak below if needed)
      names = ALL_FIELDS.map(x => x.name).concat(['application_id','created_at','status_update_date']);
    }
    AVAILABLE_FIELDS = ALL_FIELDS.filter(x => names.includes(x.name));
  }

  // ========= 6) Render dynamic form =========
  function renderFormFields(containerId, values={}) {
    const box = document.getElementById(containerId);
    box.innerHTML = '';

    for (const fld of AVAILABLE_FIELDS) {
      const id = `fld_${fld.name}`;
      const wrap = document.createElement('div');
      wrap.className = 'field';

      const label = document.createElement('label');
      label.setAttribute('for', id);
      label.textContent = fld.label;

      let input;
      if (fld.type === 'textarea') {
        input = document.createElement('textarea');
      } else if (fld.type === 'select') {
        input = document.createElement('select');
        (fld.options||[]).forEach(opt => {
          const o = document.createElement('option');
          o.value = opt; o.textContent = opt; input.appendChild(o);
        });
      } else {
        input = document.createElement('input');
        input.type = fld.type || 'text';
        if (fld.step) input.step = fld.step;
        if (fld.min != null) input.min = fld.min;
        if (fld.max != null) input.max = fld.max;
      }
      input.id = id;
      input.name = fld.name;
      if (fld.required) input.required = true;

      const v = values[fld.name];
      if (v != null) {
        if (fld.type === 'textarea') input.value = v ?? '';
        else input.value = v ?? '';
      }

      wrap.appendChild(label);
      wrap.appendChild(input);
      box.appendChild(wrap);
    }
  }

  function readFormValues() {
    const out = {};
    for (const fld of AVAILABLE_FIELDS) {
      const el = document.getElementById(`fld_${fld.name}`);
      if (!el) continue;
      let v = el.value;
      if (v === '') v = null;
      // Dates: keep YYYY-MM-DD as-is (works for DATE/TIMESTAMPTZ in Supabase)
      // Numbers: cast to number if not null
      if (v != null && (fld.type === 'number')) v = Number(v);
      out[fld.name] = v;
    }
    return out;
  }

  // ========= 7) CRUD =========
  async function loadRows() {
    const { data, error } = await db
      .from(TABLE)
      .select('*')
      .order('created_at', { ascending:false })
      .limit(500);
    if (error) throw error;
    rows = data || [];
    renderTable();
  }

  async function addRow(payload) {
    const row = {
      // application_id: use uuid if exists, else a timestamp fallback
      application_id: (crypto?.randomUUID && crypto.randomUUID()) || String(Date.now()),
      ...payload,
    };
    // If status provided, update status_update_date
    if (row.status) row.status_update_date = new Date().toISOString();

    const { data, error } = await db.from(TABLE).insert([row]).select('*').single();
    if (error) throw error;
    rows.unshift(data);
    renderTable();
  }

  async function updateRow(id, payload) {
    if (payload.status) payload.status_update_date = new Date().toISOString();
    const { data, error } = await db
      .from(TABLE)
      .update(payload)
      .eq('application_id', id)
      .select('*')
      .single();
    if (error) throw error;
    const idx = rows.findIndex(r => r.application_id === id);
    if (idx !== -1) rows[idx] = data; else rows.unshift(data);
    renderTable();
  }

  async function deleteRow(id) {
    const { error } = await db.from(TABLE).delete().eq('application_id', id);
    if (error) throw error;
    rows = rows.filter(r => r.application_id !== id);
    renderTable();
  }

  // ========= 8) Table rendering & filtering =========
  function renderTable() {
    const q = filter.q.trim().toLowerCase();
    const st = filter.status;
    const list = rows.filter(r => {
      const hay = [r.title, r.company_name, r.keywords, r.sector, r.role_type].map(x => (x||'').toLowerCase()).join(' ');
      const okQ = !q || hay.includes(q);
      const okS = !st || r.status === st;
      return okQ && okS;
    });

    const tbody = document.getElementById('tbody');
    const empty = document.getElementById('empty');

    if (!list.length) {
      tbody.innerHTML = '';
      empty.style.display = 'block';
      return;
    }
    empty.style.display = 'none';

    tbody.innerHTML = list.map(r => {
      const applied = r.applied_date ? fmtDate(r.applied_date) : '-';
      const created = r.created_at ? fmtDate(r.created_at) : '-';
      const urlHtml = r.canonical_job_url ? aUrl(r.canonical_job_url) : '-';
      return `<tr>
        <td>${esc(r.title)}</td>
        <td>${esc(r.company_name)}</td>
        <td>${esc(r.status || '')}</td>
        <td>${applied}</td>
        <td>${created}</td>
        <td>${urlHtml}</td>
        <td>
          <button class="btn secondary" data-act="edit" data-id="${r.application_id}">Edit</button>
          <button class="btn danger" data-act="del" data-id="${r.application_id}">Delete</button>
        </td>
      </tr>`;
    }).join('');
  }

  function esc(s){ return (s==null?'':String(s)).replace(/[&<>]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c])); }
  function fmtDate(d){ const dt = new Date(d); if (isNaN(+dt)) return String(d); return dt.toLocaleDateString(); }
  function aUrl(href){ try { const u = new URL(href); return `<a href="${u.href}" target="_blank" rel="noopener">${u.hostname}</a>`; } catch { return `<a href="${href}" target="_blank" rel="noopener">${href}</a>`; } }

  // ========= 9) Dialog (Add/Edit) =========
  function openDialog(mode, row=null){
    const dlg = document.getElementById('editDlg');
    const title = document.getElementById('dlgTitle');
    setMsg('dlgMsg', '');
    if (mode==='add') {
      title.textContent = 'Add application';
      editingId = null;
      renderFormFields('formFields', {});
    } else {
      title.textContent = 'Edit application';
      editingId = row.application_id;
      const vals = {}; AVAILABLE_FIELDS.forEach(f => vals[f.name] = row[f.name] ?? null);
      renderFormFields('formFields', vals);
    }
    if (!dlg.open) dlg.showModal();
  }

  async function saveDialog(){
    const payload = readFormValues();
    // Filter to only fields we detected (avoid unknown-column errors)
    const clean = {}; AVAILABLE_FIELDS.forEach(f => { clean[f.name] = payload[f.name]; });

    try {
      document.getElementById('saveBtn').disabled = true;
      setMsg('dlgMsg', '', 'ok');
      if (editingId) await updateRow(editingId, clean); else await addRow(clean);
      setMsg('topMsg', editingId ? 'Updated!' : 'Added!', 'ok');
      document.getElementById('editDlg').close();
    } catch (err) {
      setMsg('dlgMsg', err.message || String(err), 'error');
    } finally {
      document.getElementById('saveBtn').disabled = false;
    }
  }

  // ========= 10) Wire up =========
  async function init(){
    try {
      await detectAvailableFields();
      await loadRows();
    } catch (err){
      setMsg('topMsg', 'Failed to load: ' + (err.message||err), 'error');
    }

    document.getElementById('search').addEventListener('input', (e)=>{ filter.q = e.target.value; renderTable(); });
    document.getElementById('statusFilter').addEventListener('change', (e)=>{ filter.status = e.target.value; renderTable(); });
    document.getElementById('refreshBtn').addEventListener('click', async ()=>{ setMsg('topMsg',''); await loadRows(); });

    document.getElementById('openAddBtn').addEventListener('click', ()=> openDialog('add'));
    document.getElementById('closeBtn').addEventListener('click', ()=> document.getElementById('editDlg').close());
    document.getElementById('saveBtn').addEventListener('click', saveDialog);

    // Row actions (event delegation)
    document.getElementById('tbody').addEventListener('click', async (e)=>{
      const btn = e.target.closest('button');
      if (!btn) return;
      const id = btn.getAttribute('data-id');
      const act = btn.getAttribute('data-act');
      const row = rows.find(r => r.application_id === id);
      if (act === 'edit') {
        openDialog('edit', row);
      } else if (act === 'del') {
        if (confirm('Delete this application?')){
          try { await deleteRow(id); setMsg('topMsg', 'Deleted.', 'ok'); }
          catch(err){ setMsg('topMsg', err.message||String(err), 'error'); }
        }
      }
    });
  }

  init();
  </script>
</body>
</html>
