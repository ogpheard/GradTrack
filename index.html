<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Grad Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
  <button id="login">Sign in with Google</button>
  <button id="logout" style="display:none">Sign out</button>

  <div id="me"></div>

  <h3>Add job</h3>
  <input id="title" placeholder="Title" />
  <input id="company" placeholder="Company" />
  <input id="url" placeholder="Job URL" />
  <select id="status">
    <option>Applied</option>
    <option>Online Assessment</option>
    <option>Rejected</option>
  </select>
  <button id="add">Add</button>

  <h3>Your jobs</h3>
  <ul id="list"></ul>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ✅ Your actual Supabase project URL:
    const SUPABASE_URL = 'https://kudqgnpkznshcyvrwrpj.supabase.co';
    // ✅ Paste the anon public key from Settings → API → Project API keys
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt1ZHFnbnBrem5zaGN5dnJ3cnBqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5NzY0MDcsImV4cCI6MjA3MjU1MjQwN30.mPK21uGKyBtgvWL0vl80l9bLG9SWoXDbnYAjPbPNn74';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const loginBtn = document.getElementById('login');
    const logoutBtn = document.getElementById('logout');
    const meDiv = document.getElementById('me');
    const list = document.getElementById('list');

    const titleEl = document.getElementById('title');
    const companyEl = document.getElementById('company');
    const urlEl = document.getElementById('url');
    const statusEl = document.getElementById('status');

    // Use a clean redirect URL that matches what you allowed in Supabase
    const REDIRECT_BACK = 'https://ogpheard.github.io/grad-tracker/';

    async function refresh() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        meDiv.textContent = 'Not signed in';
        loginBtn.style.display = '';
        logoutBtn.style.display = 'none';
        list.innerHTML = '';
        return;
      }
      meDiv.textContent = `Signed in as ${user.email}`;
      loginBtn.style.display = 'none';
      logoutBtn.style.display = '';

      const { data, error } = await supabase
        .from('"Graduate Job Helper"') // table name has spaces → keep quoted
        .select('application_id,title,company_name,status,canonical_job_url,status_update_date')
        .order('status_update_date', { ascending: false });

      if (error) {
        list.innerHTML = `<li>Error: ${error.message}</li>`;
        return;
      }
      list.innerHTML = (data || []).map(r => `
        <li>
          <strong>${r.title || '(no title)'}</strong> @ ${r.company_name || '-'}
          — ${r.status || '-'}
          ${r.canonical_job_url ? ` | <a href="${r.canonical_job_url}" target="_blank">link</a>` : ''}
        </li>
      `).join('');
    }

    loginBtn.onclick = async () => {
      const { error } = await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: { redirectTo: REDIRECT_BACK }
      });
      if (error) alert(error.message);
    };

    logoutBtn.onclick = async () => {
      await supabase.auth.signOut();
      await refresh();
    };

    document.getElementById('add').onclick = async () => {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return alert('Sign in first');

      const row = {
        user_id: user.id, // required by your RLS policy
        title: titleEl.value || null,
        company_name: companyEl.value || null,
        canonical_job_url: urlEl.value || null,
        status: statusEl.value || 'Applied',
        status_update_date: new Date().toISOString().slice(0,10)
      };

      const { error } = await supabase.from('"Graduate Job Helper"').insert(row);
      if (error) return alert(error.message);

      titleEl.value = companyEl.value = urlEl.value = '';
      statusEl.value = 'Applied';
      await refresh();
    };

    supabase.auth.onAuthStateChange(refresh);
    refresh();
  </script>
</body>
</html>
