<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Graduate Applications Assistant</title>
<style>
  :root{
    --bg:#0f1221; --panel:#151933; --muted:#8b91b0; --text:#e8ebff; --accent:#7aa2ff; --good:#21c07a; --warn:#ffb020; --bad:#ff5c7a; --chip:#1c2142;
    --shadow:0 6px 24px rgba(0,0,0,.25);
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:960px;margin:32px auto;padding:0 16px}
  .card{background:var(--panel);border-radius:16px;box-shadow:var(--shadow);padding:20px}
  h1{font-size:24px;margin:0 0 12px}
  h2{font-size:18px;margin:16px 0 8px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .urlbar{display:flex;gap:8px;width:100%}
  input[type="url"]{flex:1;padding:14px 12px;border-radius:12px;border:1px solid #2b3160;background:#0e1330;color:var(--text)}
  button{border:0;border-radius:12px;padding:12px 16px;cursor:pointer;font-weight:600;background:#2a3170;color:#fff}
  button.primary{background:var(--accent)}
  button.ghost{background:transparent;border:1px solid #2b3160}
  button.good{background:var(--good)}
  button.warn{background:var(--warn);color:#1d1d1d}
  button.bad{background:var(--bad)}
  button:disabled{opacity:.6;cursor:not-allowed}
  .muted{color:var(--muted);font-size:13px}
  .kvs{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin:12px 0}
  .kv{background:#0e1330;border:1px solid #262d59;border-radius:12px;padding:10px}
  .kv b{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
  .meters{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:12px 0}
  .meter{background:#0e1330;border:1px solid #262d59;border-radius:12px;padding:10px}
  .meter .bar{height:10px;background:#1b2147;border-radius:8px;overflow:hidden;margin-top:8px}
  .meter .fill{height:100%;background:linear-gradient(90deg,var(--good),var(--accent));width:0%}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{background:var(--chip);border:1px solid #2b3160;color:#cfd6ff;padding:6px 10px;border-radius:999px;font-size:12px}
  .cols{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .details{margin-top:12px}
  .details pre{white-space:pre-wrap;word-break:break-word;background:#0e1330;border:1px solid #262d59;border-radius:12px;padding:12px;color:#cfe0ff;max-height:360px;overflow:auto}
  .decisions{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
  .toast{position:fixed;right:16px;bottom:16px;background:#111635;border:1px solid #27306a;color:#e8ebff;padding:12px 14px;border-radius:12px;box-shadow:var(--shadow);opacity:0;transform:translateY(6px);transition:.25s}
  .toast.show{opacity:1;transform:translateY(0)}
  .small{font-size:12px}
  .env{margin-left:auto;display:flex;gap:8px;align-items:center}
  .env select{background:#0e1330;border:1px solid #2b3160;color:#fff;border-radius:10px;padding:8px}
  .result-block{margin-top:16px;border-top:1px solid #262d59;padding-top:12px}
  .btn-row{display:flex;gap:8px;flex-wrap:wrap}
  .subtle{opacity:.9}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="row">
      <h1>Graduate Applications Assistant</h1>
      <div class="env">
        <label class="small muted">Environment</label>
        <select id="envSelect" title="Switch between Test and Prod">
          <option value="test">Test</option>
          <option value="prod">Prod</option>
        </select>
      </div>
    </div>
    <div class="urlbar">
      <input id="jobUrl" type="url" placeholder="Paste a job URLâ€¦" autocomplete="off" />
      <button id="analyseBtn" class="primary">Analyse</button>
    </div>
    <p class="muted small">Test uses <code>/webhook-test/*</code> (workflows Executing). Prod uses <code>/webhook/*</code> (workflows Active).</p>
  </div>

  <div id="result" class="card" style="margin-top:16px; display:none;"></div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
  // ========= YOUR ENDPOINTS =========
  const URLS = {
    test: {
      analyse:      'https://ogpheard.app.n8n.cloud/webhook-test/analyse',
      applications: 'https://ogpheard.app.n8n.cloud/webhook-test/applications',
      cover:        'https://ogpheard.app.n8n.cloud/webhook-test/cover'
    },
    prod: {
      analyse:      'https://ogpheard.app.n8n.cloud/webhook/analyse',
      applications: 'https://ogpheard.app.n8n.cloud/webhook/applications',
      cover:        'https://ogpheard.app.n8n.cloud/webhook/cover'
    }
  };

  // Optional: pass Drive IDs to n8n (or hardcode them in n8n)
  const CV_FOLDER_ID = '';   // e.g. '19L6t0a-NEvCrJmJqkJs3MQTq20VZ45fu'
  const GUIDE_DOC_ID = '';   // e.g. '1CtPPxz6b6VP8tcBlXIR6ZiNDroHsST2kDGZuIIvnuIE'

  // ====== UI refs / state ======
  const envSelect = document.getElementById('envSelect');
  const analyseBtn = document.getElementById('analyseBtn');
  const jobUrlInput = document.getElementById('jobUrl');
  const resultEl = document.getElementById('result');
  const toastEl = document.getElementById('toast');

  const initialEnv = (new URLSearchParams(location.search).get('env') || 'test').toLowerCase();
  envSelect.value = (initialEnv === 'prod' ? 'prod' : 'test');
  let currentEnv = envSelect.value;
  envSelect.addEventListener('change', () => { currentEnv = envSelect.value; toast(`Switched to ${currentEnv.toUpperCase()}`); });

  let draft = null;     // last analysis result
  let lastCover = null; // last cover result

  // ====== helpers ======
  function toast(msg) {
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    setTimeout(() => toastEl.classList.remove('show'), 2000);
  }
  function londonTodayISO() {
    const fmt = new Intl.DateTimeFormat('en-GB', { timeZone: 'Europe/London', year: 'numeric', month: '2-digit', day: '2-digit' }).formatToParts(new Date());
    const y = fmt.find(p => p.type === 'year').value, m = fmt.find(p => p.type === 'month').value, d = fmt.find(p => p.type === 'day').value;
    return `${y}-${m}-${d}`;
  }
  function escapeHtml(s){return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
  function nl2pre(s){return `<pre>${escapeHtml(String(s||'')).replace(/\n{3,}/g,'\n\n')}</pre>`;}
  function lines(list){if(!Array.isArray(list))return'';return list.slice(0,24).map(x=>`â€¢ ${escapeHtml(String(x))}`).join('\n');}
  function badgeList(list){if(!Array.isArray(list))return'';return `<div class="chips">${list.slice(0,30).map(k=>`<span class="chip">${escapeHtml(k)}</span>`).join('')}</div>`;}
  function salaryText(a){const s=a.salary||{};if(s.salary_raw)return s.salary_raw;if(s.min&&s.max)return `${s.currency||''} ${s.min}â€“${s.max} ${s.period||''}`.trim();if(s.min)return `${s.currency||''} ${s.min} ${s.period||''}`.trim();return a.salary_raw||'';}
  async function postForm(url, fd){
    const res = await fetch(url,{method:'POST',body:fd});
    if(!res.ok){const t = await res.text().catch(()=> ''); console.error('POST failed', url, res.status, t); throw new Error(`HTTP ${res.status}`);}
    try { return await res.json(); } catch { return {}; }
  }
  function canonicalize(u){
    try{const url=new URL(String(u));url.protocol='https:';url.hostname=url.hostname.replace(/^www\./i,'').toLowerCase();url.hash='';const keep=new Set(['gh_jid','jobid','vacancyid','rid','id','lever-origin']);const q=new URLSearchParams(url.search);[...q.keys()].forEach(k=>{const kl=k.toLowerCase();if(!keep.has(kl)||/^utm_/.test(kl)||/(gclid|fbclid|ref|source|src|campaign|medium)$/i.test(kl))q.delete(k);});const sorted=new URLSearchParams();[...q.keys()].sort().forEach(k=>sorted.append(k,q.get(k)));url.search=sorted.toString()?`?${sorted.toString()}`:'';if(url.pathname.length>1)url.pathname=url.pathname.replace(/\/+$/,'');return url.toString();}catch{return u;}
  }

  // ====== ANALYSE ======
  async function analyseUrl(){
    const url = jobUrlInput.value.trim();
    if(!/^https?:\/\//i.test(url)){ toast('Please paste a valid URL'); return; }

    resultEl.style.display='block';
    resultEl.innerHTML = `
      <div style="height:14px;width:60%" class="skeleton"></div>
      <div style="height:14px;width:40%;margin-top:8px" class="skeleton"></div>
      <div style="height:64px;width:90%;margin-top:16px" class="skeleton"></div>`;
    analyseBtn.disabled = true;

    try{
      const fd = new FormData();
      fd.append('job_url', url);
      const data = await postForm(URLS[currentEnv].analyse, fd);
      const out = Array.isArray(data) ? data[0] : data;
      if(!out) throw new Error('No analysis result');
      draft = out; lastCover = null;
      renderAnalysis(out);
    }catch(e){
      console.error(e);
      resultEl.style.display='none';
      toast(`Analysis failed (${currentEnv}). Check CORS & workflow status.`);
    }finally{
      analyseBtn.disabled = false;
    }
  }

  // ====== RENDER RESULT ======
  function renderAnalysis(a){
    const fit = Math.max(0, Math.min(100, Number(a.AI_fit_score||0)));
    const align = Math.max(0, Math.min(100, Number(a.AI_alignment_score||0)));
    const locs = Array.isArray(a.locations) ? a.locations.join(' â€¢ ') : '';
    const sal  = salaryText(a);
    const deadline = a.date_deadline ? `Deadline: ${a.date_deadline}` : '';
    const start    = a.start_date    ? `Start: ${a.start_date}`       : '';

    const header = `
      <h2>${escapeHtml(a.title||'Untitled role')}</h2>
      <div class="muted">${escapeHtml(a.company_name||'')}</div>
      <div class="kvs">
        <div class="kv"><b>Locations</b>${escapeHtml(locs||'â€”')}</div>
        <div class="kv"><b>Salary</b>${escapeHtml(sal||'â€”')}</div>
        <div class="kv"><b>Dates</b>${escapeHtml([start,deadline].filter(Boolean).join(' Â· ')||'â€”')}</div>
        <div class="kv"><b>URL</b><a href="${a.source_url}" target="_blank" rel="noopener">${escapeHtml(a.source_url||'')}</a></div>
      </div>`;

    const meters = `
      <div class="meters">
        <div class="meter">
          <div class="row"><strong>AI Fit</strong><span class="muted" style="margin-left:auto">${fit}%</span></div>
          <div class="bar"><div class="fill" style="width:${fit}%"></div></div>
        </div>
        <div class="meter">
          <div class="row"><strong>Alignment</strong><span class="muted" style="margin-left:auto">${align}%</span></div>
          <div class="bar"><div class="fill" style="width:${align}%"></div></div>
        </div>
      </div>`;

    const keywords = `<h2>Keywords</h2>${badgeList(a.keywords)}`;
    const lists = `
      <div class="cols">
        <div>
          <h2>Fits</h2>${nl2pre(lines(a.fits))}
        </div>
        <div>
          <h2>Gaps</h2>${nl2pre(lines(a.gaps))}
        </div>
      </div>`;

    const summary = `<h2>Summary</h2><div class="kv" style="margin-top:8px">${escapeHtml(a.job_summary||'')}</div>`;

    const actions = `
      <div class="decisions">
        <div class="btn-row">
          <button id="saveBtn" class="primary">Save for later</button>
          <div class="inline">
            <button id="applyBtn" class="good">Yes I applied</button>
            <div id="ratings" class="rating" style="display:none">
              <label class="small">Effort/10 <input id="effort" type="number" min="0" max="10" step="1" value="7" /></label>
              <label class="small">Chance/10 <input id="chance" type="number" min="0" max="10" step="1" value="6" /></label>
              <button id="confirmApply" class="good">Confirm</button>
            </div>
          </div>
          <button id="coverBtn" class="ghost">Cover letter & CV tweaks</button>
          <button id="ignoreBtn" class="bad">Ignore</button>
        </div>
      </div>`;

    const coverBlock = `
      <div id="coverBlock" class="result-block" style="display:none">
        <h2>Cover letter & CV</h2>
        <div id="coverStatus" class="muted subtle">Preparingâ€¦</div>
        <div id="coverResult" style="display:none">
          <div class="kvs">
            <div class="kv"><b>Selected CV</b><span id="cvName">â€”</span></div>
            <div class="kv"><b>Why this CV</b><span id="cvWhy">â€”</span></div>
            <div class="kv"><b>Cover Letter Doc</b><span id="coverDocLink">â€”</span></div>
          </div>
          <div class="section">
            <h2>CV tweak suggestions</h2>
            <div id="cvTweaks"></div>
          </div>
          <div class="section">
            <h2>Cover letter (preview)</h2>
            <div id="coverPreview"></div>
            <div class="btn-row" style="margin-top:8px">
              <button id="copyCover" class="ghost">Copy text</button>
              <button id="openDoc" class="primary" style="display:none">Open Google Doc</button>
            </div>
          </div>
        </div>
      </div>`;

    const details = `
      <div class="details">
        <button id="toggleMore" class="ghost">View more</button>
        <div id="moreBox" style="display:none;margin-top:12px">
          <h2>Full description</h2>
          ${nl2pre(a.job_description||'')}
        </div>
      </div>`;

    resultEl.innerHTML = header + meters + keywords + lists + summary + actions + coverBlock + details;
    resultEl.style.display='block';

    // handlers
    document.getElementById('toggleMore').addEventListener('click', () => {
      const box = document.getElementById('moreBox');
      const open = box.style.display !== 'none';
      box.style.display = open ? 'none' : 'block';
      document.getElementById('toggleMore').textContent = open ? 'View more' : 'Hide';
    });
    document.getElementById('saveBtn').addEventListener('click', onSave);
    document.getElementById('applyBtn').addEventListener('click', () => {
      document.getElementById('ratings').style.display='inline-flex';
    });
    document.getElementById('confirmApply').addEventListener('click', onApply);
    document.getElementById('ignoreBtn').addEventListener('click', () => {
      resultEl.style.display='none'; draft=null; lastCover=null; toast('Ignored. Nothing saved.');
    });
    document.getElementById('coverBtn').addEventListener('click', onCoverClick);
  }

  // ====== APPLICATIONS send ======
  function toApplicationsPayload(a, opts){
    return {
      source_url: a.source_url || '',
      canonical_job_url: a.canonical_job_url || a.canonical_url || canonicalize(a.source_url || ''),
      title: a.title || '', company_name: a.company_name || '',
      seniority: a.seniority || '', role_type: a.role_type || '', sector: a.sector || '',
      contact_email: a.contact_email || '', date_posted: a.date_posted || '',
      date_deadline: a.date_deadline || '', start_date: a.start_date || '',
      salary_min: a.salary?.min || '', salary_max: a.salary?.max || '',
      salary_currency: a.salary?.currency || '', salary_period: a.salary?.period || '',
      salary_raw: a.salary?.salary_raw || a.salary_raw || '',
      locations: Array.isArray(a.locations)? a.locations : [],
      AI_fit_score: a.AI_fit_score ?? 0, AI_alignment_score: a.AI_alignment_score ?? 0,
      AI_cv_filename: a.AI_cv_recommendation?.filename || a.AI_cv_filename || '',
      AI_cv_reason:   a.AI_cv_recommendation?.reason   || a.AI_cv_reason   || '',
      key_requirements: a.key_requirements || [], other_requirements: a.other_requirements || [],
      fits: a.fits || [], gaps: a.gaps || [], job_summary: a.job_summary || '',
      keywords: a.keywords || [], job_description: a.job_description || '',
      status: opts.status,
      applied_date: opts.status==='Applied' ? (opts.appliedDate || londonTodayISO()) : null,
      application_effort_rating: opts.effort ?? null,
      application_chance_rating: opts.chance ?? null,
      cover_letter_url: a.cover_letter_url ?? null
    };
  }
  async function sendApplications(env, payload){
    const fd = new FormData();
    for(const [k,v] of Object.entries(payload)){
      if(Array.isArray(v)) fd.append(k, JSON.stringify(v));
      else if(v==null)     fd.append(k, '');
      else                 fd.append(k, String(v));
    }
    return postForm(URLS[env].applications, fd);
  }
  async function onSave(){
    if(!draft) return;
    try{
      const payload = toApplicationsPayload(draft, { status:'Saved' });
      await sendApplications(currentEnv, payload);
      toast('Saved for later âœ…');
    }catch(e){ console.error(e); toast(`Save failed (${currentEnv})`); }
  }
  async function onApply(){
    if(!draft) return;
    try{
      const effort = Number(document.getElementById('effort').value);
      const chance = Number(document.getElementById('chance').value);
      const payload = toApplicationsPayload(draft, {
        status:'Applied',
        effort: Number.isFinite(effort)?effort:null,
        chance: Number.isFinite(chance)?chance:null,
        appliedDate: londonTodayISO()
      });
      await sendApplications(currentEnv, payload);
      toast('Marked as applied ðŸŽ‰');
    }catch(e){ console.error(e); toast(`Apply failed (${currentEnv})`); }
  }

  // ====== COVER LETTER & CV TWEAKS ======
  async function onCoverClick(){
    if(!draft) return toast('Analyse a job first');

    const block  = document.getElementById('coverBlock');
    const status = document.getElementById('coverStatus');
    const outBox = document.getElementById('coverResult');
    const coverBtn = document.getElementById('coverBtn');

    block.style.display='block';
    status.textContent='Generating cover letter & CV tipsâ€¦';
    outBox.style.display='none';
    coverBtn.disabled = true;

    try{
      const fd = new FormData();
      // Send the full analysis JSON; your n8n Code node already normalises this.
      fd.append('job_json', JSON.stringify(draft));
      if(CV_FOLDER_ID) fd.append('cv_folder_id', CV_FOLDER_ID);
      if(GUIDE_DOC_ID) fd.append('guide_doc_id', GUIDE_DOC_ID);

      const data = await postForm(URLS[currentEnv].cover, fd);
      lastCover = data || {};

      // Expected from n8n:
      // {
      //   selected_cv: { filename, reason, doc_id?, doc_url? },
      //   cv_tweaks: [ "...", ... ],
      //   cover_letter: { plain_text, html?, doc_url?, doc_id? }
      // }

      const cv     = lastCover.selected_cv || {};
      const tweaks = Array.isArray(lastCover.cv_tweaks) ? lastCover.cv_tweaks : [];
      const letter = lastCover.cover_letter || {};

      document.getElementById('cvName').textContent = cv.filename || 'â€”';
      document.getElementById('cvWhy').textContent  = cv.reason   || 'â€”';

      const link = letter.doc_url || cv.doc_url || '';
      document.getElementById('coverDocLink').innerHTML = link
        ? `<a target="_blank" rel="noopener" href="${escapeHtml(link)}">${escapeHtml(link)}</a>`
        : 'â€”';

      document.getElementById('cvTweaks').innerHTML =
        tweaks.length ? nl2pre(lines(tweaks)) : '<span class="muted">No tweaks suggested.</span>';

      const preview = document.getElementById('coverPreview');
      const plain   = letter.plain_text || '';
      preview.innerHTML = plain ? nl2pre(plain) : (letter.html ? letter.html : '<span class="muted">No preview provided.</span>');

      const openDocBtn = document.getElementById('openDoc');
      if(link){
        openDocBtn.style.display='inline-block';
        openDocBtn.onclick = () => window.open(link,'_blank','noopener');
      }else{
        openDocBtn.style.display='none';
      }

      document.getElementById('copyCover').onclick = async () => {
        try{ await navigator.clipboard.writeText(plain || letter.html || ''); toast('Cover letter copied'); }
        catch{ toast('Copy failed'); }
      };

      status.textContent='Generated âœ“';
      outBox.style.display='block';
    }catch(e){
      console.error(e);
      status.textContent='Generation failed. Check n8n logs & CORS.';
    }finally{
      coverBtn.disabled = false;
    }
  }

  // events
  analyseBtn.addEventListener('click', analyseUrl);
  jobUrlInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') analyseUrl(); });
</script>
</body>
</html>
