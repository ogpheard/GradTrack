<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Graduate Applications Assistant</title>
<style>
  :root{
    --bg:#0f1221; --panel:#151933; --muted:#8b91b0; --text:#e8ebff; --accent:#7aa2ff; --good:#21c07a; --warn:#ffb020; --bad:#ff5c7a; --chip:#1c2142;
    --shadow:0 6px 24px rgba(0,0,0,.25);
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:960px;margin:32px auto;padding:0 16px}
  .card{background:var(--panel);border-radius:16px;box-shadow:var(--shadow);padding:20px}
  h1{font-size:24px;margin:0 0 12px}
  h2{font-size:18px;margin:16px 0 8px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .urlbar{display:flex;gap:8px;width:100%}
  input[type="url"]{flex:1;padding:14px 12px;border-radius:12px;border:1px solid #2b3160;background:#0e1330;color:var(--text)}
  button{border:0;border-radius:12px;padding:12px 16px;cursor:pointer;font-weight:600;background:#2a3170;color:#fff}
  button.primary{background:var(--accent)}
  button.ghost{background:transparent;border:1px solid #2b3160}
  button.good{background:var(--good)}
  button.warn{background:var(--warn);color:#1d1d1d}
  button.bad{background:var(--bad)}
  button:disabled{opacity:.6;cursor:not-allowed}
  .muted{color:var(--muted);font-size:13px}
  .kvs{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin:12px 0}
  .kv{background:#0e1330;border:1px solid #262d59;border-radius:12px;padding:10px}
  .kv b{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
  .meters{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:12px 0}
  .meter{background:#0e1330;border:1px solid #262d59;border-radius:12px;padding:10px}
  .meter .bar{height:10px;background:#1b2147;border-radius:8px;overflow:hidden;margin-top:8px}
  .meter .fill{height:100%;background:linear-gradient(90deg,var(--good),var(--accent));width:0%}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{background:var(--chip);border:1px solid #2b3160;color:#cfd6ff;padding:6px 10px;border-radius:999px;font-size:12px}
  .cols{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .details{margin-top:12px}
  .details pre{white-space:pre-wrap;word-break:break-word;background:#0e1330;border:1px solid #262d59;border-radius:12px;padding:12px;color:#cfe0ff;max-height:360px;overflow:auto}
  .decisions{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
  .toast{position:fixed;right:16px;bottom:16px;background:#111635;border:1px solid #27306a;color:#e8ebff;padding:12px 14px;border-radius:12px;box-shadow:var(--shadow);opacity:0;transform:translateY(6px);transition:.25s}
  .toast.show{opacity:1;transform:translateY(0)}
  .inline{display:inline-flex;gap:8px;align-items:center}
  .rating{display:flex;gap:12px;align-items:center;margin-top:6px}
  .rating input{width:64px;padding:8px;border-radius:8px;border:1px solid #2b3160;background:#0e1330;color:#fff;text-align:center}
  .skeleton{height:14px;background:linear-gradient(90deg,#1a1f42 0%,#202759 50%,#1a1f42 100%);background-size:200% 100%;animation:sh 1.2s infinite}
  @keyframes sh{0%{background-position:200% 0}100%{background-position:-200% 0}}
  .small{font-size:12px}
  .env{margin-left:auto;display:flex;gap:8px;align-items:center}
  .env select{background:#0e1330;border:1px solid #2b3160;color:#fff;border-radius:10px;padding:8px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="row">
      <h1>Graduate Applications Assistant</h1>
      <div class="env">
        <label class="small muted">Environment</label>
        <select id="envSelect" title="Switch between Test and Prod">
          <option value="test">Test</option>
          <option value="prod">Prod</option>
        </select>
      </div>
    </div>
    <div class="urlbar">
      <input id="jobUrl" type="url" placeholder="Paste a job URL…" autocomplete="off" />
      <button id="analyzeBtn" class="primary">Analyse</button>
    </div>
    <p class="muted small">Test uses <code>/webhook-test/*</code> (workflow must be Executing). Prod uses <code>/webhook/*</code> (workflow Active).</p>
  </div>

  <div id="result" class="card" style="margin-top:16px; display:none;"></div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
  // ====== ENDPOINTS (YOUR URLS) ======
  const URLS = {
    test: {
      analyse: 'https://ogpheard.app.n8n.cloud/webhook-test/analyse',
      applications: 'https://ogpheard.app.n8n.cloud/webhook-test/applications',
    },
    prod: {
      analyse: 'https://ogpheard.app.n8n.cloud/webhook/analyse',
      applications: 'https://ogpheard.app.n8n.cloud/webhook/applications',
    }
  };

  // ====== UI refs ======
  const envSelect = document.getElementById('envSelect');
  const analyzeBtn = document.getElementById('analyzeBtn');
  const jobUrlInput = document.getElementById('jobUrl');
  const resultEl = document.getElementById('result');
  const toastEl = document.getElementById('toast');

  // Default env from ?env=prod or Test
  const initialEnv = (new URLSearchParams(location.search).get('env') || 'test').toLowerCase();
  envSelect.value = (initialEnv === 'prod' ? 'prod' : 'test');
  let currentEnv = envSelect.value;
  envSelect.addEventListener('change', () => { currentEnv = envSelect.value; toast(`Switched to ${currentEnv.toUpperCase()}`); });

  // ====== helpers ======
  function toast(msg) {
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    setTimeout(() => toastEl.classList.remove('show'), 2200);
  }
  function londonTodayISO() {
    const fmt = new Intl.DateTimeFormat('en-GB', {
      timeZone: 'Europe/London', year: 'numeric', month: '2-digit', day: '2-digit'
    }).formatToParts(new Date());
    const y = fmt.find(p => p.type === 'year').value;
    const m = fmt.find(p => p.type === 'month').value;
    const d = fmt.find(p => p.type === 'day').value;
    return `${y}-${m}-${d}`;
  }
  function escapeHtml(s) { return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function nl2pre(s) { return `<pre>${escapeHtml(String(s || '')).replace(/\n{3,}/g, '\n\n')}</pre>`; }
  function lines(list) { if (!Array.isArray(list)) return ''; return list.slice(0, 12).map(x => `• ${escapeHtml(String(x))}`).join('\n'); }
  function badgeList(list){ if(!Array.isArray(list)) return ''; return `<div class="chips">${list.slice(0,20).map(k=>`<span class="chip">${escapeHtml(k)}</span>`).join('')}</div>`; }
  function salaryText(a) {
    const s = a.salary || {};
    if (s.salary_raw) return s.salary_raw;
    if (s.min && s.max) return `${s.currency || ''} ${s.min}–${s.max} ${s.period || ''}`.trim();
    if (s.min) return `${s.currency || ''} ${s.min} ${s.period || ''}`.trim();
    return a.salary_raw || '';
  }

  async function postJSON(url, body) {
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify(body)
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return res.json().catch(()=> ({}));
  }
  async function postForm(url, formData) {
    const res = await fetch(url, { method:'POST', body:formData });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return res.json();
  }

  let draft = null; // latest analysis

  function renderAnalysis(a) {
    const fit = Math.max(0, Math.min(100, Number(a.AI_fit_score || 0)));
    const align = Math.max(0, Math.min(100, Number(a.AI_alignment_score || 0)));
    const locs = Array.isArray(a.locations) ? a.locations.join(' • ') : '';
    const sal = salaryText(a);
    const deadline = a.date_deadline ? `Deadline: ${a.date_deadline}` : '';
    const start = a.start_date ? `Start: ${a.start_date}` : '';

    const header =
      `<h2>${escapeHtml(a.title || 'Untitled role')}</h2>
       <div class="muted">${escapeHtml(a.company_name || '')}</div>
       <div class="kvs">
         <div class="kv"><b>Locations</b>${escapeHtml(locs || '—')}</div>
         <div class="kv"><b>Salary</b>${escapeHtml(sal || '—')}</div>
         <div class="kv"><b>Dates</b>${escapeHtml([start, deadline].filter(Boolean).join(' · ') || '—')}</div>
         <div class="kv"><b>URL</b><a href="${a.source_url}" target="_blank" rel="noopener">${escapeHtml(a.source_url || '')}</a></div>
       </div>`;

    const meters =
      `<div class="meters">
         <div class="meter" aria-label="AI Fit score">
           <div class="row"><strong>AI Fit</strong><span class="muted" style="margin-left:auto">${fit}%</span></div>
           <div class="bar"><div class="fill" style="width:${fit}%"></div></div>
         </div>
         <div class="meter" aria-label="AI Alignment score">
           <div class="row"><strong>Alignment</strong><span class="muted" style="margin-left:auto">${align}%</span></div>
           <div class="bar"><div class="fill" style="width:${align}%"></div></div>
         </div>
       </div>`;

    const keywords = `<h2>Keywords</h2>${badgeList(a.keywords)}`;
    const colLists =
      `<div class="cols">
         <div>
           <h2>Fits</h2>
           ${nl2pre(lines(a.fits))}
         </div>
         <div>
           <h2>Gaps</h2>
           ${nl2pre(lines(a.gaps))}
         </div>
       </div>`;

    const summary =
      `<h2>Summary</h2>
       <div class="kv" style="margin-top:8px">${escapeHtml(a.job_summary || '')}</div>`;

    const details =
      `<div class="details">
         <button id="toggleMore" class="ghost">View more</button>
         <div id="moreBox" style="display:none;margin-top:12px">
           <h2>Full description</h2>
           ${nl2pre(a.job_description || '')}
         </div>
       </div>`;

    const decisions =
      `<div class="decisions">
         <button id="saveBtn" class="primary">Save for later</button>
         <div class="inline">
           <button id="applyBtn" class="good">Yes I applied</button>
           <div id="ratings" class="rating" style="display:none">
             <label class="small">Effort/10 <input id="effort" type="number" min="0" max="10" step="1" value="7" /></label>
             <label class="small">Chance/10 <input id="chance" type="number" min="0" max="10" step="1" value="6" /></label>
             <button id="confirmApply" class="good">Confirm</button>
           </div>
         </div>
         <button id="ignoreBtn" class="bad">Ignore</button>
       </div>`;

    resultEl.innerHTML = header + meters + keywords + colLists + summary + details + decisions;
    resultEl.style.display = 'block';

    // handlers
    document.getElementById('toggleMore').addEventListener('click', () => {
      const box = document.getElementById('moreBox');
      const open = box.style.display !== 'none';
      box.style.display = open ? 'none' : 'block';
      document.getElementById('toggleMore').textContent = open ? 'View more' : 'Hide';
    });
    document.getElementById('saveBtn').addEventListener('click', onSave);
    document.getElementById('applyBtn').addEventListener('click', () => {
      document.getElementById('ratings').style.display = 'inline-flex';
    });
    document.getElementById('confirmApply').addEventListener('click', onApply);
    document.getElementById('ignoreBtn').addEventListener('click', () => {
      resultEl.style.display = 'none';
      draft = null;
      toast('Ignored. Nothing saved.');
    });
  }

  function toApplicationsPayload(a, opts) {
    return {
      source_url: a.source_url || '',
      canonical_job_url: a.canonical_job_url || a.canonical_url || a.source_url || '',
      title: a.title || '',
      company_name: a.company_name || '',
      seniority: a.seniority || '',
      role_type: a.role_type || '',
      sector: a.sector || '',
      contact_email: a.contact_email || '',
      date_posted: a.date_posted || '',
      date_deadline: a.date_deadline || '',
      start_date: a.start_date || '',
      salary_min: a.salary?.min || '',
      salary_max: a.salary?.max || '',
      salary_currency: a.salary?.currency || '',
      salary_period: a.salary?.period || '',
      salary_raw: a.salary?.salary_raw || a.salary_raw || '',
      locations: Array.isArray(a.locations) ? a.locations : [],
      AI_fit_score: a.AI_fit_score ?? 0,
      AI_alignment_score: a.AI_alignment_score ?? 0,
      AI_cv_filename: a.AI_cv_recommendation?.filename || a.AI_cv_filename || '',
      AI_cv_reason: a.AI_cv_recommendation?.reason || a.AI_cv_reason || '',
      key_requirements: a.key_requirements || [],
      other_requirements: a.other_requirements || [],
      fits: a.fits || [],
      gaps: a.gaps || [],
      job_summary: a.job_summary || '',
      keywords: a.keywords || [],
      job_description: a.job_description || '',
      status: opts.status, // "Saved" | "Applied"
      applied_date: opts.status === 'Applied' ? (opts.appliedDate || londonTodayISO()) : null,
      application_effort_rating: opts.effort ?? null,
      application_chance_rating: opts.chance ?? null,
      cover_letter_url: a.cover_letter_url ?? null
    };
  }

  async function onSave() {
    if (!draft) return;
    try {
      const payload = toApplicationsPayload(draft, { status: 'Saved' });
      await postJSON(URLS[currentEnv].applications, payload);
      toast('Saved for later ✅');
    } catch (e) {
      console.error(e); toast(`Save failed (${currentEnv})`);
    }
  }

  async function onApply() {
    if (!draft) return;
    try {
      const effort = Number(document.getElementById('effort').value);
      const chance = Number(document.getElementById('chance').value);
      const payload = toApplicationsPayload(draft, {
        status: 'Applied',
        effort: Number.isFinite(effort) ? effort : null,
        chance: Number.isFinite(chance) ? chance : null,
        appliedDate: londonTodayISO()
      });
      await postJSON(URLS[currentEnv].applications, payload);
      toast('Marked as applied 🎉');
    } catch (e) {
      console.error(e); toast(`Apply failed (${currentEnv})`);
    }
  }

  async function analyseUrl() {
    const url = jobUrlInput.value.trim();
    if (!/^https?:\/\//i.test(url)) { toast('Please paste a valid URL'); return; }
    // skeleton
    resultEl.style.display = 'block';
    resultEl.innerHTML = `
      <div class="skeleton" style="width:60%"></div>
      <div class="skeleton" style="width:40%;margin-top:8px"></div>
      <div class="skeleton" style="width:90%;height:64px;margin-top:16px"></div>
    `;
    analyzeBtn.disabled = true;
    try {
      // POST FormData with job_url (matches your working page)
      const fd = new FormData();
      fd.append('job_url', url);
      const data = await postForm(URLS[currentEnv].analyse, fd);
      const out = Array.isArray(data) ? data[0] : data;
      if (!out) throw new Error('No analysis');
      draft = out;
      renderAnalysis(out);
    } catch (e) {
      console.error(e);
      resultEl.style.display = 'none';
      toast(`Analysis failed (${currentEnv}). If Test, make sure the workflow is Executing and CORS allows this origin.`);
    } finally {
      analyzeBtn.disabled = false;
    }
  }

  analyzeBtn.addEventListener('click', analyseUrl);
  jobUrlInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') analyseUrl(); });
</script>
</body>
</html>
