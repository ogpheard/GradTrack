<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Graduate Applications Assistant</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Charts (lightweight + responsive) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --primary-50:#eff6ff; --primary-100:#dbeafe; --primary-500:#3b82f6; --primary-600:#2563eb; --primary-700:#1d4ed8;
      --success-50:#f0fdf4; --success-500:#22c55e; --success-600:#16a34a;
      --warning-50:#fffbeb; --warning-500:#f59e0b; --warning-600:#d97706;
      --danger-50:#fef2f2; --danger-500:#ef4444; --danger-600:#dc2626;
      --gray-50:#f9fafb; --gray-100:#f3f4f6; --gray-200:#e5e7eb; --gray-300:#d1d5db; --gray-400:#9ca3af;
      --gray-500:#6b7280; --gray-600:#4b5563; --gray-700:#374151; --gray-800:#1f2937; --gray-900:#111827;
      --shadow-sm:0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md:0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl:0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
      --gradient-primary: linear-gradient(135deg,var(--primary-500),var(--primary-600));
      --gradient-success: linear-gradient(135deg,var(--success-500),var(--success-600));
      --gradient-danger: linear-gradient(135deg,var(--danger-500),var(--danger-600));
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh; padding:2rem 1rem; color:var(--gray-800);
    }
    .container{max-width:1200px;margin:0 auto}
    .header,.panel{
      background:rgba(255,255,255,.95); backdrop-filter:blur(20px);
      border:1px solid rgba(255,255,255,.2); border-radius:24px; padding:2rem; box-shadow:var(--shadow-xl);
    }
    .header{margin-bottom:2rem}
    .header-content{display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;margin-bottom:2rem}
    .title{font-size:clamp(1.5rem,4vw,2.5rem);font-weight:700;background:var(--gradient-primary);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
    .nav-controls{display:flex;align-items:center;gap:2rem;flex-wrap:wrap}
    .nav-tabs{display:flex;background:var(--gray-100);border-radius:12px;padding:4px}
    .nav-tab{display:flex;align-items:center;gap:.5rem;padding:.75rem 1.25rem;border:none;background:transparent;color:var(--gray-600);font-weight:600;border-radius:10px;cursor:pointer;transition:.25s}
    .nav-tab:hover{background:var(--gray-200);color:var(--gray-800)}
    .nav-tab.active{background:#fff;color:var(--primary-600);box-shadow:var(--shadow-sm)}
    .env-selector{display:flex;align-items:center;gap:.75rem;background:var(--gray-50);padding:.75rem 1rem;border-radius:16px;border:1px solid var(--gray-200)}
    .env-selector label{font-size:.9rem;color:var(--gray-600);font-weight:500}
    .env-selector select{background:#fff;border:1px solid var(--gray-300);border-radius:8px;padding:.5rem .75rem;font-size:.9rem;color:var(--gray-700)}
    .page-content{display:none}
    .page-content.active{display:block}

    /* Analyse page */
    .search-section{position:relative}
    .search-input{width:100%;padding:1rem 1.25rem;border:2px solid var(--gray-200);border-radius:16px;background:#fff;transition:.25s;outline:none}
    .search-input:focus{border-color:var(--primary-500);box-shadow:0 0 0 4px rgba(59,130,246,.1);transform:translateY(-2px)}
    .search-button{position:absolute;right:8px;top:50%;transform:translateY(-50%);background:var(--gradient-primary);color:#fff;border:none;padding:.75rem 1.25rem;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:var(--shadow-md);transition:.25s}
    .search-button:hover:not(:disabled){transform:translateY(calc(-50% - 2px))}
    .helper-text{margin-top:1rem;font-size:.9rem;color:var(--gray-500);display:flex;align-items:center;gap:.5rem}

    /* Pasted JD input */
    .paste-wrap{margin-top:1rem;display:flex;flex-direction:column;gap:.5rem}
    #jobText{
      width:100%; min-height:7.5rem; max-height:16rem; /* ~6–10 rows */
      padding:1rem 1.25rem; border:2px solid var(--gray-200); border-radius:16px;
      background:#fff; outline:none; resize:vertical; overflow:auto;
      transition:.25s;
    }
    #jobText:focus{border-color:var(--primary-500); box-shadow:0 0 0 4px rgba(59,130,246,.1); transform:translateY(-2px)}
    #jobSourceUrl{
      width:100%; padding:.8rem 1rem; border:2px solid var(--gray-200); border-radius:12px; background:#fff;
    }
    .input-hint{display:flex;justify-content:space-between;align-items:center;gap:.75rem; color:var(--gray-500); font-size:.85rem}
    .mono{font-variant-numeric:tabular-nums}

    .result-card{background:rgba(255,255,255,.95);border:1px solid rgba(255,255,255,.2);border-radius:24px;padding:2rem;box-shadow:var(--shadow-xl);display:none;animation:slideUp .6s ease-out;margin-top:1rem}
    @keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
    .job-header{border-bottom:1px solid var(--gray-200);padding-bottom:1.25rem;margin-bottom:1.25rem}
    .job-title{font-size:2rem;font-weight:800;color:var(--gray-900)}
    .job-company{font-size:1.15rem;color:var(--gray-600);margin:.5rem 0 1rem}
    .job-details{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:1rem}
    .detail-item{background:var(--gray-50);border:1px solid var(--gray-200);border-radius:12px;padding:1rem}
    .detail-label{font-size:.75rem;color:var(--gray-500);font-weight:700;letter-spacing:.05em;text-transform:uppercase;margin-bottom:.25rem}
    .detail-value a{color:var(--primary-600);text-decoration:none}

    .scores-section{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1.25rem;margin:1.5rem 0}
    .score-card{background:#fff;border:1px solid var(--gray-200);border-radius:16px;padding:1.25rem;text-align:center}
    .score-label{color:var(--gray-700);font-weight:700;margin-bottom:.5rem}
    .score-value{font-size:2rem;font-weight:800}
    .score-bar{height:8px;background:var(--gray-200);border-radius:4px;overflow:hidden;margin-top:.5rem}
    .score-fill{height:100%;background:var(--gradient-primary)}

    .section{margin:1.5rem 0}
    .section-title{font-size:1.25rem;font-weight:800;color:var(--gray-900);display:flex;align-items:center;gap:.5rem;margin-bottom:.75rem}
    .keywords{display:flex;flex-wrap:wrap;gap:.6rem}
    .keyword{background:var(--primary-50);color:var(--primary-700);border:1px solid var(--primary-200);padding:.45rem .85rem;border-radius:22px;font-weight:600;font-size:.9rem}
    .columns{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1.25rem}
    .column{background:#fff;border:1px solid var(--gray-200);border-radius:16px;padding:1rem}
    .list-content{background:var(--gray-50);border-radius:8px;padding:1rem;white-space:pre-wrap;color:var(--gray-700)}

    .summary{background:linear-gradient(135deg,var(--primary-50),var(--primary-100));border:1px solid var(--primary-200);border-radius:16px;padding:1.25rem}

    .actions{display:flex;flex-wrap:wrap;gap:.75rem;margin:1.25rem 0;padding-top:1.25rem;border-top:1px solid var(--gray-200)}
    .btn{padding:.75rem 1.25rem;border-radius:12px;font-weight:800;cursor:pointer;border:none;display:flex;align-items:center;gap:.5rem;font-size:.9rem}
    .btn-primary{background:var(--gradient-primary);color:#fff}
    .btn-success{background:var(--gradient-success);color:#fff}
    .btn-outline{background:#fff;color:var(--gray-800);border:2px solid var(--gray-300)}
    .btn-danger{background:var(--gradient-danger);color:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-sm{ padding:.45rem .7rem; border-radius:10px; font-weight:700; font-size:.8rem }
    .icon{ width:16px; height:16px; display:inline-block; vertical-align:-2px }

    .rating-inputs{display:none;align-items:center;gap:1rem;margin-top:.5rem;padding:1rem;background:var(--gray-50);border:1px solid var(--gray-200);border-radius:12px}
    .rating-inputs.show{display:flex}
    .rating-input{display:flex;flex-direction:column;gap:.25rem}
    .rating-input input{padding:.5rem;border:1px solid var(--gray-300);border-radius:8px;width:80px}

    .cover-section{display:none;margin-top:1rem;padding-top:1rem;border-top:1px solid var(--gray-200)}
    .cover-section.show{display:block}
    .cover-status{display:flex;align-items:center;gap:.5rem;color:var(--gray-600)}
    .spinner{width:16px;height:16px;border:2px solid var(--gray-300);border-top:2px solid var(--primary-500);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .cover-content{display:none}
    .cover-content.show{display:block}
    .cover-preview{background:var(--gray-50);border:1px solid var(--gray-200);border-radius:12px;padding:1rem;white-space:pre-wrap;max-height:360px;overflow:auto}

    .details-section{margin-top:1rem;border-top:1px solid var(--gray-200);padding-top:1rem}
    .details-content{display:none;margin-top:.5rem}
    .details-content.show{display:block}
    .details-text{background:var(--gray-50);border:1px solid var(--gray-200);border-radius:12px;padding:1rem;white-space:pre-wrap;max-height:600px;overflow:auto}

    /* Applications & Saved */
    .filters{display:flex;gap:1rem;flex-wrap:wrap;margin-bottom:1rem}
    .filter-select{padding:.6rem .85rem;border:1px solid var(--gray-300);border-radius:10px;background:#fff;font-weight:600}
    .applications-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(380px,1fr));gap:1.1rem}
    .application-card{background:rgba(255,255,255,.95);border:1px solid rgba(255,255,255,.2);border-radius:16px;padding:1.1rem;box-shadow:var(--shadow-md);cursor:pointer;transition:.2s;position:relative}
    .application-card:hover{transform:translateY(-3px);box-shadow:var(--shadow-lg)}
    .application-status{position:absolute;top:.75rem;right:.75rem;padding:.2rem .65rem;border-radius:20px;font-size:.72rem;font-weight:800;text-transform:uppercase}
    .status-applied{background:var(--success-50);color:var(--success-600);border:1px solid #bbf7d0}
    .status-saved{background:var(--primary-50);color:var(--primary-600);border:1px solid #bfdbfe}
    .status-response{background:var(--warning-50);color:var(--warning-600);border:1px solid #fde68a}
    .application-title{font-size:1.1rem;font-weight:800;color:var(--gray-900)}
    .application-company{color:var(--primary-600);font-weight:700;margin:.25rem 0}
    .application-date{font-size:.85rem;color:var(--gray-500)}
    .application-scores{display:flex;gap:1rem;margin:.75rem 0}
    .mini-score{flex:1;text-align:center}
    .mini-score-label{font-size:.75rem;color:var(--gray-500)}
    .mini-score-value{font-weight:800;color:var(--primary-600)}
    .application-meta{display:flex;justify-content:space-between;align-items:center;margin-top:.6rem;padding-top:.6rem;border-top:1px solid var(--gray-200);font-size:.9rem;color:var(--gray-600)}

    /* Modal */
    .modal{position:fixed;top:0;left:0;width:100%;height:100%;z-index:1000;display:none;align-items:center;justify-content:center;padding:2rem}
    .modal.show{display:flex}
    .modal-overlay{position:absolute;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(4px)}
    .modal-content{position:relative;background:#fff;border-radius:24px;box-shadow:var(--shadow-xl);max-width:840px;width:100%;max-height:90vh;overflow:hidden;display:flex;flex-direction:column}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:1.25rem 1.5rem;border-bottom:1px solid var(--gray-200)}
    .modal-body{padding:1.25rem;overflow:auto}
    .modal-close{background:none;border:none;color:var(--gray-500);cursor:pointer;padding:.5rem;border-radius:8px}

    /* Analytics */
    .kpi-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem;margin-bottom:1rem}
    .kpi{background:#fff;border:1px solid var(--gray-200);border-radius:16px;padding:1rem}
    .kpi-label{font-size:.85rem;color:var(--gray-500);font-weight:700;letter-spacing:.04em;text-transform:uppercase}
    .kpi-value{font-size:1.8rem;font-weight:900;margin-top:.35rem}
    .charts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:1rem}

    /* Add Application */
    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1rem}
    .form-field{display:flex;flex-direction:column;gap:.35rem}
    .form-field label{font-weight:700;color:var(--gray-700);font-size:.9rem}
    .form-field input,.form-field textarea,.form-field select{
      border:1px solid var(--gray-300);border-radius:10px;padding:.6rem .75rem;background:#fff;font-size:.95rem
    }
    .help{font-size:.8rem;color:var(--gray-500)}
    .hr{height:1px;background:var(--gray-200);margin:1rem 0}

    /* Toast */
    .toast{position:fixed;top:1.25rem;right:1.25rem;background:rgba(255,255,255,.95);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.2);color:var(--gray-800);padding:.9rem 1.1rem;border-radius:12px;box-shadow:var(--shadow-xl);transform:translateX(400px);opacity:0;transition:.35s;z-index:1200;max-width:320px}
    .toast.show{transform:translateX(0);opacity:1}

    @media (max-width:768px){
      body{padding:1rem}
      .header{padding:1.25rem}
      .nav-controls{flex-direction:column;gap:1rem}
      .applications-grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="header-content">
        <h1 class="title">Graduate Applications Assistant</h1>
        <div class="nav-controls">
          <nav class="nav-tabs">
            <button id="analyzeTab" class="nav-tab active" data-tab="analyze">Analyze</button>
            <button id="applicationsTab" class="nav-tab" data-tab="applications">My Applications</button>
            <button id="savedTab" class="nav-tab" data-tab="saved">Saved</button>
            <button id="analyticsTab" class="nav-tab" data-tab="analytics">Analytics</button>
            <button id="addTab" class="nav-tab" data-tab="add">Add Application</button>
          </nav>
          <div class="env-selector">
            <label>Environment:</label>
            <select id="envSelect">
              <option value="test">Test</option>
              <option value="prod">Production</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- Applications page -->
    <div id="applicationsPage" class="page-content">
      <div class="panel">
        <div class="filters">
          <select id="statusFilter" class="filter-select">
            <option value="all">All statuses</option>
            <option value="applied">Applied</option>
            <option value="response">Got response</option>
            <option value="saved">Saved</option>
          </select>
          <select id="sortFilter" class="filter-select">
            <option value="date-desc">Newest first</option>
            <option value="date-asc">Oldest first</option>
            <option value="fit-desc">Best fit first</option>
            <option value="company">By company</option>
          </select>
        </div>
        <div id="applicationsGrid" class="applications-grid"></div>
      </div>
    </div>

    <!-- Saved page -->
    <div id="savedPage" class="page-content">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem">
          <h2 style="font-size:1.4rem;font-weight:900;color:var(--gray-900)">Saved for later</h2>
          <select id="savedSort" class="filter-select">
            <option value="date-desc">Newest first</option>
            <option value="fit-desc">Best fit first</option>
            <option value="company">By company</option>
          </select>
        </div>
        <div id="savedGrid" class="applications-grid"></div>
      </div>
    </div>

    <!-- Analytics page -->
    <div id="analyticsPage" class="page-content">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:1rem;flex-wrap:wrap;margin-bottom:1rem">
          <h2 style="font-size:1.4rem;font-weight:900;color:var(--gray-900)">Application Analytics</h2>
          <div style="display:flex;gap:.5rem;align-items:center">
            <label class="help">Timeframe</label>
            <select id="analyticsRange" class="filter-select">
              <option value="all">All time</option>
              <option value="90">Last 90 days</option>
              <option value="30">Last 30 days</option>
            </select>
          </div>
        </div>

        <div class="kpi-row">
          <div class="kpi"><div class="kpi-label">Total applications</div><div id="kpiTotal" class="kpi-value">0</div></div>
          <div class="kpi"><div class="kpi-label">Applied</div><div id="kpiApplied" class="kpi-value">0</div></div>
          <div class="kpi"><div class="kpi-label">Responses</div><div id="kpiResponses" class="kpi-value">0</div></div>
          <div class="kpi"><div class="kpi-label">Avg fit</div><div id="kpiAvgFit" class="kpi-value">0%</div></div>
        </div>

        <div class="charts-grid">
          <canvas id="chartStatus"></canvas>
          <canvas id="chartFitDist"></canvas>
          <canvas id="chartCompany"></canvas>
          <canvas id="chartTrend"></canvas>
        </div>
      </div>
    </div>

    <!-- Add application page -->
    <div id="addPage" class="page-content">
      <div class="panel">
        <h2 style="font-size:1.4rem;font-weight:900;color:var(--gray-900);margin-bottom:1rem">Add application</h2>
        <form id="addForm">
          <div class="form-grid">
            <div class="form-field"><label>Job title</label><input name="title" placeholder="e.g. Graduate GIS Consultant" required/></div>
            <div class="form-field"><label>Company</label><input name="company_name" placeholder="e.g. Stantec" required/></div>
            <div class="form-field"><label>Source URL</label><input type="url" name="source_url" placeholder="https://..." /></div>
            <div class="form-field"><label>Locations (comma separated)</label><input name="locations" placeholder="Bristol, Cambridge"/></div>
            <div class="form-field"><label>Status</label>
              <select name="status">
                <option value="Saved">Saved</option>
                <option value="Applied">Applied</option>
              </select>
            </div>
            <div class="form-field"><label>Applied date (YYYY-MM-DD)</label><input name="applied_date" placeholder="2025-08-29"/></div>
            <div class="form-field"><label>Effort /10</label><input type="number" min="0" max="10" step="1" name="application_effort_rating"/></div>
            <div class="form-field"><label>Chance /10</label><input type="number" min="0" max="10" step="1" name="application_chance_rating"/></div>

            <div class="form-field"><label>AI Fit %</label><input type="number" min="0" max="100" step="1" name="AI_fit_score"/></div>
            <div class="form-field"><label>AI Alignment %</label><input type="number" min="0" max="100" step="1" name="AI_alignment_score"/></div>
            <div class="form-field"><label>Salary min</label><input type="number" name="salary_min"/></div>
            <div class="form-field"><label>Salary max</label><input type="number" name="salary_max"/></div>
            <div class="form-field"><label>Salary currency</label><input name="salary_currency" placeholder="£"/></div>
            <div class="form-field"><label>Salary period</label><input name="salary_period" placeholder="per annum"/></div>

            <div class="form-field"><label>Keywords (comma separated)</label><input name="keywords" placeholder="GIS, ArcGIS, QGIS"/></div>
            <div class="form-field"><label>Fits (semicolon separated)</label><input name="fits" placeholder="Strong GIS modules; ArcGIS projects"/></div>
            <div class="form-field"><label>Gaps (semicolon separated)</label><input name="gaps" placeholder="Limited commercial experience; …"/></div>

            <div class="form-field"><label>Summary</label><textarea name="job_summary" rows="3" placeholder="Short summary…"></textarea></div>
            <div class="form-field" style="grid-column:1/-1"><label>Description</label><textarea name="job_description" rows="5" placeholder="Full job description…"></textarea></div>
          </div>

          <div class="hr"></div>
          <div style="display:flex;gap:.75rem;flex-wrap:wrap">
            <button class="btn btn-primary" type="submit">Save to n8n</button>
            <button class="btn btn-outline" type="button" id="addMock">Quick add (local only)</button>
          </div>
          <p class="help" style="margin-top:.5rem">Arrays are parsed from your comma/semicolon entries. The form posts to your <strong>/applications</strong> webhook using the current environment.</p>
        </form>
      </div>
    </div>

    <!-- Analyze page -->
    <div id="analyzePage" class="page-content active">
      <div class="panel">
        <div class="search-section">
          <!-- Pasted JD -->
          <div class="paste-wrap">
            <label for="jobText" class="detail-label" style="display:block;margin-bottom:.25rem">Paste job description (required)</label>
            <textarea id="jobText" placeholder="Cmd/Ctrl+A then Cmd/Ctrl+C on the job page, and paste here…" autocomplete="off"></textarea>
            <div class="input-hint">
              <span>We’ll extract title, company, salary, locations, keywords, etc.</span>
              <span id="jobCharCount" class="mono">0 / 30000</span>
            </div>
          </div>

          <!-- Optional URL -->
          <div class="paste-wrap" style="margin-top:.75rem">
            <label for="jobSourceUrl" class="detail-label" style="display:block;margin-bottom:.25rem">Source URL (optional)</label>
            <input id="jobSourceUrl" type="url" placeholder="https://example.com/jobs/role" autocomplete="off"/>
            <div class="input-hint">
              <span>Helps with canonical URL & employer attribution.</span>
              <span class="mono">Optional</span>
            </div>
          </div>

          <!-- Action -->
          <button id="analyzeBtn" class="search-button"><span id="analyzeText">Analyze</span></button>
        </div>
        <div class="helper-text">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
          Test uses <code>/webhook-test/*</code>. Production uses <code>/webhook/*</code>.
        </div>

        <div id="resultCard" class="result-card" aria-live="polite">
          <div id="loadingState" style="display:none">
            <div style="height:16px;background:var(--gray-200);border-radius:8px;margin:.5rem 0;animation:loading 1.5s infinite;background-size:200% 100%;background-image:linear-gradient(90deg,var(--gray-200) 25%,var(--gray-100) 50%,var(--gray-200) 75%)"></div>
            <div style="height:16px;background:var(--gray-200);border-radius:8px;margin:.5rem 0;animation:loading 1.5s infinite;background-size:200% 100%;background-image:linear-gradient(90deg,var(--gray-200) 25%,var(--gray-100) 50%,var(--gray-200) 75%)"></div>
          </div>

          <div id="resultContent" style="display:none">
            <div class="job-header">
              <h2 id="jobTitle" class="job-title">Job Title</h2>
              <div id="jobCompany" class="job-company">Company</div>
              <div id="jobDetails" class="job-details"></div>
            </div>

            <div class="scores-section">
              <div class="score-card">
                <div class="score-label">AI Fit Score</div>
                <div id="fitScore" class="score-value">0%</div>
                <div class="score-bar"><div id="fitFill" class="score-fill" style="width:0%"></div></div>
              </div>
              <div class="score-card">
                <div class="score-label">Alignment Score</div>
                <div id="alignScore" class="score-value">0%</div>
                <div class="score-bar"><div id="alignFill" class="score-fill" style="width:0%"></div></div>
              </div>
            </div>

            <div class="section">
              <h3 class="section-title">Keywords</h3>
              <div id="keywords" class="keywords"></div>
            </div>

            <div class="columns">
              <div class="column">
                <h3>✅ Perfect fits</h3>
                <div id="fits" class="list-content"></div>
              </div>
              <div class="column">
                <h3>⚠️ Areas to address</h3>
                <div id="gaps" class="list-content"></div>
              </div>
            </div>

            <div class="section">
              <h3 class="section-title">Job summary</h3>
              <div class="summary"><div id="summary"></div></div>
            </div>

            <div class="actions">
              <button id="saveBtn" class="btn btn-primary">Save for later</button>
              <button id="applyBtn" class="btn btn-success">I applied!</button>
              <button id="coverBtn" class="btn btn-outline">Cover letter & CV</button>
              <button id="ignoreBtn" class="btn btn-danger">Not interested</button>
            </div>

            <div id="ratingInputs" class="rating-inputs" aria-hidden="true">
              <div class="rating-input"><label for="effort">Effort /10</label><input id="effort" type="number" min="0" max="10" step="1" value="7"/></div>
              <div class="rating-input"><label for="chance">Chance /10</label><input id="chance" type="number" min="0" max="10" step="1" value="6"/></div>
              <button id="confirmApply" class="btn btn-success">Confirm</button>
            </div>

            <div id="coverSection" class="cover-section" aria-live="polite">
              <div id="coverStatus" class="cover-status"><span class="spinner"></span> Preparing cover letter & CV tips…</div>
              <div id="coverContent" class="cover-content">
                <div class="job-details" style="margin-bottom:.75rem">
                  <div class="detail-item"><div class="detail-label">Selected CV</div><div id="cvName" class="detail-value">—</div></div>
                  <div class="detail-item"><div class="detail-label">Why this CV</div><div id="cvWhy" class="detail-value">—</div></div>
                  <div class="detail-item"><div class="detail-label">Cover letter doc</div><div id="coverDocLink" class="detail-value">—</div></div>
                </div>
                <div class="section">
                  <h3 class="section-title">CV tweak suggestions</h3>
                  <div id="cvTweaks" class="list-content"></div>
                </div>
                <div class="section">
                  <h3 class="section-title">Cover letter (preview)</h3>
                  <div id="coverPreview" class="cover-preview"></div>
                  <div style="display:flex;gap:.5rem;margin-top:.5rem">
                    <button id="copyCover" class="btn btn-outline">Copy text</button>
                    <button id="openDoc" class="btn btn-primary" style="display:none">Open Google Doc</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="details-section">
              <button id="toggleDetails" class="btn btn-outline">View more</button>
              <div id="detailsContent" class="details-content">
                <h3 class="section-title">Full description</h3>
                <div id="fullDescription" class="details-text"></div>
              </div>
            </div>
          </div> <!-- /resultContent -->
        </div> <!-- /resultCard -->
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="applicationModal" class="modal" aria-hidden="true">
    <div id="modalOverlay" class="modal-overlay"></div>
    <div class="modal-content" role="dialog" aria-modal="true">
      <div class="modal-header">
        <h3 id="modalTitle" style="font-weight:900;color:var(--gray-900)">Application details</h3>
        <button id="modalClose" class="modal-close" aria-label="Close">✕</button>
      </div>
      <div id="modalBody" class="modal-body"></div>
    </div>
  </div>

  <!-- Confirm Delete Modal -->
  <div id="confirmDeleteModal" class="modal" aria-hidden="true">
    <div class="modal-overlay" id="confirmDeleteOverlay"></div>
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="confirmDeleteTitle">
      <div class="modal-header">
        <h3 id="confirmDeleteTitle" style="font-weight:900;color:var(--gray-900)">Delete this entry?</h3>
        <button id="confirmDeleteClose" class="modal-close" aria-label="Close">✕</button>
      </div>
      <div class="modal-body">
        <p id="confirmDeleteSummary" style="margin-bottom:1rem;color:var(--gray-700)"></p>
        <div class="hr"></div>
        <div style="display:flex;gap:.5rem;flex-wrap:wrap">
          <button id="confirmDeleteBtn" class="btn btn-danger">Delete</button>
          <button id="cancelDeleteBtn" class="btn btn-outline">Cancel</button>
        </div>
        <p class="help" style="margin-top:.5rem">This will permanently remove the row from Google Sheets.</p>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    // ========= ENDPOINTS =========
    const URLS = {
      test: {
        analyse:      'https://ogpheard.app.n8n.cloud/webhook-test/analyse',
        applications: 'https://ogpheard.app.n8n.cloud/webhook-test/applications',
        cover:        'https://ogpheard.app.n8n.cloud/webhook-test/cover',
        list:         'https://ogpheard.app.n8n.cloud/webhook-test/apps/list',
        delete:       'https://ogpheard.app.n8n.cloud/webhook-test/apps/delete',
        update:       'https://ogpheard.app.n8n.cloud/webhook-test/updater'
      },
      prod: {
        analyse:      'https://ogpheard.app.n8n.cloud/webhook/analyse',
        applications: 'https://ogpheard.app.n8n.cloud/webhook/applications',
        cover:        'https://ogpheard.app.n8n.cloud/webhook/cover',
        list:         'https://ogpheard.app.n8n.cloud/webhook/apps/list',
        delete:       'https://ogpheard.app.n8n.cloud/webhook/apps/delete',
        update:       'https://ogpheard.app.n8n.cloud/webhook/updater'
      }
    };
    const CV_FOLDER_ID = '';
    const GUIDE_DOC_ID = '';

    // ====== Elements
    const envSelect = document.getElementById('envSelect');

    // Tabs
    const analyzeTab = document.getElementById('analyzeTab');
    const applicationsTab = document.getElementById('applicationsTab');
    const savedTab = document.getElementById('savedTab');
    const analyticsTab = document.getElementById('analyticsTab');
    const addTab = document.getElementById('addTab');

    // Pages
    const analyzePage = document.getElementById('analyzePage');
    const applicationsPage = document.getElementById('applicationsPage');
    const savedPage = document.getElementById('savedPage');
    const analyticsPage = document.getElementById('analyticsPage');
    const addPage = document.getElementById('addPage');

    // Analyse page refs
    const jobText = document.getElementById('jobText');
    const jobSourceUrl = document.getElementById('jobSourceUrl');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const resultCard = document.getElementById('resultCard');
    const loadingState = document.getElementById('loadingState');
    const resultContent = document.getElementById('resultContent');
    const toastEl = document.getElementById('toast');
    const jobCharCount = document.getElementById('jobCharCount');

    const jobTitleEl = document.getElementById('jobTitle');
    const jobCompanyEl = document.getElementById('jobCompany');
    const jobDetailsEl = document.getElementById('jobDetails');
    const fitScoreEl = document.getElementById('fitScore');
    const alignScoreEl = document.getElementById('alignScore');
    const fitFillEl = document.getElementById('fitFill');
    const alignFillEl = document.getElementById('alignFill');
    const keywordsEl = document.getElementById('keywords');
    const fitsEl = document.getElementById('fits');
    const gapsEl = document.getElementById('gaps');
    const summaryEl = document.getElementById('summary');
    const fullDescriptionEl = document.getElementById('fullDescription');

    const saveBtn = document.getElementById('saveBtn');
    const applyBtn = document.getElementById('applyBtn');
    const ratingInputs = document.getElementById('ratingInputs');
    const confirmApplyBtn = document.getElementById('confirmApply');
    const effortInput = document.getElementById('effort');
    const chanceInput = document.getElementById('chance');
    const ignoreBtn = document.getElementById('ignoreBtn');

    const coverBtn = document.getElementById('coverBtn');
    const coverSection = document.getElementById('coverSection');
    const coverStatus = document.getElementById('coverStatus');
    const coverContent = document.getElementById('coverContent');
    const cvNameEl = document.getElementById('cvName');
    const cvWhyEl = document.getElementById('cvWhy');
    const coverDocLinkEl = document.getElementById('coverDocLink');
    const cvTweaksEl = document.getElementById('cvTweaks');
    const coverPreviewEl = document.getElementById('coverPreview');
    const copyCoverBtn = document.getElementById('copyCover');
    const openDocBtn = document.getElementById('openDoc');

    const toggleDetailsBtn = document.getElementById('toggleDetails');
    const detailsContent = document.getElementById('detailsContent');

    // Applications & Saved
    const applicationsGrid = document.getElementById('applicationsGrid');
    const statusFilter = document.getElementById('statusFilter');
    const sortFilter = document.getElementById('sortFilter');
    const savedGrid = document.getElementById('savedGrid');
    const savedSort = document.getElementById('savedSort');

    // Analytics
    const analyticsRange = document.getElementById('analyticsRange');
    const kpiTotal = document.getElementById('kpiTotal');
    const kpiApplied = document.getElementById('kpiApplied');
    const kpiResponses = document.getElementById('kpiResponses');
    const kpiAvgFit = document.getElementById('kpiAvgFit');

    let chartStatus, chartFitDist, chartCompany, chartTrend;

    // Add application
    const addForm = document.getElementById('addForm');
    const addMockBtn = document.getElementById('addMock');

    // Modal
    const modal = document.getElementById('applicationModal');
    const modalOverlay = document.getElementById('modalOverlay');
    const modalClose = document.getElementById('modalClose');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');

    // ====== Delete modal refs
    const confirmDeleteModal = document.getElementById('confirmDeleteModal');
    const confirmDeleteOverlay = document.getElementById('confirmDeleteOverlay');
    const confirmDeleteClose = document.getElementById('confirmDeleteClose');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
    const confirmDeleteSummary = document.getElementById('confirmDeleteSummary');

    // Holds the pending delete payload
    let pendingDelete = null;

    // Map UI status -> API status
    function apiStatusFor(sourceOrStatus){
      const s = (typeof sourceOrStatus === 'string') ? sourceOrStatus : (sourceOrStatus?.status || '');
      return (String(s).toLowerCase() === 'saved') ? 'Saved' : 'Applied';
    }

    // Derive delete payload from a card item
    function buildDeletePayloadFromCard(app, sourceHint){
      const id = app.id || '';
      const isUrl = /^https?:\/\//i.test(id);
      const payload = {
        status: apiStatusFor(sourceHint || app.status),
        reason: 'user delete via UI'
      };
      if (isUrl) payload.canonical_job_url = id;
      else payload.application_id = id;
      return payload;
    }

    // Call delete API
    async function apiDelete(env, payload){
      const res = await fetch(URLS[env].delete, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      const text = await res.text();
      let json; try{ json = JSON.parse(text); }catch{ json = { raw:text }; }
      if (!res.ok || json?.ok === false){
        const msg = json?.error || `HTTP ${res.status}`;
        throw new Error(msg);
      }
      return json;
    }

    // Modal open/close
    function openDeleteConfirm(app, sourceHint){
      const sheetLabel = apiStatusFor(sourceHint || app.status);
      confirmDeleteSummary.innerHTML = `
        <strong>${escapeHtml(app.title || 'Untitled')}</strong><br/>
        ${escapeHtml(app.company || '—')}<br/>
        <span class="help">Sheet: ${sheetLabel === 'Applied' ? 'Applications (Applied)' : 'Applications (Saved)'}</span>
      `;
      pendingDelete = buildDeletePayloadFromCard(app, sourceHint);
      confirmDeleteModal.classList.add('show');
      confirmDeleteModal.setAttribute('aria-hidden','false');
    }
    function closeDeleteConfirm(){
      confirmDeleteModal.classList.remove('show');
      confirmDeleteModal.setAttribute('aria-hidden','true');
      pendingDelete = null;
    }
    confirmDeleteOverlay.onclick = closeDeleteConfirm;
    confirmDeleteClose.onclick = closeDeleteConfirm;
    cancelDeleteBtn.onclick = closeDeleteConfirm;
    document.addEventListener('keydown',(e)=>{ if (e.key==='Escape' && confirmDeleteModal.classList.contains('show')) closeDeleteConfirm(); });

    // Perform deletion
    confirmDeleteBtn.onclick = async ()=>{
      if (!pendingDelete) return;
      const prevText = confirmDeleteBtn.textContent;
      confirmDeleteBtn.textContent = 'Deleting…';
      confirmDeleteBtn.disabled = true;
      cancelDeleteBtn.disabled = true;
      try{
        await apiDelete(currentEnv, pendingDelete);
        closeDeleteConfirm();
        toast('Deleted ✓');
        await refreshData(true);
      }catch(e){
        console.error(e);
        toast(`Delete failed: ${e.message || e}`);
      }finally{
        confirmDeleteBtn.textContent = prevText;
        confirmDeleteBtn.disabled = false;
        cancelDeleteBtn.disabled = false;
      }
    };

    // ====== State
    const initialEnv = (new URLSearchParams(location.search).get('env') || 'test').toLowerCase();
    envSelect.value = (initialEnv === 'prod' ? 'prod' : 'test');
    let currentEnv = envSelect.value;

    let draft = null;     // last analysis JSON
    let lastCover = null; // last cover JSON

    let appsLive = { applied: [], saved: [] }; // server truth from Workflow 4
    let applicationsList = [];                  // flattened view for “My Applications”

    async function fetchJSONorText(url){
      const res = await fetch(url, { method:'GET', cache:'no-store' });
      const text = await res.text();
      try { return JSON.parse(text); } catch { return text; }
    }

    function toCardShape(r){
      const locs = Array.isArray(r.locations) ? r.locations.join(' • ')
               : typeof r.locations === 'string' ? r.locations : '';
      const salary =
        r.salary_raw ||
        ((r.salary_currency || '') +
         (r.salary_min ? ` ${r.salary_min}` : '') +
         (r.salary_max ? `–${r.salary_max}` : '') +
         (r.salary_period ? ` ${r.salary_period}` : '')).trim();

      return {
        id: r.application_id || r.canonical_job_url || String(Math.random()),
        title: r.title || 'Untitled role',
        company: r.company_name || '',
        status: String(r.status || '').toLowerCase(),
        appliedDate: r.applied_date || null,
        location: locs || '—',
        salary: salary || '—',
        fitScore: Number(r.AI_fit_score || 0),
        alignmentScore: Number(r.AI_alignment_score || 0),
        source: r.source_url ? new URL(r.source_url).hostname : '—',
        description: r.job_description || '',
        requirements: Array.isArray(r.key_requirements) ? r.key_requirements : [],
        fits: Array.isArray(r.fits) ? r.fits : [],
        gaps: Array.isArray(r.gaps) ? r.gaps : []
      };
    }

    function getRawRowById(id){
      const all = [...(appsLive.applied||[]), ...(appsLive.saved||[])];
      // Prefer a direct application_id match, else fall back to the derived card id
      return all.find(r =>
        (r.application_id && r.application_id === id) ||
        (toCardShape(r).id === id)
      ) || null;
    }

    async function refreshData(silent=false){
      try{
        const url = URLS[currentEnv].list + `?t=${Date.now()}`;
        const data = await fetchJSONorText(url);
        if (!data || typeof data !== 'object') throw new Error('Bad response from list endpoint');

        appsLive = {
          applied: Array.isArray(data.applied) ? data.applied : [],
          saved:   Array.isArray(data.saved)   ? data.saved   : []
        };

        const flat = [
          ...appsLive.applied.map(toCardShape),
          ...appsLive.saved.map(toCardShape)
        ];
        applicationsList = flat.filter(a => a.status !== 'saved');

        if (!silent) toast('Data refreshed');

        if (applicationsPage.classList.contains('active')) renderApplications();
        if (savedPage.classList.contains('active'))        renderSaved();
        if (analyticsPage.classList.contains('active'))    renderAnalytics();
      }catch(e){
        console.error(e);
        if (!silent) toast('Failed to load live data');
      }
    }

    let pollTimer = null;
    function startPolling(){
      stopPolling();
      pollTimer = setInterval(()=> refreshData(true), 45000); // 45s
    }
    function stopPolling(){
      if (pollTimer){ clearInterval(pollTimer); pollTimer = null; }
    }
    document.addEventListener('visibilitychange', ()=>{
      if (document.hidden) stopPolling();
      else { refreshData(true); startPolling(); }
    });

    // ====== Helpers
    function toast(msg){ toastEl.textContent = msg; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'), 2400); }
    function asArray(v){ return Array.isArray(v) ? v : (v ? [v] : []); }
    function bullets(arr){ return asArray(arr).map(x=>`• ${String(x)}`).join('\n'); }
    function statusChanged(prev, next){
      return String(prev || '').trim() !== String(next || '').trim();
    }
    function londonTodayISO(){
      const fmt = new Intl.DateTimeFormat('en-GB',{timeZone:'Europe/London',year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(new Date());
      const y=fmt.find(p=>p.type==='year').value, m=fmt.find(p=>p.type==='month').value, d=fmt.find(p=>p.type==='day').value;
      return `${y}-${m}-${d}`;
    }
    function salaryText(a){
      const s=a.salary||{};
      if (s.salary_raw) return s.salary_raw;
      if (s.min && s.max) return `${s.currency||''} ${s.min}–${s.max} ${s.period||''}`.trim();
      if (s.min) return `${s.currency||''} ${s.min} ${s.period||''}`.trim();
      return a.salary_raw || a.salary || '';
    }
    function canonicalize(u){
      try{
        const url=new URL(String(u)); url.protocol='https:'; url.hostname=url.hostname.replace(/^www\./i,'').toLowerCase(); url.hash='';
        const keep=new Set(['gh_jid','jobId','vacancyId','rid','id','lever-origin']);
        const q=new URLSearchParams(url.search);
        [...q.keys()].forEach(k=>{const kl=k.toLowerCase(); if(!keep.has(k)||/^utm_/.test(kl)||/(gclid|fbclid|ref|source|src|campaign|medium)$/i.test(kl)) q.delete(k);});
        const sorted=new URLSearchParams(); [...q.keys()].sort().forEach(k=>sorted.append(k,q.get(k)));
        url.search=sorted.toString()?`?${sorted.toString()}`:''; if(url.pathname.length>1) url.pathname=url.pathname.replace(/\/+$/,'');
        return url.toString();
      }catch{return u;}
    }
    async function postForm(url, fd){
      const res = await fetch(url, { method:'POST', body: fd });
      if (!res.ok){ const t=await res.text().catch(()=> ''); console.error('POST',url,res.status,t); throw new Error(`HTTP ${res.status}`); }
      try{ return await res.json(); }catch{ return {}; }
    }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function formatDate(d){ return d ? new Date(d).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'}) : '—'; }

    // ====== Tabs
    function switchTab(name){
      document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.page-content').forEach(p=>p.classList.remove('active'));
      document.getElementById(name+'Tab').classList.add('active');
      document.getElementById(name+'Page').classList.add('active');

      if (name==='applications') renderApplications();
      if (name==='saved') renderSaved();
      if (name==='analytics') renderAnalytics();
      history.replaceState(null,'',`#${name}`);
    }
    analyzeTab.onclick = () => switchTab('analyze');
    applicationsTab.onclick = () => switchTab('applications');
    savedTab.onclick = () => switchTab('saved');
    analyticsTab.onclick = () => switchTab('analytics');
    addTab.onclick = () => switchTab('add');
    if (location.hash==='#applications') switchTab('applications');
    if (location.hash==='#saved') switchTab('saved');
    if (location.hash==='#analytics') switchTab('analytics');
    if (location.hash==='#add') switchTab('add');

    envSelect.onchange = ()=>{ currentEnv = envSelect.value; toast(`Switched to ${currentEnv.toUpperCase()}`); };

    // ====== Analyse flow
    analyzeBtn.onclick = analyseUrl;
    // (No Enter-on-URL listener anymore; we use Cmd/Ctrl+Enter in textarea)

    const MAX_CHARS = 30000;
    jobText.addEventListener('input', () => {
      let v = jobText.value || '';
      if (v.length > MAX_CHARS) {
        jobText.value = v.slice(0, MAX_CHARS);
        toast('Text truncated to 30,000 characters');
      }
      jobCharCount.textContent = `${jobText.value.length} / ${MAX_CHARS}`;
    });

    // Cmd/Ctrl + Enter to analyze
    jobText.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') analyseUrl();
    });

    async function analyseUrl(){
      const text = (jobText.value || '').trim();
      const src = (jobSourceUrl.value || '').trim();
      if (!text) { toast('Please paste the job description'); return; }

      resultCard.style.display='block';
      loadingState.style.display='block';
      resultContent.style.display='none';
      analyzeBtn.disabled = true;

      try{
        const fd = new FormData();
        fd.append('job_text', text);
        if (src) fd.append('source_url', src);

        const data = await postForm(URLS[currentEnv].analyse, fd);
        const out = Array.isArray(data) ? data[0] : data;
        if (!out) throw new Error('No analysis result');
        draft = out; lastCover = null;
        renderAnalysis(out);
      }catch(e){
        console.error(e);
        resultCard.style.display='none';
        toast(`Analysis failed (${currentEnv}). Check n8n & CORS.`);
      }finally{
        analyzeBtn.disabled = false;
      }
    }

    function renderAnalysis(a){
      loadingState.style.display='none'; resultContent.style.display='block';
      const title = a.title || a.job?.title || 'Untitled role';
      const company = a.company_name || a.job?.company_name || '';
      const locs = asArray(a.locations || a.job?.locations).join(' • ');
      const salTxt = salaryText(a);
      const deadline = a.date_deadline || a.job?.date_deadline || '';
      const start = a.start_date || a.job?.start_date || '';
      const url = a.source_url || a.job?.source_url || '';

      jobTitleEl.textContent = title;
      jobCompanyEl.textContent = company;
      jobDetailsEl.innerHTML = `
        <div class="detail-item"><div class="detail-label">Locations</div><div class="detail-value">${escapeHtml(locs || '—')}</div></div>
        <div class="detail-item"><div class="detail-label">Salary</div><div class="detail-value">${escapeHtml(salTxt || '—')}</div></div>
        <div class="detail-item"><div class="detail-label">Dates</div><div class="detail-value">${[start?`Start: ${start}`:'',deadline?`Deadline: ${deadline}`:''].filter(Boolean).join(' · ') || '—'}</div></div>
        <div class="detail-item"><div class="detail-label">URL</div><div class="detail-value">${url?`<a href="${url}" target="_blank" rel="noopener">${escapeHtml(url)}</a>`:'—'}</div></div>
      `;

      const fit = Math.max(0, Math.min(100, Number(a.AI_fit_score ?? 0)));
      const align = Math.max(0, Math.min(100, Number(a.AI_alignment_score ?? 0)));
      fitScoreEl.textContent = `${fit}%`; fitFillEl.style.width=`${fit}%`;
      alignScoreEl.textContent = `${align}%`; alignFillEl.style.width=`${align}%`;

      const kw = asArray(a.keywords || a.job?.keywords);
      keywordsEl.innerHTML = kw.map(k=>`<span class="keyword">${escapeHtml(k)}</span>`).join('');

      fitsEl.textContent = bullets(a.fits || []);
      gapsEl.textContent = bullets(a.gaps || []);
      summaryEl.textContent = a.job_summary || a.summary || '';

      fullDescriptionEl.textContent = a.job_description || '';
      detailsContent.classList.remove('show');
      toggleDetailsBtn.textContent = 'View more';
      toggleDetailsBtn.onclick = ()=>{
        const open = detailsContent.classList.contains('show');
        detailsContent.classList.toggle('show', !open);
        toggleDetailsBtn.textContent = open ? 'View more' : 'Hide';
      };

      saveBtn.onclick = onSave;
      applyBtn.onclick = ()=>{ ratingInputs.classList.add('show'); ratingInputs.setAttribute('aria-hidden','false'); };
      confirmApplyBtn.onclick = onApply;
      ignoreBtn.onclick = ()=>{ resultCard.style.display='none'; draft=null; lastCover=null; toast('Ignored. Nothing saved.'); };
      coverBtn.onclick = onCoverClick;
    }

    // ====== Applications send (to n8n)
    function toApplicationsPayload(a, opts){
      const salary = a.salary || {};
      return {
        source_url: a.source_url || '',
        canonical_job_url: a.canonical_job_url || a.canonical_url || canonicalize(a.source_url || ''),
        title: a.title || '',
        company_name: a.company_name || '',
        seniority: a.seniority || '',
        role_type: a.role_type || '',
        sector: a.sector || '',
        contact_email: a.contact_email || '',
        date_posted: a.date_posted || '',
        date_deadline: a.date_deadline || '',
        start_date: a.start_date || '',
        salary_min: salary.min || '',
        salary_max: salary.max || '',
        salary_currency: salary.currency || '',
        salary_period: salary.period || '',
        salary_raw: salary.salary_raw || a.salary_raw || '',
        locations: Array.isArray(a.locations) ? a.locations : [],
        AI_fit_score: a.AI_fit_score ?? 0,
        AI_alignment_score: a.AI_alignment_score ?? 0,
        AI_cv_filename: a.AI_cv_recommendation?.filename || a.AI_cv_filename || '',
        AI_cv_reason: a.AI_cv_recommendation?.reason || a.AI_cv_reason || '',
        key_requirements: a.key_requirements || [],
        other_requirements: a.other_requirements || [],
        fits: a.fits || [],
        gaps: a.gaps || [],
        job_summary: a.job_summary || '',
        keywords: a.keywords || [],
        job_description: a.job_description || '',
        status: opts.status,
        applied_date: opts.status==='Applied' ? (opts.appliedDate || londonTodayISO()) : '',
        application_effort_rating: opts.effort ?? '',
        application_chance_rating: opts.chance ?? '',
        status_update_date: londonTodayISO(),
        cover_letter_url: a.cover_letter_url ?? ''
      };
    }
    async function sendApplications(env, payload){
      const fd = new FormData();
      for (const [k,v] of Object.entries(payload)){
        if (Array.isArray(v)) fd.append(k, JSON.stringify(v));
        else fd.append(k, v==null ? '' : String(v));
      }
      return postForm(URLS[env].applications, fd);
    }

    async function onSave(){
      if (!draft) return;
      try{
        const payload = toApplicationsPayload(draft, { status:'Saved' });
        await sendApplications(currentEnv, payload);
        toast('Saved for later ✅');
        await refreshData(true);
      }catch(e){ console.error(e); toast(`Save failed (${currentEnv})`); }
    }

    async function onApply(){
      if (!draft) return;
      try{
        const effort = Number(effortInput.value);
        const chance = Number(chanceInput.value);
        const payload = toApplicationsPayload(draft, {
          status:'Applied',
          effort: Number.isFinite(effort)?effort:'',
          chance: Number.isFinite(chance)?chance:'',
          appliedDate: londonTodayISO()
        });
        await sendApplications(currentEnv, payload);
        toast('Marked as applied 🎉');
        ratingInputs.classList.remove('show'); ratingInputs.setAttribute('aria-hidden','true');
        await refreshData(true);
      }catch(e){ console.error(e); toast(`Apply failed (${currentEnv})`); }
    }

    // ====== Cover letter & CV
    async function onCoverClick(){
      if (!draft) return toast('Analyse a job first');
      coverSection.classList.add('show');
      coverContent.classList.remove('show');
      coverStatus.innerHTML = '<span class="spinner"></span> Preparing cover letter & CV tips…';
      try{
        const fd = new FormData();
        fd.append('job_json', JSON.stringify(draft));
        if (CV_FOLDER_ID) fd.append('cv_folder_id', CV_FOLDER_ID);
        if (GUIDE_DOC_ID) fd.append('guide_doc_id', GUIDE_DOC_ID);
        const data = await postForm(URLS[currentEnv].cover, fd);
        lastCover = Array.isArray(data) ? data[0] : data || {};
        const cv = lastCover.selected_cv || {};
        const tweaks = Array.isArray(lastCover.cv_tweaks) ? lastCover.cv_tweaks : [];
        const letter = lastCover.cover_letter || {};

        cvNameEl.textContent = cv.filename || '—';
        cvWhyEl.textContent = cv.reason || '—';
        const link = letter.doc_url || cv.doc_url;
        coverDocLinkEl.innerHTML = link ? `<a href="${link}" target="_blank" rel="noopener">${escapeHtml(link)}</a>` : '—';
        cvTweaksEl.textContent = tweaks.length ? bullets(tweaks) : 'No tweaks suggested.';
        coverPreviewEl.textContent = letter.plain_text || (letter.html ? letter.html : 'No preview provided.');
        if (link){ openDocBtn.style.display='inline-flex'; openDocBtn.onclick = ()=>window.open(link,'_blank','noopener'); }
        else openDocBtn.style.display='none';
        copyCoverBtn.onclick = async ()=>{ try{ await navigator.clipboard.writeText(letter.plain_text || letter.html || ''); toast('Cover letter copied'); }catch{ toast('Copy failed'); } };

        coverStatus.textContent = 'Generated ✓';
        coverContent.classList.add('show');
      }catch(e){ console.error(e); coverStatus.textContent = 'Generation failed. Check n8n logs / CORS.'; }
    }

    // ====== Applications page
    statusFilter.onchange = renderApplications;
    sortFilter.onchange = renderApplications;

    function renderApplications(){
      let arr = [...applicationsList];
      const s = statusFilter.value;
      if (s!=='all') arr = arr.filter(a=>a.status===s);
      const sort = sortFilter.value;
      if (sort==='date-desc') arr.sort((a,b)=> new Date(b.appliedDate||'2000-01-01') - new Date(a.appliedDate||'2000-01-01'));
      if (sort==='date-asc')  arr.sort((a,b)=> new Date(a.appliedDate||'2000-01-01') - new Date(b.appliedDate||'2000-01-01'));
      if (sort==='fit-desc')  arr.sort((a,b)=> (b.fitScore||0) - (a.fitScore||0));
      if (sort==='company')   arr.sort((a,b)=> (a.company||'').localeCompare(b.company||''));

      applicationsGrid.innerHTML = arr.map(app => cardHTML(app)).join('');
    }

    function cardHTML(app){
      return `
        <div class="application-card" onclick="openApplicationModal('${app.id}')">
          <div class="application-status status-${app.status}">${escapeHtml(app.status)}</div>
          <div class="application-header">
            <div class="application-title">${escapeHtml(app.title)}</div>
            <div class="application-company">${escapeHtml(app.company)}</div>
            <div class="application-date">${app.appliedDate ? `Applied: ${formatDate(app.appliedDate)}` : 'Saved for later'}</div>
          </div>
          <div class="application-scores">
            <div class="mini-score"><div class="mini-score-label">Fit</div><div class="mini-score-value">${app.fitScore ?? 0}%</div></div>
            <div class="mini-score"><div class="mini-score-label">Align</div><div class="mini-score-value">${app.alignmentScore ?? 0}%</div></div>
          </div>
          <div class="application-meta">
            <div>${escapeHtml(app.location || '—')}</div>
            <div style="font-weight:800">${escapeHtml(app.salary || '—')}</div>
          </div>
          <div style="margin-top:.6rem; display:flex; gap:.5rem;">
            <button class="btn btn-primary btn-sm"
              onclick="event.stopPropagation(); openEditModal('${app.id}')">
              ✏️ Edit
            </button>
            <button class="btn btn-danger btn-sm"
              onclick="event.stopPropagation(); requestDelete('${app.id}', 'applied')">
              🗑️ Delete
            </button>
          </div>
        </div>
      `;
    }

    window.openApplicationModal = function(id){
      let app = applicationsList.find(a=>a.id===id);
      if (!app) app = appsLive.saved.map(toCardShape).find(a=>a.id===id);
      if (!app) return;
      modalTitle.textContent = app.title;
      modalBody.innerHTML = `
        <div class="job-header">
          <div class="job-company" style="margin-bottom:1rem">${escapeHtml(app.company)}</div>
          <div class="job-details">
            <div class="detail-item"><div class="detail-label">Status</div><div class="detail-value"><span class="application-status status-${app.status}">${app.status}</span></div></div>
            <div class="detail-item"><div class="detail-label">Location</div><div class="detail-value">${escapeHtml(app.location||'—')}</div></div>
            <div class="detail-item"><div class="detail-label">Salary</div><div class="detail-value">${escapeHtml(app.salary||'—')}</div></div>
            <div class="detail-item"><div class="detail-label">Source</div><div class="detail-value">${escapeHtml(app.source||'—')}</div></div>
          </div>
        </div>
        <div class="scores-section">
          <div class="score-card"><div class="score-label">AI Fit</div><div class="score-value">${app.fitScore ?? 0}%</div><div class="score-bar"><div class="score-fill" style="width:${app.fitScore ?? 0}%"></div></div></div>
          <div class="score-card"><div class="score-label">Alignment</div><div class="score-value">${app.alignmentScore ?? 0}%</div><div class="score-bar"><div class="score-fill" style="width:${app.alignmentScore ?? 0}%"></div></div></div>
        </div>
        ${Number.isFinite(app.effortRating) ? `
          <div class="columns" style="margin-bottom:1rem">
            <div class="column"><h3>Effort rating</h3><div class="score-value" style="font-size:1.4rem">${app.effortRating}/10</div></div>
            <div class="column"><h3>Chance rating</h3><div class="score-value" style="font-size:1.4rem">${app.chanceRating}/10</div></div>
          </div>`:``}
        <div class="columns">
          <div class="column"><h3>✅ Fits</h3><div class="list-content">${bullets(app.fits||[]).replace(/\n/g,'<br/>')}</div></div>
          <div class="column"><h3>⚠️ Gaps</h3><div class="list-content">${bullets(app.gaps||[]).replace(/\n/g,'<br/>')}</div></div>
        </div>
        <div class="section"><h3 class="section-title">Job description</h3><div class="summary"><div>${escapeHtml(app.description||'')}</div></div></div>
        <div class="section"><h3 class="section-title">Requirements</h3><div class="keywords">${asArray(app.requirements).map(r=>`<span class="keyword">${escapeHtml(r)}</span>`).join('')}</div></div>
      `;
      modalBody.innerHTML += `
        <div style="display:flex;gap:.5rem;margin-top:1rem">
          <button class="btn btn-primary" id="editBtn">Edit</button>
        </div>
      `;
      document.getElementById('editBtn').onclick = ()=> openEditModal(id);
      modal.classList.add('show'); modal.setAttribute('aria-hidden','false');
    };

    function openEditModal(id){
      const raw = getRawRowById(id);
      if (!raw){ toast('Could not load item'); return; }

      const card = toCardShape(raw);
      const prevStatus = raw.status || (card.status==='applied' ? 'Applied' : 'Saved');

      modalTitle.textContent = `Edit: ${raw.title || 'Untitled role'}`;
      modalBody.innerHTML = `
        <form id="editForm" class="form-grid">
          <!-- identifiers (used by n8n to upsert) -->
          <input type="hidden" name="application_id" value="${escapeHtml(raw.application_id || '')}"/>
          <input type="hidden" name="canonical_job_url" value="${escapeHtml(raw.canonical_job_url || '')}"/>
          <input type="hidden" name="source_url" value="${escapeHtml(raw.source_url || '')}"/>
          <input type="hidden" name="__prev_status" value="${escapeHtml(prevStatus)}"/>

          <div class="form-field"><label>Status</label>
            <select name="status">
              <option ${prevStatus==='Saved'?'selected':''}>Saved</option>
              <option ${prevStatus==='Applied'?'selected':''}>Applied</option>
            </select>
          </div>

          <div class="form-field"><label>Title</label>
            <input name="title" value="${escapeHtml(raw.title||'')}"/>
          </div>
          <div class="form-field"><label>Company</label>
            <input name="company_name" value="${escapeHtml(raw.company_name||'')}"/>
          </div>
          <div class="form-field"><label>Locations (comma)</label>
            <input name="locations" value="${escapeHtml(Array.isArray(raw.locations)? raw.locations.join(', ') : (raw.locations||''))}"/>
          </div>

          <div class="form-field"><label>Applied date (YYYY-MM-DD)</label>
            <input name="applied_date" value="${escapeHtml(raw.applied_date||'')}"/>
            <div class="help">If status becomes “Applied” and this is blank, we’ll set today (London).</div>
          </div>

          <div class="form-field"><label>Salary min</label>
            <input name="salary_min" type="number" value="${escapeHtml(raw.salary_min||'')}"/>
          </div>
          <div class="form-field"><label>Salary max</label>
            <input name="salary_max" type="number" value="${escapeHtml(raw.salary_max||'')}"/>
          </div>
          <div class="form-field"><label>Currency</label>
            <input name="salary_currency" value="${escapeHtml(raw.salary_currency||'')}"/>
          </div>
          <div class="form-field"><label>Period</label>
            <input name="salary_period" value="${escapeHtml(raw.salary_period||'')}"/>
          </div>

          <div class="form-field"><label>AI Fit %</label>
            <input name="AI_fit_score" type="number" min="0" max="100" value="${escapeHtml(raw.AI_fit_score||0)}"/>
          </div>
          <div class="form-field"><label>AI Alignment %</label>
            <input name="AI_alignment_score" type="number" min="0" max="100" value="${escapeHtml(raw.AI_alignment_score||0)}"/>
          </div>
          <div class="form-field"><label>Effort /10</label>
            <input name="application_effort_rating" type="number" min="0" max="10" step="1" value="${escapeHtml(raw.application_effort_rating ?? '')}"/>
          </div>
          <div class="form-field"><label>Chance /10</label>
            <input name="application_chance_rating" type="number" min="0" max="10" step="1" value="${escapeHtml(raw.application_chance_rating ?? '')}"/>
          </div>

          <div class="form-field" style="grid-column:1/-1"><label>Fits (semicolon)</label>
            <input name="fits" value="${escapeHtml(Array.isArray(raw.fits)? raw.fits.join('; ') : (raw.fits||''))}"/>
          </div>
          <div class="form-field" style="grid-column:1/-1"><label>Gaps (semicolon)</label>
            <input name="gaps" value="${escapeHtml(Array.isArray(raw.gaps)? raw.gaps.join('; ') : (raw.gaps||''))}"/>
          </div>
          <div class="form-field" style="grid-column:1/-1"><label>Keywords (comma)</label>
            <input name="keywords" value="${escapeHtml(Array.isArray(raw.keywords)? raw.keywords.join(', ') : (raw.keywords||''))}"/>
          </div>

          <div class="form-field" style="grid-column:1/-1"><label>Summary</label>
            <textarea name="job_summary" rows="3">${escapeHtml(raw.job_summary||'')}</textarea>
          </div>
          <div class="form-field" style="grid-column:1/-1"><label>Description</label>
            <textarea name="job_description" rows="6">${escapeHtml(raw.job_description||'')}</textarea>
          </div>

          <div class="hr"></div>
          <div style="display:flex;gap:.5rem;flex-wrap:wrap">
            <button class="btn btn-primary" type="submit">Save changes</button>
            <button class="btn btn-outline" type="button" id="cancelEdit">Cancel</button>
          </div>
        </form>
      `;

      document.getElementById('cancelEdit').onclick = closeModal;

      document.getElementById('editForm').onsubmit = async (e)=>{
        e.preventDefault();
        const fd = new FormData(e.target);

        // Read + normalise list inputs → JSON string arrays for n8n
        const toArray = (s, splitOn) => (s||'').split(splitOn).map(x=>x.trim()).filter(Boolean);
        const locations = JSON.stringify(toArray(fd.get('locations'), ','));
        const fits      = JSON.stringify(toArray(fd.get('fits'), ';'));
        const gaps      = JSON.stringify(toArray(fd.get('gaps'), ';'));
        const keywords  = JSON.stringify(toArray(fd.get('keywords'), ','));

        // Status-change logic
        const newStatus = fd.get('status') || 'Saved';
        const oldStatus = fd.get('__prev_status') || '';
        const changed = statusChanged(oldStatus, newStatus);

        // applied_date guard when becoming Applied
        let appliedDate = fd.get('applied_date') || '';
        if (newStatus === 'Applied' && !appliedDate) {
          appliedDate = londonTodayISO();
        }

        // Build payload expected by /updater (all fields in body.*)
        const payload = new FormData();
        const fields = {
          application_id: fd.get('application_id') || '',
          canonical_job_url: fd.get('canonical_job_url') || '',
          source_url: fd.get('source_url') || '',

          title: fd.get('title') || '',
          company_name: fd.get('company_name') || '',
          status: newStatus,

          locations, fits, gaps, keywords,

          salary_min: fd.get('salary_min') || '',
          salary_max: fd.get('salary_max') || '',
          salary_currency: fd.get('salary_currency') || '',
          salary_period: fd.get('salary_period') || '',

          AI_fit_score: fd.get('AI_fit_score') || 0,
          AI_alignment_score: fd.get('AI_alignment_score') || 0,
          application_effort_rating: fd.get('application_effort_rating') || '',
          application_chance_rating: fd.get('application_chance_rating') || '',

          applied_date: appliedDate,
          // Only stamp when status actually changed:
          status_update_date: changed ? londonTodayISO() : '',

          job_summary: fd.get('job_summary') || '',
          job_description: fd.get('job_description') || '',
          cover_letter_url: raw.cover_letter_url || ''
        };

        Object.entries(fields).forEach(([k,v]) => payload.append(k, v));

        try{
          const res = await fetch(URLS[currentEnv].update, { method:'POST', body: payload });
          if (!res.ok) throw new Error('HTTP '+res.status);
          await res.json().catch(()=> ({}));
          toast('Saved changes ✓');
          closeModal();
          await refreshData(true);
        }catch(err){
          console.error(err);
          toast('Failed to save changes');
        }
      };

      modal.classList.add('show'); modal.setAttribute('aria-hidden','false');
    }
    function closeModal(){ modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); }
    modalOverlay.onclick = closeModal; modalClose.onclick = closeModal; document.addEventListener('keydown',(e)=>{ if (e.key==='Escape' && modal.classList.contains('show')) closeModal(); });

    // subtle modal pop
    const modalContent = document.querySelector('#applicationModal .modal-content');
    document.addEventListener('click', (e)=>{
      if (modal.classList.contains('show') && modalContent){
        modalContent.style.transform = 'scale(1.0)';
        modalContent.style.transition = 'transform 180ms ease';
        requestAnimationFrame(()=> modalContent.style.transform = 'scale(1.0)'); // noop but keeps API hookable
      }
    });

    // ====== Saved page
    savedSort.onchange = renderSaved;
    function renderSaved(){
      let arr = appsLive.saved.map(toCardShape);
      const s = savedSort.value;
      if (s==='date-desc') arr.sort((a,b)=> new Date(b.appliedDate||'2000-01-01') - new Date(a.appliedDate||'2000-01-01'));
      if (s==='fit-desc')  arr.sort((a,b)=> (b.fitScore||0)-(a.fitScore||0));
      if (s==='company')   arr.sort((a,b)=> (a.company||'').localeCompare(b.company||''));
      savedGrid.innerHTML = arr.map(app => `
        <div class="application-card">
          <div class="application-status status-${app.status}">${escapeHtml(app.status)}</div>
          <div class="application-title">${escapeHtml(app.title)}</div>
          <div class="application-company">${escapeHtml(app.company)}</div>
          <div class="application-meta"><div>${escapeHtml(app.location||'—')}</div><div>${escapeHtml(app.salary||'—')}</div></div>
          <div style="display:flex;gap:.5rem;margin-top:.6rem;flex-wrap:wrap">
            <button class="btn btn-primary btn-sm" onclick="openApplicationModal('${app.id}')">View</button>
            <button class="btn btn-primary btn-sm" onclick="openEditModal('${app.id}')">✏️ Edit</button>
            <button class="btn btn-success btn-sm" onclick="markSavedApplied('${app.id}')">Mark applied</button>
            <button class="btn btn-danger btn-sm" onclick="requestDelete('${app.id}', 'saved')">🗑️ Delete</button>
          </div>
        </div>
      `).join('');
    }
    window.markSavedApplied = async function(id){
      const app = appsLive.saved.map(toCardShape).find(a=>a.id===id);
      if (!app) return;
      try{
        const payload = {
          source_url:'',
          canonical_job_url:'',
          title: app.title, company_name: app.company,
          seniority:'', role_type:'', sector:'', contact_email:'',
          date_posted:'', date_deadline:'', start_date:'',
          salary_min:'', salary_max:'', salary_currency:'', salary_period:'', salary_raw:app.salary||'',
          locations: asArray(app.location ? app.location.split(' • ') : []),
          AI_fit_score: app.fitScore || 0,
          AI_alignment_score: app.alignmentScore || 0,
          AI_cv_filename:'', AI_cv_reason:'',
          key_requirements: asArray(app.requirements||[]),
          other_requirements: [],
          fits: asArray(app.fits||[]),
          gaps: asArray(app.gaps||[]),
          job_summary:'', keywords: [],
          job_description: app.description || '',
          status: 'Applied',
          applied_date: londonTodayISO(),
          application_effort_rating: app.effortRating ?? '',
          application_chance_rating: app.chanceRating ?? '',
          status_update_date: londonTodayISO(),
          cover_letter_url:''
        };
        await sendApplications(currentEnv, payload);
        toast('Marked applied ✅');
        await refreshData(true);
      }catch(e){ console.error(e); toast('Failed to update n8n'); }
    };

    window.requestDelete = function(id, sourceHint){
      // Try Applications first
      let app = applicationsList.find(a=>a.id===id);
      if (!app && (sourceHint && String(sourceHint).toLowerCase() === 'saved')){
        // Pull from saved live list
        app = appsLive.saved.map(toCardShape).find(a=>a.id===id);
      }
      if (!app){
        // Fallback: search both collections
        app = (appsLive.applied.map(toCardShape).find(a=>a.id===id)
          || appsLive.saved.map(toCardShape).find(a=>a.id===id));
      }
      if (!app){ toast('Could not find that item in the UI'); return; }
      openDeleteConfirm(app, sourceHint);
    };

    // ====== Analytics page
    analyticsRange.onchange = renderAnalytics;

    function filterByRange(list, days){
      if (days==='all') return list;
      const cutoff = new Date(); cutoff.setDate(cutoff.getDate()-Number(days));
      return list.filter(a => {
        const d = a.appliedDate || a.createdDate;
        return d ? new Date(d) >= cutoff : true; // keep saved ones
      });
    }

    function destroyChart(c){ if (c) { c.destroy(); } }

    function renderAnalytics(){
      const range = analyticsRange.value;
      const flat = [
        ...appsLive.applied.map(toCardShape),
        ...appsLive.saved.map(toCardShape)
      ];
      const data = filterByRange(flat, range);

      // KPIs
      const total = data.length;
      const applied = data.filter(a=>a.status==='applied').length;
      const responses = data.filter(a=>a.status==='response').length;
      const avgFit = Math.round(data.reduce((s,a)=>s + (a.fitScore||0),0) / (total || 1));
      kpiTotal.textContent = String(total);
      kpiApplied.textContent = String(applied);
      kpiResponses.textContent = String(responses);
      kpiAvgFit.textContent = `${avgFit}%`;

      // Prepare aggregates
      const byStatus = data.reduce((m,a)=> (m[a.status]=(m[a.status]||0)+1, m), {});
      const fitBuckets = { '0–49':0,'50–69':0,'70–84':0,'85–100':0 };
      data.forEach(a=>{
        const f = a.fitScore||0;
        if (f<50) fitBuckets['0–49']++; else if (f<70) fitBuckets['50–69']++; else if (f<85) fitBuckets['70–84']++; else fitBuckets['85–100']++;
      });
      const byCompany = data.reduce((m,a)=> (m[a.company]=(m[a.company]||0)+1, m), {});
      const topCompanies = Object.entries(byCompany).sort((a,b)=>b[1]-a[1]).slice(0,7);

      const byMonth = {};
      data.forEach(a=>{
        const d = a.appliedDate || a.createdDate;
        if (!d) return;
        const month = new Date(d).toISOString().slice(0,7);
        byMonth[month] = (byMonth[month]||0)+1;
      });
      const monthsSorted = Object.keys(byMonth).sort();

      // Charts
      const ctxStatus = document.getElementById('chartStatus').getContext('2d');
      const ctxFit = document.getElementById('chartFitDist').getContext('2d');
      const ctxCompany = document.getElementById('chartCompany').getContext('2d');
      const ctxTrend = document.getElementById('chartTrend').getContext('2d');

      destroyChart(chartStatus); destroyChart(chartFitDist); destroyChart(chartCompany); destroyChart(chartTrend);

      chartStatus = new Chart(ctxStatus,{
        type:'pie',
        data:{ labels:Object.keys(byStatus), datasets:[{ data:Object.values(byStatus) }] },
        options:{ plugins:{ legend:{ position:'bottom' }, title:{ display:true, text:'By status' } } }
      });

      chartFitDist = new Chart(ctxFit,{
        type:'bar',
        data:{ labels:Object.keys(fitBuckets), datasets:[{ data:Object.values(fitBuckets) }] },
        options:{ plugins:{ legend:{ display:false }, title:{ display:true, text:'Fit score distribution' } }, scales:{ y:{ beginAtZero:true } } }
      });

      chartCompany = new Chart(ctxCompany,{
        type:'bar',
        data:{ labels:topCompanies.map(x=>x[0]), datasets:[{ data:topCompanies.map(x=>x[1]) }] },
        options:{ plugins:{ legend:{ display:false }, title:{ display:true, text:'Top companies applied/saved' } }, indexAxis:'y', scales:{ x:{ beginAtZero:true } } }
      });

      chartTrend = new Chart(ctxTrend,{
        type:'line',
        data:{ labels:monthsSorted, datasets:[{ data:monthsSorted.map(m=>byMonth[m]), tension:.3, fill:false }] },
        options:{ plugins:{ legend:{ display:false }, title:{ display:true, text:'Applications over time' } }, scales:{ y:{ beginAtZero:true } } }
      });
    }

    // ====== Add application page
    addForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(addForm);
      // Build payload in the format your n8n expects
      const status = fd.get('status') || 'Saved';
      const payload = {
        source_url: fd.get('source_url') || '',
        canonical_job_url: canonicalize(fd.get('source_url') || ''),
        title: fd.get('title') || '',
        company_name: fd.get('company_name') || '',
        seniority:'', role_type:'', sector:'', contact_email:'',
        date_posted:'', date_deadline:'', start_date:'',
        salary_min: fd.get('salary_min') || '',
        salary_max: fd.get('salary_max') || '',
        salary_currency: fd.get('salary_currency') || '',
        salary_period: fd.get('salary_period') || '',
        salary_raw: '',
        locations: (fd.get('locations')||'').split(',').map(s=>s.trim()).filter(Boolean),
        AI_fit_score: Number(fd.get('AI_fit_score')||0),
        AI_alignment_score: Number(fd.get('AI_alignment_score')||0),
        AI_cv_filename:'', AI_cv_reason:'',
        key_requirements: [],
        other_requirements: [],
        fits: (fd.get('fits')||'').split(';').map(s=>s.trim()).filter(Boolean),
        gaps: (fd.get('gaps')||'').split(';').map(s=>s.trim()).filter(Boolean),
        job_summary: fd.get('job_summary')||'',
        keywords: (fd.get('keywords')||'').split(',').map(s=>s.trim()).filter(Boolean),
        job_description: fd.get('job_description')||'',
        status,
        applied_date: status==='Applied' ? (fd.get('applied_date')||londonTodayISO()) : '',
        application_effort_rating: fd.get('application_effort_rating')||'',
        application_chance_rating: fd.get('application_chance_rating')||'',
        status_update_date: londonTodayISO(),
        cover_letter_url:''
      };
      try{
        await sendApplications(currentEnv, payload);
        toast('Saved to n8n ✅');
        addForm.reset();
        await refreshData(true);
      }catch(e){ console.error(e); toast('Failed to save to n8n'); }
    });

    addMockBtn.onclick = ()=>{
      const id = String(Date.now());
      applicationsList.push({
        id, title:'Example role', company:'Example Co', status:'saved', appliedDate:null, location:'Remote',
        salary:'£30,000 - £35,000', fitScore:80, alignmentScore:87, source:'Manual',
        description:'Example description…', requirements:['Req A','Req B'], fits:['Fit A'], gaps:['Gap A'],
        effortRating:null, chanceRating:null, createdDate:londonTodayISO()
      });
      toast('Added locally');
      renderSaved(); renderAnalytics();
    };

    // ====== Init renders
    (async ()=>{ await refreshData(); startPolling(); })();

    // ====== Analyse button disables loading skeleton on first view
    document.addEventListener('DOMContentLoaded',()=>{
      currentEnv = envSelect.value;
    });
  </script>
</body>
</html>
