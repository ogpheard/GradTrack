<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Grad Tracker</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; }
    .row { display: grid; gap: 8px; margin: 12px 0; max-width: 560px; }
    input[type=text] { padding: 8px; border: 1px solid #ccc; border-radius: 8px; }
    button { padding: 8px 14px; border-radius: 8px; border: 1px solid #888; cursor: pointer; }
    button[disabled] { opacity: .6; cursor: not-allowed; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; margin: 8px 0; }
    .muted { color: #666; font-size: 12px; }
    #debug { white-space: pre-wrap; background:#fafafa; border:1px dashed #ddd; padding:10px; border-radius:8px; margin-top:16px; }
    .ok { color: #0a7; }
    .err { color: #c00; }
  </style>
</head>
<body>
  <h1>Grad Tracker</h1>

  <div id="auth">
    <button id="signin">Sign in with Google</button>
    <button id="signout" style="display:none;">Sign out</button>
    <span id="who" class="muted"></span>
  </div>

  <hr/>

  <h2>Add job</h2>
  <div class="row" id="form">
    <label>Title<br><input id="title" type="text" placeholder="e.g. Graduate Analyst"></label>
    <label>Company<br><input id="company" type="text" placeholder="e.g. Alpha FMC"></label>
    <label>Job URL<br><input id="url" type="text" placeholder="https://..."></label>
    <label><input id="applied" type="checkbox"> Applied</label>
    <div>
      <button id="add" type="button">Add</button>
      <span id="add-msg" class="muted"></span>
    </div>
    <div>
      <button id="verify" type="button" style="display:none;">Verify last insert</button>
      <span id="verify-msg" class="muted"></span>
    </div>
  </div>

  <h2>Your jobs</h2>
  <div id="jobs"></div>

  <h3>Debug info</h3>
  <div id="debug"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // --- CONFIG (yours, already filled) ---
    const SUPABASE_URL = "https://kudqgnpkznshcyvrwrpj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt1ZHFnbnBrem5zaGN5dnJ3cnBqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5NzY0MDcsImV4cCI6MjA3MjU1MjQwN30.mPK21uGKyBtgvWL0vl80l9bLG9SWoXDbnYAjPbPNn74";

    // --- Helpers ---
    const el = (id) => document.getElementById(id);
    const debug = el("debug");
    const log = (...args) => {
      console.log(...args);
      debug.textContent += args.map(a => (typeof a === "string" ? a : JSON.stringify(a, null, 2))).join(" ") + "\n";
    };

    // show initial url bits
    log("Host:", location.origin);
    log("Pathname:", location.pathname);
    log("Search:", location.search || "(none)");
    log("Hash:", location.hash || "(none)");

    // --- Supabase ---
    const supabase = supabasejs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, detectSessionInUrl: false } // we’ll handle the #tokens manually
    });

    // Handle #access_token / #refresh_token from Google redirect (implicit flow)
    (async function handleHashSession() {
      try {
        if (location.hash.includes("access_token=") && location.hash.includes("refresh_token=")) {
          const params = new URLSearchParams(location.hash.slice(1));
          const access_token = params.get("access_token");
          const refresh_token = params.get("refresh_token");
          if (access_token && refresh_token) {
            const { data, error } = await supabase.auth.setSession({ access_token, refresh_token });
            log("[setSession] error?", error || "none");
            // Clean the URL back to your page root
            const returnUrl = location.origin + location.pathname;
            history.replaceState({}, "", returnUrl);
            log("Return URL set to:", returnUrl);
          }
        }
      } catch (e) {
        log("handleHashSession error:", e.message || e);
      } finally {
        boot();
      }
    })();

    // Global state
    let lastInsertedId = null;

    async function boot() {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        log("[boot] session?", !!session);
        updateAuthUI(session);
        if (session) await loadJobs();
      } catch (e) {
        log("boot error:", e.message || e);
      }
    }

    function updateAuthUI(session) {
      if (session?.user) {
        el("signin").style.display = "none";
        el("signout").style.display = "inline-block";
        el("who").textContent = `Signed in as ${session.user.email}`;
      } else {
        el("signin").style.display = "inline-block";
        el("signout").style.display = "none";
        el("who").textContent = "";
        el("jobs").innerHTML = "";
      }
    }

    // Auth buttons
    el("signin").onclick = async () => {
      const redirectTo = location.origin + location.pathname; // back to this page
      const { error } = await supabase.auth.signInWithOAuth({
        provider: "google",
        options: {
          redirectTo,
          queryParams: { prompt: "select_account" }
        }
      });
      if (error) log("signIn error:", error.message);
    };

    el("signout").onclick = async () => {
      await supabase.auth.signOut();
      updateAuthUI(null);
      el("jobs").innerHTML = "";
      log("Signed out.");
    };

    // Load your rows
    async function loadJobs() {
      el("jobs").innerHTML = "<div class='muted'>Loading…</div>";

      const { data: { user }, error: uerr } = await supabase.auth.getUser();
      if (uerr || !user) {
        el("jobs").innerHTML = "<div class='muted'>Sign in to see your jobs.</div>";
        return;
      }

      const { data, error } = await supabase
        .from("graduate_job_helper")
        .select("application_id, title, company_name, canonical_job_url, status, applied_date, status_update_date")
        .eq("user_id", user.id)
        .order("status_update_date", { ascending: false, nullsFirst: true })
        .limit(50);

      if (error) {
        el("jobs").innerHTML = `<div class='err'>Load failed: ${error.message}</div>`;
        log("loadJobs error:", error.message);
        return;
      }

      if (!data || data.length === 0) {
        el("jobs").innerHTML = "<div class='muted'>No jobs yet. Add one above.</div>";
        return;
      }

      el("jobs").innerHTML = data.map(row => {
        const when = row.applied_date || row.status_update_date || "";
        return `
          <div class="card">
            <div><strong>${row.title || "(no title)"} </strong> @ ${row.company_name || ""}</div>
            <div class="muted">${row.status || ""} ${when ? " • " + when : ""}</div>
            <div><a href="${row.canonical_job_url}" target="_blank" rel="noopener">Open</a></div>
            <div class="muted">ID: ${row.application_id}</div>
          </div>
        `;
      }).join("");
    }

    // ADD job (robust: try/catch/finally + always re-enable)
    el("add").onclick = async () => {
      el("add").disabled = true;
      el("add-msg").textContent = "";
      el("verify").style.display = "none";
      el("verify-msg").textContent = "";
      lastInsertedId = null;

      try {
        const title   = el("title").value.trim();
        const company = el("company").value.trim();
        const url     = el("url").value.trim();
        const applied = el("applied").checked;

        if (!title || !company || !url) {
          el("add-msg").textContent = "Please fill Title, Company and Job URL.";
          return;
        }

        const { data: { user }, error: uerr } = await supabase.auth.getUser();
        if (uerr || !user) {
          el("add-msg").textContent = "You must be signed in.";
          return;
        }

        const row = {
          title,
          company_name: company,
          canonical_job_url: url,
          status: applied ? "Applied" : "Saved",
          applied_date: applied ? new Date().toISOString().slice(0,10) : null,
          user_id: user.id
        };

        const { data: inserted, error } = await supabase
          .from("graduate_job_helper")
          .insert(row)
          .select("application_id")
          .single();

        if (error) {
          el("add-msg").innerHTML = `<span class="err">Add failed: ${error.message}</span>`;
          log("Insert error:", error);
          return;
        }

        lastInsertedId = inserted.application_id;
        el("add-msg").innerHTML = `<span class="ok">Added (id: ${lastInsertedId}).</span>`;
        el("verify").style.display = "inline-block";

        // clear inputs
        el("title").value = "";
        el("company").value = "";
        el("url").value = "";
        el("applied").checked = false;

        await loadJobs();
      } catch (e) {
        el("add-msg").innerHTML = `<span class="err">Unexpected error: ${e.message || e}</span>`;
        log("Add handler crash:", e);
      } finally {
        el("add").disabled = false; // ALWAYS re-enable button
      }
    };

    // Verify last insert
    el("verify").onclick = async () => {
      el("verify-msg").textContent = "";
      if (!lastInsertedId) {
        el("verify-msg").textContent = "No recent insert to verify.";
        return;
      }
      const { data, error } = await supabase
        .from("graduate_job_helper")
        .select("application_id, title, company_name, status, user_id")
        .eq("application_id", lastInsertedId);
      if (error) {
        el("verify-msg").innerHTML = `<span class="err">Verify failed: ${error.message}</span>`;
      } else if (data && data.length === 1) {
        el("verify-msg").innerHTML = `<span class="ok">Verified in DB: ${data[0].application_id} (${data[0].title} @ ${data[0].company_name})</span>`;
      } else {
        el("verify-msg").textContent = "Row not found (RLS or it wasn’t inserted).";
      }
    };

    // Extra: show any window errors in debug
    window.addEventListener("error", (e) => {
      log("Window error:", e.message);
    });
  </script>
</body>
</html>
