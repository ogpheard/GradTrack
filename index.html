<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Graduate Applications Tracker — v12</title>

  <!-- Fonts & libs -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>

  <!-- Firebase (compat for widest support) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    :root{
      /* Light theme */
      --bg:#f7f7fb; --card:#ffffff; --muted:#64748b; --text:#0f172a;
      --accent1:#4f46e5; --accent2:#06b6d4; --shadow:0 6px 18px rgba(15,23,42,.08);
      --radius:16px; --border:#e5e7eb; --border-strong:#d1d5db; --chip:#f1f5f9;

      /* Status colours */
      --applied:#2563eb;
      --online:#06b6d4;            /* Online Assessment */
      --video:#10b981;             /* Video Interview */
      --centre:#f59e0b;            /* Assessment Centre */
      --final:#7c3aed;             /* Final Interview */
      --offer:#7c3aed;             /* Offer (kept purple family) */
      --rejected:#dc2626;
      --ghosted:#6b7280;

      /* Chance colours (Very Low → Very High) */
      --chance1:#ef4444; --chance2:#f59e0b; --chance3:#f59e0b; --chance4:#10b981; --chance5:#16a34a;

      /* Chart colours */
      --bar:#4f46e5;        /* coloured bars (requested) */
      --line:#0ea5e9;
    }

    *{ box-sizing:border-box } html,body{ height:100% }
    body{ margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--text); background:var(--bg) }

    .app{ max-width:1200px; margin:28px auto; padding:0 20px 40px }
    header.appbar{ display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:20px }
    .logo{ display:flex; align-items:center; gap:14px }
    .logo .dot{ width:12px; height:12px; border-radius:50%; background:linear-gradient(135deg,var(--accent1),var(--accent2)); box-shadow:0 0 0 6px rgba(79,70,229,.10),0 0 0 12px rgba(6,182,212,.08) }
    h1{ font-size:clamp(22px,3vw,30px); margin:0; font-weight:800; letter-spacing:.3px }
    .sub{ color:var(--muted); font-size:14px }

    .controls{ display:flex; flex-wrap:wrap; gap:10px; align-items:center }
    button,.btn{ background:linear-gradient(135deg,#ffffff,#f8fafc); border:1px solid var(--border);
      color:var(--text); padding:10px 14px; border-radius:12px; font-weight:600; cursor:pointer;
      transition:transform .06s ease, box-shadow .2s ease, border-color .2s ease; box-shadow:0 2px 0 rgba(15,23,42,.03) }
    button:hover{ transform:translateY(-1px); border-color:var(--border-strong) }
    .btn-danger{ background:linear-gradient(135deg,#fee2e2,#fff1f2); border-color:#fecaca; color:#991b1b }
    .btn-ghost{ background:#ffffff; border-color:var(--border) }

    input,select,textarea{ width:100%; padding:12px; border-radius:12px; border:1px solid var(--border); background:#fff; color:var(--text) }
    input:focus,select:focus,textarea:focus{ border-color:#94a3b8; outline:none; box-shadow:0 0 0 4px rgba(148,163,184,.2) }
    textarea{ min-height:90px; resize:vertical }

    .grid{ display:grid; grid-template-columns:1.3fr .9fr; gap:18px; align-items:start }
    @media (max-width:1050px){ .grid{ grid-template-columns:1fr } }

    .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden; animation:fadeUp .6s ease both }
    @keyframes fadeUp{ from{ opacity:0; transform:translateY(10px)} to{ opacity:1; transform:translateY(0)} }
    .card header{ padding:14px 16px; border-bottom:1px solid var(--border) }
    .card header h2{ margin:0; font-size:18px; font-weight:700 }
    .card .content{ padding:16px }

    .badge{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid var(--border); background:#fff }
    .badge.ok{ border-color:#bbf7d0; background:#f0fdf4; color:#166534 }
    .badge.warn{ border-color:#fde68a; background:#fffbeb; color:#92400e }
    .badge.off{ border-color:#fecaca; background:#fff1f2; color:#991b1b }

    /* Table */
    .table-toolbar{ display:flex; flex-wrap:wrap; gap:10px; align-items:end; margin-bottom:10px }
    .table-toolbar .field{ display:flex; flex-direction:column; gap:6px }
    .table-toolbar label{ font-size:12px; color:var(--muted) }
    table{ width:100%; border-collapse:separate; border-spacing:0 8px }
    thead th{ text-align:left; font-size:12px; color:var(--muted); font-weight:700; padding:0 10px; user-select:none; cursor:pointer }
    thead th.sortable:hover{ color:#0f172a }
    thead th .arrow{ opacity:.6; font-size:10px; margin-left:6px }
    tbody tr{ background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); transition:transform .12s ease }
    tbody tr:hover{ transform:translateY(-2px) }
    tbody td{ padding:12px 10px; vertical-align:top }
    tbody td:first-child{ border-top-left-radius:12px; border-bottom-left-radius:12px }
    tbody td:last-child{ border-top-right-radius:12px; border-bottom-right-radius:12px }

    /* Status accent bar on left */
    .row-status-Applied{ box-shadow: inset 4px 0 0 var(--applied), var(--shadow) }
    .row-status-Online-Assessment{ box-shadow: inset 4px 0 0 var(--online), var(--shadow) }
    .row-status-Video-Interview{ box-shadow: inset 4px 0 0 var(--video), var(--shadow) }
    .row-status-Assessment-Centre{ box-shadow: inset 4px 0 0 var(--centre), var(--shadow) }
    .row-status-Final-Interview{ box-shadow: inset 4px 0 0 var(--final), var(--shadow) }
    .row-status-Offer{ box-shadow: inset 4px 0 0 var(--offer), var(--shadow) }
    .row-status-Rejected{ box-shadow: inset 4px 0 0 var(--rejected), var(--shadow) }
    .row-status-Ghosted{ box-shadow: inset 4px 0 0 var(--ghosted), var(--shadow) }

    /* Pills & indicators */
    .pill{ display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); background:#fff; font-size:12px }
    .stage-age{ font-variant-numeric: tabular-nums; }
    .stage-age.warn{ color:#b45309 }     /* getting long */
    .stage-age.bad{ color:#b91c1c }      /* ghosting threshold */

    /* Search bar */
    .searchWrap{ margin-left:auto; display:flex; gap:8px; align-items:end }
    .searchWrap input{ min-width:240px }

    /* Charts */
    .charts{ display:grid; grid-template-columns:1.2fr 1fr; gap:14px }
    @media (max-width:900px){ .charts{ grid-template-columns:1fr } }
    .chart-wrap{ padding:12px; background:#fff; border:1px solid var(--border); border-radius:14px; position:relative; min-width:0; overflow:hidden }
    .chart-wrap.enlargeable{ cursor:zoom-in }
    .chart-wrap .expand-hint{ position:absolute; right:10px; top:8px; font-size:12px; color:var(--muted) }
    #statusPie{ min-height:280px; width:100% }

    a.link{ color:var(--accent1); text-decoration:none } a.link:hover{ text-decoration:underline }

    .sector-chip{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:var(--chip); border:1px solid var(--border) }
    .sector-chip .del{ background:transparent; border:none; color:#ef4444; cursor:pointer; font-weight:800; line-height:1 }

    /* Modal */
    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:50 }
    .modal.show{ display:flex }
    .backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.3) }
    .modal-card{ position:relative; width:min(1100px,92vw); height:min(72vh,720px); background:#fff; border:1px solid var(--border); border-radius:16px; box-shadow:0 20px 50px rgba(0,0,0,.15); overflow:hidden }
    .modal-card header{ display:flex; align-items:center; justify-content:space-between; padding:10px 14px; border-bottom:1px solid var(--border) }
    .modal-card h3{ margin:0; font-size:16px }
    .modal-card .close{ background:#fff; border:1px solid var(--border); color:#0f172a; padding:6px 10px; border-radius:10px; cursor:pointer }
    .modal-card .body{ padding:12px; height:calc(100% - 48px) }

    /* Stars for Chance Rating */
    .stars{ display:inline-block; line-height:1 }
    .stars .s{ font-size:14px; margin-right:1px }
    .stars .on{ color:#fbbf24 } /* amber */
    .stars .off{ color:#e5e7eb }

    .footerNote{ color:var(--muted); font-size:12px }
    .hidden { display: none !important; }
  </style>

  <!-- === Overrides for your requested layout + compact table === -->
  <style>
    /* Stack the two cards and make them same width:
       Add Application (aside) on top, Applications (section) underneath */
    .grid { grid-template-columns: 1fr !important; }
    .grid > aside.card { order: 1; }
    .grid > section.card { order: 2; }

    /* Keep everything readable without horizontal scroll */
    #appsTable { table-layout: fixed; }
    #appsTable th, #appsTable td { padding: 8px 8px; font-size: 13px; }

    /* Column widths (only set what we need) */
    #appsTable .col-status { width: 230px; }         /* wider Status */
    #appsTable .col-age { width: 100px; white-space: nowrap; }
    #appsTable .col-location { width: 90px; }        /* slimmer Location */
    #appsTable .col-actions { width: 90px; }         /* smaller action space */
    #appsTable .col-desc { width: 220px; white-space: normal; }

    /* Smaller action buttons */
    #appsTable .row-actions .btn-ghost,
    #appsTable .row-actions .btn-danger {
      padding: 6px 8px;
      font-size: 12px;
    }

    /* Wrap long text gracefully */
    #appsTable td { overflow: hidden; text-overflow: ellipsis; word-wrap: break-word; }
  </style>
</head>
<body>
  <div class="app" id="app">
    <header class="appbar">
      <div class="logo">
        <span class="dot"></span>
        <div>
          <h1>Graduate Applications Tracker</h1>
          <div class="sub">Light theme • Coloured bars • Advanced statuses • Effort & chance analytics • Cloud backup</div>
        </div>
      </div>
      <div class="controls">
        <span id="syncBadge" class="badge off" title="Cloud sync status">Offline</span>
        <button id="signinBtn" type="button">Sign in with Google</button>
        <button id="signoutBtn" class="btn-ghost hidden" type="button">Sign out</button>
        <button id="exportJsonBtn" title="Download a local backup" type="button">Export JSON</button>
        <button id="importJsonBtn" class="btn-ghost" title="Restore from a JSON backup" type="button">Import JSON</button>
        <input type="file" id="importFile" accept="application/json" class="hidden" />
      </div>
    </header>

    <section class="card">
      <header>
        <h2>Overview</h2>
      </header>
      <div class="content">
        <!-- Range + Search -->
        <div class="table-toolbar" style="margin-bottom:12px">
          <div class="field">
            <label for="rangeSelect">Chart range</label>
            <select id="rangeSelect">
              <option value="7d">Last 7 days</option>
              <option value="30d" selected>Last 30 days</option>
              <option value="90d">Last 90 days</option>
              <option value="ytd">Year to date</option>
              <option value="all">All time</option>
              <option value="custom">Custom…</option>
            </select>
          </div>
          <div id="customRangeFields" class="field" style="display:none">
            <label>Custom range</label>
            <div style="display:flex; gap:8px">
              <input type="date" id="rangeFrom">
              <input type="date" id="rangeTo">
              <button id="applyRangeBtn" type="button">Apply</button>
            </div>
          </div>

          <div class="searchWrap">
            <div class="field">
              <label for="searchInput">Search (company, role, description)</label>
              <input id="searchInput" placeholder="e.g., Barclays, Analyst, 'renewables'"/>
            </div>
          </div>
        </div>

        <div class="charts">
          <!-- Daily combo chart (bars + cumulative line) -->
          <div class="chart-wrap enlargeable" id="dailyWrap" title="Click to enlarge">
            <span class="expand-hint">Click to enlarge</span>
            <canvas id="dailyChart" height="150" aria-label="Applications per day and cumulative"></canvas>
          </div>

          <!-- Status pie chart -->
          <div class="chart-wrap" id="statusWrap">
            <canvas id="statusPie" height="150" aria-label="Applications by status"></canvas>
          </div>
        </div>

        <!-- Effort performance -->
        <div class="charts" style="margin-top:12px; grid-template-columns:1fr;">
          <div class="chart-wrap">
            <canvas id="effortChart" height="140" aria-label="Success by effort level"></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- Grid now stacks because of the CSS override above -->
    <div class="grid" style="margin-top:18px">
      <!-- Applications table (will render UNDER the form due to order rules) -->
      <section class="card">
        <header>
          <h2>Applications</h2>
        </header>
        <div class="content">
          <div class="table-toolbar">
            <div class="field">
              <label for="sectorFilter">Filter by sector</label>
              <select id="sectorFilter"></select>
            </div>
            <div class="field">
              <label for="typeFilter">Filter by role type</label>
              <select id="typeFilter"></select>
            </div>
            <div class="field">
              <label for="chanceFilter">Filter by chance</label>
              <select id="chanceFilter">
                <option value="">All</option>
                <option>Very Low</option>
                <option>Low</option>
                <option>Medium</option>
                <option>High</option>
                <option>Very High</option>
              </select>
            </div>
            <div class="field">
              <label for="sortKey">Sort by</label>
              <select id="sortKey">
                <option value="applied">Applied date</option>
                <option value="company">Company</option>
                <option value="role">Role</option>
                <option value="type">Type</option>
                <option value="sector">Sector</option>
                <option value="closing">Closing date</option>
                <option value="start">Start date</option>
              </select>
            </div>
            <div class="field">
              <label for="sortDir">Direction</label>
              <select id="sortDir">
                <option value="desc">Descending</option>
                <option value="asc">Ascending</option>
              </select>
            </div>
            <div style="align-self:end; padding-bottom:2px">
              <button id="applySortBtn" class="btn-ghost" type="button">Apply</button>
              <button id="clearFilterBtn" class="btn-ghost" type="button">Clear</button>
            </div>
          </div>

          <div style="overflow:auto">
            <table id="appsTable">
              <thead>
                <tr>
                  <th class="sortable col-company" data-key="company">Company <span class="arrow" id="arrow-company"></span></th>
                  <th class="sortable col-role" data-key="role">Role <span class="arrow" id="arrow-role"></span></th>
                  <th class="sortable col-type" data-key="type">Type <span class="arrow" id="arrow-type"></span></th>
                  <th class="sortable col-sector" data-key="sector">Sector <span class="arrow" id="arrow-sector"></span></th>

                  <!-- split: Status + Stage age -->
                  <th class="col-status">Status</th>
                  <th class="sortable col-age" data-key="stageAge">Stage age <span class="arrow" id="arrow-stageAge"></span></th>

                  <th class="sortable col-chance" data-key="chance">Chance <span class="arrow" id="arrow-chance"></span></th>
                  <th class="sortable col-applied" data-key="applied">Applied <span class="arrow" id="arrow-applied"></span></th>
                  <th class="sortable col-closing" data-key="closing">Closing <span class="arrow" id="arrow-closing"></span></th>
                  <th class="sortable col-start" data-key="start">Start <span class="arrow" id="arrow-start"></span></th>
                  <th class="sortable col-location" data-key="location">Location <span class="arrow" id="arrow-location"></span></th>
                  <th class="col-link">Link</th>
                  <th class="col-desc">Description</th>
                  <th class="col-actions">Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="footerNote" style="margin-top:10px">
            <span id="lastBackup" class="badge warn">No cloud backup yet</span>
          </div>
        </div>
      </section>

      <!-- Add Application form (ordered ABOVE the table by CSS) -->
      <aside class="card">
        <header>
          <h2 id="formTitle">Add Application</h2>
        </header>
        <div class="content">
          <form id="appForm">
            <input type="hidden" id="appId" />

            <div>
              <label for="company">Company</label>
              <input id="company" required placeholder="e.g., Barclays" />
            </div>
            <div>
              <label for="role">Role Title</label>
              <input id="role" required placeholder="e.g., Graduate Analyst" />
            </div>

            <div>
              <label for="type">Role Type</label>
              <select id="type" required></select>
            </div>
            <div>
              <label for="sector">Sector</label>
              <select id="sector" required></select>
            </div>

            <div>
              <label for="status">Status</label>
              <select id="status" required>
                <option>Applied</option>
                <option>Online Assessment</option>
                <option>Video Interview</option>
                <option>Assessment Centre</option>
                <option>Final Interview</option>
                <option>Offer</option>
                <option>Rejected</option>
                <option>Ghosted</option>
              </select>
            </div>

            <div>
              <label for="applied">Applied Date</label>
              <input id="applied" type="date" required />
            </div>
            <div>
              <label for="closing">Closing Date</label>
              <input id="closing" type="date" />
            </div>
            <div>
              <label for="start">Start Date</label>
              <input id="start" type="date" />
            </div>
            <div>
              <label for="location">Location</label>
              <input id="location" placeholder="e.g., London" />
            </div>

            <div>
              <label for="effort">Effort Level</label>
              <select id="effort">
                <option>Quick Apply</option>
                <option>Standard Application</option>
                <option>Fully Customised</option>
                <option>No AI</option>
                <option>Other</option>
              </select>
            </div>
            <div>
              <label for="chance">Chance Rating</label>
              <select id="chance">
                <option>Very Low</option>
                <option>Low</option>
                <option selected>Medium</option>
                <option>High</option>
                <option>Very High</option>
              </select>
            </div>

            <div class="full">
              <label for="url">Job Link (optional)</label>
              <input id="url" type="url" placeholder="https://company.com/graduate-role" />
            </div>

            <div class="full">
              <label for="description">Role Description / Notes</label>
              <textarea id="description" placeholder="Short summary, who you spoke to, etc."></textarea>
            </div>

            <div class="full" style="display:flex; gap:10px; margin-top:4px">
              <button type="submit" id="saveBtn">Save</button>
              <button type="button" id="cancelEditBtn" class="btn-ghost hidden">Cancel Edit</button>
            </div>
          </form>

          <hr style="border:none; border-top:1px solid var(--border); margin:18px 0">

          <div>
            <h3 style="margin:0 0 8px; font-size:14px">Manage Sectors</h3>
            <div class="controls" style="gap:8px">
              <input id="newSector" placeholder="Add sector (e.g., Finance)"/>
              <button id="addSectorBtn" type="button">Add</button>
            </div>
            <div id="sectorsList" style="margin-top:10px; display:flex; flex-wrap:wrap; gap:8px"></div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- PART 2/2 (scripts) will start right after this line -->
Here’s **PART 2/2 — Scripts**. Paste this **immediately after** the “PART 2/2 (scripts) will start right after this line” comment from Part 1. It includes the app logic + Firebase sync and closes the `</body></html>` tags.

```html
<script>
/* ========= v12 Core (Data + UI + Charts + Analytics) ========= */

/* --- Keys & constants --- */
const STORAGE_KEY   = 'gradAppTracker:data:v12';
const SECTORS_KEY   = 'gradAppTracker:sectors:v3';
const TYPES_KEY     = 'gradAppTracker:types:v1';
const DEFAULT_SECTORS = ['Finance','Consulting','Engineering','Sales'];
const DEFAULT_TYPES   = ['Graduate Job','Internship','Placement','Apprenticeship','Job','Other'];

/* Advanced stages */
const STAGES = [
  'Applied',
  'Online Assessment',
  'Video Interview',
  'Assessment Centre',
  'Final Interview',
  'Offer',
  'Rejected',
  'Ghosted'
];

/* Effort & Chance lists */
const EFFORTS = ['Quick Apply','Standard Application','Fully Customised','No AI','Other'];
const CHANCES = ['Very Low','Low','Medium','High','Very High'];

/* Ghosting thresholds */
const WARN_DAYS = 14;
const GHOST_DAYS = 21;

/* --- Date helpers (LOCAL/UK) --- */
const toYMDLocal = d => {
  const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const y = x.getFullYear(), m = String(x.getMonth()+1).padStart(2,'0'), da = String(x.getDate()).padStart(2,'0');
  return `${y}-${m}-${da}`;
};
const parseYMDLocal = ymd => new Date(ymd + 'T00:00:00');
const daysBetween = (fromYMD, toYMD) => {
  if(!fromYMD || !toYMD) return 0;
  const a = parseYMDLocal(fromYMD), b = parseYMDLocal(toYMD);
  return Math.round((b - a)/86400000);
};
function todayYMD(){ return toYMDLocal(new Date()); }

/* --- Utils --- */
function uuid(){ return crypto.randomUUID ? crypto.randomUUID() : (Date.now().toString(36)+Math.random().toString(36).slice(2,8)); }
function escapeHtml(str){
  const map = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'};
  return String(str || '').replace(/[&<>"]/g, c => map[c]);
}
function formatDate(ymd){ if(!ymd) return ''; try{ return parseYMDLocal(ymd).toLocaleDateString(undefined,{year:'numeric',month:'short',day:'2-digit'});}catch{return ymd} }
function normalizeStatusForClass(s){ return (s||'Applied').replace(/\s+/g,'-'); }
function renderLink(u){ if(!u) return ''; const safe = escapeHtml(u); return `<a class="link" href="${safe}" target="_blank" rel="noopener">Open</a>` }
function chanceToValue(ch){ return Math.max(0, CHANCES.indexOf(ch)); } // 0..4
function stars(ch){
  const v = chanceToValue(ch)+1; // 1..5
  let html = '<span class="stars">';
  for(let i=1;i<=5;i++) html += `<span class="s ${i<=v?'on':'off'}">★</span>`;
  return html + '</span>';
}

/* --- Storage --- */
function loadLocal(key, def){ try{ const raw = localStorage.getItem(key); return raw?JSON.parse(raw):def; }catch{ return def; } }
function saveLocal(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

let applications = (()=>{
  const now = loadLocal(STORAGE_KEY, null);
  if(now) return now;
  const fallbacks = ['gradAppTracker:data:v11','gradAppTracker:data:v10','gradAppTracker:data:v9'];
  for(const k of fallbacks){
    const v = loadLocal(k, null);
    if(v) return v;
  }
  return [];
})();
let sectors   = loadLocal(SECTORS_KEY, [...DEFAULT_SECTORS]);
let roleTypes = loadLocal(TYPES_KEY,   [...DEFAULT_TYPES]);

/* Placeholder – replaced in Firebase section */
function queueCloudSave(){ /* no-op until Firebase init */ }

/* --- DOM refs --- */
const sectorSelect   = document.querySelector('#sector');
const typeSelect     = document.querySelector('#type');
const sectorFilter   = document.querySelector('#sectorFilter');
const typeFilter     = document.querySelector('#typeFilter');
const chanceFilter   = document.querySelector('#chanceFilter');
const sectorsList    = document.querySelector('#sectorsList');
const appsTableBody  = document.querySelector('#appsTable tbody');

const sortKeySel     = document.querySelector('#sortKey');
const sortDirSel     = document.querySelector('#sortDir');
const applySortBtn   = document.querySelector('#applySortBtn');
const clearFilterBtn = document.querySelector('#clearFilterBtn');

const searchInput    = document.querySelector('#searchInput');

const form           = document.querySelector('#appForm');
const formTitle      = document.querySelector('#formTitle');
const cancelEditBtn  = document.querySelector('#cancelEditBtn');

const exportBtn      = document.querySelector('#exportJsonBtn');
const importBtn      = document.querySelector('#importJsonBtn');
const importFile     = document.querySelector('#importFile');

const dailyWrap      = document.getElementById('dailyWrap');
const statusWrap     = document.getElementById('statusWrap');
const dailyModal     = document.getElementById('dailyModal');
const modalBackdrop  = document.getElementById('modalBackdrop');
const modalClose     = document.getElementById('modalClose');

const rangeSelect    = document.getElementById('rangeSelect');
const customRangeFields = document.getElementById('customRangeFields');
const rangeFromInp   = document.getElementById('rangeFrom');
const rangeToInp     = document.getElementById('rangeTo');
const applyRangeBtn  = document.getElementById('applyRangeBtn');

const lastBackupEl   = document.getElementById('lastBackup');
const syncBadge      = document.getElementById('syncBadge');

/* --- Render selects --- */
function renderSectorOptions(){
  sectorSelect.innerHTML = sectors.map(s=>`<option>${escapeHtml(s)}</option>`).join('');
  sectorFilter.innerHTML = `<option value="">All sectors</option>` + sectors.map(s=>`<option>${escapeHtml(s)}</option>`).join('');
}
function renderTypeOptions(){
  typeSelect.innerHTML = roleTypes.map(t=>`<option>${escapeHtml(t)}</option>`).join('');
  typeFilter.innerHTML = `<option value="">All types</option>` + roleTypes.map(t=>`<option>${escapeHtml(t)}</option>`).join('');
}

/* --- Manage sectors (with working delete) --- */
function renderSectorsPills(){
  sectorsList.innerHTML = '';
  sectors.forEach(s=>{
    const chip = document.createElement('span');
    chip.className = 'sector-chip';
    const lbl = document.createElement('span'); lbl.textContent = `🏷️ ${s}`;
    const btn = document.createElement('button'); btn.type='button'; btn.className='del'; btn.textContent='×'; btn.title=`Delete ${s}`; btn.dataset.name=s;
    chip.append(lbl, btn);
    sectorsList.appendChild(chip);
  });
}
sectorsList.addEventListener('click',(e)=>{
  const btn = e.target.closest('button.del'); if(!btn) return;
  const name = btn.dataset.name; if(!name) return;
  const useCount = applications.filter(a=>a.sector===name).length;
  const proceed = confirm(`Delete sector "${name}"?${useCount?`\n\n${useCount} application(s) use this sector. They will be moved to "Other".`:''}`);
  if(!proceed) return;
  if(useCount){
    if(!sectors.includes('Other')) sectors.push('Other');
    applications = applications.map(a => a.sector===name?{...a, sector:'Other'}:a);
  }
  sectors = sectors.filter(s=>s!==name);
  saveLocal(SECTORS_KEY, sectors); queueCloudSave();
  saveLocal(STORAGE_KEY, applications); queueCloudSave();
  renderSectorOptions(); renderSectorsPills(); renderTable(); renderCharts();
});
document.getElementById('addSectorBtn').addEventListener('click', ()=>{
  const inp = document.getElementById('newSector');
  const val = (inp.value||'').trim();
  if(!val) return;
  if(sectors.includes(val)) { alert('Sector already exists.'); return; }
  sectors.push(val);
  saveLocal(SECTORS_KEY, sectors); queueCloudSave();
  inp.value=''; renderSectorOptions(); renderSectorsPills();
});

/* --- Sorting, filtering, search --- */
let currentSort = { key: 'applied', dir:'desc' };
function cmp(a,b){ return a<b?-1:a>b?1:0; }
function dateCmp(a,b){ if(!a&&!b) return 0; if(!a) return -1; if(!b) return 1; return cmp(a,b); }

function applySortAndFilter(rows){
  const fSector = sectorFilter.value;
  const fType   = typeFilter.value;
  const fChance = chanceFilter.value;
  const term    = searchInput.value.trim().toLowerCase();

  let arr = rows.filter(r=>{
    if(fSector && r.sector!==fSector) return false;
    if(fType   && (r.type||'')!==fType) return false;
    if(fChance && (r.chance||'Medium')!==fChance) return false;
    if(term){
      const hay = `${r.company||''} ${r.role||''} ${r.description||''}`.toLowerCase();
      if(!hay.includes(term)) return false;
    }
    return true;
  });

  const { key, dir } = currentSort; const sgn = dir==='asc'?1:-1;
  arr.sort((x,y)=>{
    if(['applied','closing','start'].includes(key)) return sgn*dateCmp(x[key]||'',y[key]||'');
    if(key==='chance') return sgn*(chanceToValue(x.chance||'Medium') - chanceToValue(y.chance||'Medium'));
    if(key==='stageAge') return sgn*(stageAge(x) - stageAge(y));      // NEW: sort by stage age
    return sgn*cmp((x[key]||'').toLowerCase(), (y[key]||'').toLowerCase());
  });
  return arr;
}
function updateHeaderArrows(){
  document.querySelectorAll('thead th .arrow').forEach(el=>el.textContent='');
  const arr = document.getElementById('arrow-' + currentSort.key);
  if(arr) arr.textContent = currentSort.dir==='asc'?'▲':'▼';
}
document.querySelectorAll('#appsTable thead th.sortable').forEach(th=>{
  th.addEventListener('click', ()=>{
    const key = th.getAttribute('data-key');
    if(currentSort.key===key){ currentSort.dir = currentSort.dir==='asc'?'desc':'asc'; }
    else { currentSort.key = key; currentSort.dir = key==='applied'?'desc':'asc'; }
    sortKeySel.value=currentSort.key; sortDirSel.value=currentSort.dir;
    renderTable();
  });
});
applySortBtn.addEventListener('click', ()=>{ currentSort.key=sortKeySel.value; currentSort.dir=sortDirSel.value; renderTable(); });
clearFilterBtn.addEventListener('click', ()=>{ sectorFilter.value=''; typeFilter.value=''; chanceFilter.value=''; searchInput.value=''; renderTable(); });
['input','change'].forEach(ev => searchInput.addEventListener(ev, renderTable));

/* --- Timeline helpers --- */
function ensureHistory(app){
  if(!Array.isArray(app.history) || app.history.length===0){
    const first = { status: app.status||'Applied', date: app.applied || todayYMD() };
    app.history = [first];
  }
  return app;
}
function lastStageDate(app){
  ensureHistory(app);
  return app.history[app.history.length-1]?.date || app.applied || todayYMD();
}
function stageAge(app){
  const last = lastStageDate(app);
  return daysBetween(last, todayYMD());
}
function timelineTooltip(app){
  ensureHistory(app);
  const items = [];
  for(let i=0;i<app.history.length;i++){
    const cur = app.history[i];
    const next = app.history[i+1];
    const to = next? next.date : todayYMD();
    const d = Math.max(0, daysBetween(cur.date, to));
    items.push(`${cur.status}: ${d}d`);
  }
  return items.join(' → ');
}
function firstResponseDays(app){
  ensureHistory(app);
  if(!app.applied) return null;
  if(app.history.length<=1) return null;
  const firstChange = app.history.find(h => h.status!=='Applied');
  if(!firstChange) return null;
  return daysBetween(app.applied, firstChange.date);
}
function isGhosting(app){
  const age = stageAge(app);
  const terminal = ['Offer','Rejected','Ghosted'].includes(app.status);
  return !terminal && age >= GHOST_DAYS;
}

/* --- Table render --- */
function rowStatusCell(app){
  ensureHistory(app);
  const select = `<select data-id="${app.id}" class="statusSelect">
    ${STAGES.map(s=>`<option ${s===(app.status||'Applied')?'selected':''}>${s}</option>`).join('')}
  </select>`;
  return `<div title="${escapeHtml(timelineTooltip(app))}">${select}</div>`;
}

function renderTable(){
  appsTableBody.innerHTML='';
  updateHeaderArrows();
  const rows = applySortAndFilter(applications.map(ensureHistory));

  const frag = document.createDocumentFragment();
  rows.forEach(app=>{
    const age = stageAge(app);
    const ageCls = age>=GHOST_DAYS ? 'stage-age bad' : age>=WARN_DAYS ? 'stage-age warn' : 'stage-age';

    const tr = document.createElement('tr'); tr.className = 'row-status-' + normalizeStatusForClass(app.status);
    tr.innerHTML = `
      <td class="col-company"><strong>${escapeHtml(app.company)}</strong></td>
      <td class="col-role">${escapeHtml(app.role||'')}</td>
      <td class="col-type">${escapeHtml(app.type||'')}</td>
      <td class="col-sector"><span class="pill">${escapeHtml(app.sector||'')}</span></td>

      <td class="col-status">${rowStatusCell(app)}</td>
      <td class="col-age" data-sort="${age}"><div class="${ageCls}">${age} day(s)</div></td>

      <td class="col-chance" data-sort="${chanceToValue(app.chance||'Medium')}">${stars(app.chance||'Medium')}</td>
      <td class="col-applied">${formatDate(app.applied)}</td>
      <td class="col-closing">${formatDate(app.closing)}</td>
      <td class="col-start">${formatDate(app.start)}</td>
      <td class="col-location">${escapeHtml(app.location||'')}</td>
      <td class="col-link">${renderLink(app.url)}</td>
      <td class="col-desc">${escapeHtml(app.description||'')}</td>
      <td class="col-actions">
        <div class="row-actions">
          <button class="btn-ghost" data-action="edit" data-id="${app.id}" type="button" title="Edit">✏️</button>
          <button class="btn-danger" data-action="delete" data-id="${app.id}" type="button" title="Delete">🗑️</button>
        </div>
      </td>`;
    frag.appendChild(tr);
  });
  appsTableBody.appendChild(frag);

  // Row actions & inline status changes
  appsTableBody.querySelectorAll('button[data-action]').forEach(btn => btn.addEventListener('click', onRowAction));
  appsTableBody.querySelectorAll('select.statusSelect').forEach(sel => sel.addEventListener('change', onStatusChange));

  renderCharts();
}

/* --- Add/Edit/Delete + Duplicate prevention --- */
function similarRole(a,b){
  if(!a||!b) return false;
  const A = a.toLowerCase().replace(/[^a-z0-9\s]/g,' ').replace(/\s+/g,' ').trim();
  const B = b.toLowerCase().replace(/[^a-z0-9\s]/g,' ').replace(/\s+/g,' ').trim();
  if(A===B) return true;
  if(A.includes(B) || B.includes(A)) return true;
  const setA = new Set(A.split(' ').filter(w=>w.length>3));
  const setB = new Set(B.split(' ').filter(w=>w.length>3));
  const inter = [...setA].filter(w=>setB.has(w)).length;
  const denom = Math.max(1, Math.min(setA.size, setB.size));
  return inter/denom >= 0.6;
}
function possibleDuplicates(newApp){
  return applications.filter(a =>
    a.company && newApp.company &&
    a.company.trim().toLowerCase() === newApp.company.trim().toLowerCase() &&
    similarRole(a.role, newApp.role) &&
    a.id !== newApp.id
  );
}

function onRowAction(e){
  const id = e.currentTarget.getAttribute('data-id');
  const action = e.currentTarget.getAttribute('data-action');
  if(action==='delete'){
    if(!confirm('Delete this application?')) return;
    applications = applications.filter(a=>a.id!==id);
    saveLocal(STORAGE_KEY, applications); queueCloudSave();
    renderTable();
  }
  if(action==='edit'){
    const app = applications.find(a=>a.id===id); if(!app) return;
    document.getElementById('appId').value = app.id;
    document.getElementById('company').value = app.company||'';
    document.getElementById('role').value = app.role||'';
    document.getElementById('type').value = app.type || (roleTypes[0]||'Graduate Job');
    document.getElementById('sector').value = app.sector||sectors[0]||'';
    document.getElementById('status').value = app.status||'Applied';
    document.getElementById('applied').value = app.applied || '';
    document.getElementById('closing').value = app.closing || '';
    document.getElementById('start').value = app.start || '';
    document.getElementById('location').value = app.location || '';
    document.getElementById('description').value = app.description || '';
    document.getElementById('url').value = app.url || '';
    document.getElementById('effort').value = app.effort || EFFORTS[1];
    document.getElementById('chance').value = app.chance || 'Medium';
    formTitle.textContent = 'Edit Application';
    cancelEditBtn.classList.remove('hidden');
    document.getElementById('company').focus();
  }
}

function onStatusChange(e){
  const id = e.currentTarget.getAttribute('data-id');
  const app = applications.find(a=>a.id===id); if(!app) return;
  const newStatus = e.currentTarget.value;
  if(app.status !== newStatus){
    app.status = newStatus;
    ensureHistory(app);
    app.history.push({ status:newStatus, date: todayYMD() });
  }
  saveLocal(STORAGE_KEY, applications); queueCloudSave();
  renderTable();
}

cancelEditBtn.addEventListener('click', ()=>{
  form.reset(); document.getElementById('appId').value='';
  formTitle.textContent='Add Application'; cancelEditBtn.classList.add('hidden');
});

form.addEventListener('submit', (e)=>{
  e.preventDefault();
  const id = document.getElementById('appId').value || uuid();
  const rawUrl = (document.getElementById('url').value||'').trim();
  const safeUrl = rawUrl && !/^https?:\/\//i.test(rawUrl) ? 'https://' + rawUrl : rawUrl;

  const newApp = {
    id,
    company: (document.getElementById('company').value||'').trim(),
    role: (document.getElementById('role').value||'').trim(),
    type: document.getElementById('type').value,
    sector: document.getElementById('sector').value,
    status: document.getElementById('status').value,
    applied: document.getElementById('applied').value,
    closing: document.getElementById('closing').value,
    start: document.getElementById('start').value,
    location: (document.getElementById('location').value||'').trim(),
    description: (document.getElementById('description').value||'').trim(),
    url: safeUrl,
    effort: document.getElementById('effort').value,
    chance: document.getElementById('chance').value
  };

  const existing = applications.find(a=>a.id===id);
  if(existing){
    ensureHistory(existing);
    if(existing.status !== newApp.status){
      existing.history.push({ status:newApp.status, date: todayYMD() });
    }
    const merged = { ...existing, ...newApp, history: existing.history };
    const dups = possibleDuplicates(merged);
    if(dups.length && !confirm(`Possible duplicate(s) found:\n\n${dups.map(d=>`• ${d.company} — ${d.role}`).join('\n')}\n\nSave anyway?`)) return;

    applications = applications.map(a=>a.id===id?merged:a);
  } else {
    newApp.history = [{ status:newApp.status||'Applied', date: newApp.applied || todayYMD() }];
    const dups = possibleDuplicates(newApp);
    if(dups.length && !confirm(`Possible duplicate(s) found:\n\n${dups.map(d=>`• ${d.company} — ${d.role}`).join('\n')}\n\nAdd anyway?`)) return;

    applications.push(newApp);
  }

  saveLocal(STORAGE_KEY, applications); queueCloudSave();
  renderTable();
  form.reset(); document.getElementById('appId').value='';
  formTitle.textContent='Add Application'; cancelEditBtn.classList.add('hidden');
});

/* --- Charts (Daily + Status Pie + Effort analytics) --- */
let dailyChart, statusPie, effortChart, modalDailyChart;

// Range state
let rangeMode = '30d';
let rangeFrom = null, rangeTo = null;

function buildDailySeries(){
  const allDates = applications.filter(a=>a.applied).map(a=>a.applied).sort();
  const today = todayYMD();
  const endYMD = allDates.length ? (allDates[allDates.length-1] < today ? today : allDates[allDates.length-1]) : today;

  let from, to;
  if(rangeMode==='all'){ from = allDates[0] || today; to = endYMD; }
  else if(rangeMode==='ytd'){ from = `${new Date().getFullYear()}-01-01`; to = endYMD; }
  else if(['7d','30d','90d'].includes(rangeMode)){
    const days = { '7d':7, '30d':30, '90d':90 }[rangeMode];
    const toDate = parseYMDLocal(endYMD);
    const fromDate = new Date(toDate); fromDate.setDate(fromDate.getDate()-(days-1));
    from = toYMDLocal(fromDate); to = endYMD;
  } else { // custom
    from = rangeFrom || (allDates[0] || today);
    to   = rangeTo   || endYMD;
  }

  const labels = [];
  const counts = new Map();
  applications.forEach(a=>{ if(a.applied && a.applied>=from && a.applied<=to){ counts.set(a.applied, (counts.get(a.applied)||0)+1); } });
  let d = parseYMDLocal(from), end = parseYMDLocal(to);
  while(d<=end){ labels.push(toYMDLocal(d)); d = new Date(d.getFullYear(), d.getMonth(), d.getDate()+1); }
  const perDay = labels.map(k=>counts.get(k)||0);
  const cumulative = []; let run = 0; perDay.forEach(n=>{ run += n; cumulative.push(run); });
  return { labels, perDay, cumulative };
}

function colorVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim() || name; }

function renderDailyComboChart(){
  const ctx = document.getElementById('dailyChart'); if(!ctx) return;
  const s = buildDailySeries();
  const cfg = {
    type:'bar',
    data:{
      labels: s.labels.map(x=>parseYMDLocal(x)),
      datasets:[
        { type:'bar', label:'Applications per day', data: s.perDay, yAxisID:'y',
          borderWidth:0, barPercentage:0.6, categoryPercentage:0.8,
          backgroundColor: colorVar('--bar')
        },
        { type:'line', label:'Cumulative total', data: s.cumulative, yAxisID:'y1',
          borderWidth:2, tension:.35, fill:false, borderColor: colorVar('--line'), pointRadius:0
        }
      ]
    },
    options:{
      animation:{ duration:500, easing:'easeOutQuart' },
      scales:{
        x:{ type:'time', time:{ unit:'day' }, grid:{ display:false }, ticks:{ color:'#475569' } },
        y:{ beginAtZero:true, ticks:{ precision:0, color:'#475569' }, grid:{ color:'#e2e8f0' } },
        y1:{ position:'right', beginAtZero:true, ticks:{ precision:0, color:'#475569' }, grid:{ drawOnChartArea:false } }
      },
      plugins:{ legend:{ labels:{ color:'#334155' } }, tooltip:{ mode:'index', intersect:false } },
      maintainAspectRatio:false
    }
  };
  if(dailyChart){ dailyChart.data = cfg.data; dailyChart.options = cfg.options; dailyChart.update(); }
  else { dailyChart = new Chart(ctx, cfg); }
}

function renderStatusPie(){
  const ctx = document.getElementById('statusPie'); if(!ctx) return;
  const byStatus = STAGES.map(s=>({ s, n: applications.filter(a=>(a.status||'Applied')===s).length }));
  const colors = {
    'Applied':'#2563eb',
    'Online Assessment':'#06b6d4',
    'Video Interview':'#10b981',
    'Assessment Centre':'#f59e0b',
    'Final Interview':'#7c3aed',
    'Offer':'#7c3aed',
    'Rejected':'#dc2626',
    'Ghosted':'#6b7280'
  };
  const data = { labels: byStatus.map(x=>x.s), datasets:[{ data: byStatus.map(x=>x.n), backgroundColor: byStatus.map(x=>colors[x.s]) }] };
  const options = {
    responsive:true, maintainAspectRatio:false, layout:{ padding:8 },
    plugins:{ legend:{ position: (statusWrap.offsetWidth>=520?'right':'bottom'), labels:{ color:'#334155', usePointStyle:true, boxWidth:10, boxHeight:10, padding:12, font:{ size:12 } } } }
  };
  if(statusPie){ statusPie.data=data; statusPie.options=options; statusPie.update(); }
  else { statusPie = new Chart(ctx,{ type:'pie', data, options }); }
}

function renderEffortChart(){
  const ctx = document.getElementById('effortChart'); if(!ctx) return;
  const buckets = {};
  EFFORTS.forEach(e=>buckets[e]={ total:0, offers:0, respDays:[] });
  applications.forEach(a=>{
    const e = a.effort || 'Standard Application';
    if(!buckets[e]) buckets[e]={ total:0, offers:0, respDays:[] };
    buckets[e].total++;
    if(a.status==='Offer') buckets[e].offers++;
    const fr = firstResponseDays(a); if(fr!=null) buckets[e].respDays.push(fr);
  });
  const labels = Object.keys(buckets);
  const offerRate = labels.map(k=>{
    const b = buckets[k]; return b.total? Math.round((b.offers/b.total)*100):0;
  });
  const avgResp = labels.map(k=>{
    const arr = buckets[k].respDays; if(!arr.length) return 0;
    return Math.round(arr.reduce((s,x)=>s+x,0)/arr.length);
  });

  const cfg = {
    type:'bar',
    data:{
      labels,
      datasets:[
        { type:'bar', label:'Offer rate %', data: offerRate, yAxisID:'y', backgroundColor: colorVar('--bar'), borderWidth:0 },
        { type:'line', label:'Avg days to first response', data: avgResp, yAxisID:'y1', borderColor: colorVar('--line'), borderWidth:2, tension:.35, fill:false, pointRadius:0 }
      ]
    },
    options:{
      animation:{ duration:400 }, maintainAspectRatio:false,
      scales:{
        y:{ beginAtZero:true, suggestedMax:100, ticks:{ color:'#475569' }, grid:{ color:'#e2e8f0' } },
        y1:{ position:'right', beginAtZero:true, ticks:{ color:'#475569' }, grid:{ drawOnChartArea:false } },
        x:{ ticks:{ color:'#475569' }, grid:{ display:false } }
      },
      plugins:{ legend:{ labels:{ color:'#334155' } }, tooltip:{ mode:'index', intersect:false } }
    }
  };
  if(effortChart){ effortChart.data = cfg.data; effortChart.options = cfg.options; effortChart.update(); }
  else { effortChart = new Chart(ctx, cfg); }
}

function renderCharts(){ renderDailyComboChart(); renderStatusPie(); renderEffortChart(); }
window.addEventListener('resize', ()=>{ if(statusPie){ statusPie.options.plugins.legend.position = (statusWrap.offsetWidth>=520?'right':'bottom'); statusPie.update(); }});

/* --- Range UI actions --- */
rangeSelect.addEventListener('change', ()=>{
  rangeMode = rangeSelect.value;
  const isCustom = rangeMode==='custom';
  customRangeFields.style.display = isCustom ? '' : 'none';
  if(!isCustom) renderCharts();
});
applyRangeBtn.addEventListener('click', ()=>{
  rangeFrom = rangeFromInp.value || null;
  rangeTo   = rangeToInp.value   || null;
  if(rangeFrom && rangeTo && rangeFrom>rangeTo){ const t=rangeFrom; rangeFrom=rangeTo; rangeTo=t; rangeFromInp.value=rangeFrom; rangeToInp.value=rangeTo; }
  renderCharts();
});

/* --- Export / Import --- */
exportBtn.addEventListener('click', ()=>{
  const ts = todayYMD();
  const blob = new Blob([JSON.stringify({ version:'v12', applications, sectors, roleTypes }, null, 2)], { type:'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download=`graduate-applications-backup-${ts}.json`; a.click();
  URL.revokeObjectURL(url);
});
importBtn.addEventListener('click', ()=> importFile.click());
importFile.addEventListener('change', async (e)=>{
  const file = e.target.files[0]; if(!file) return;
  try{
    const text = await file.text();
    const parsed = JSON.parse(text);
    if(Array.isArray(parsed.applications)) applications = parsed.applications;
    else if(Array.isArray(parsed)) applications = parsed; // very old backup
    if(Array.isArray(parsed.sectors))    sectors = parsed.sectors;
    if(Array.isArray(parsed.roleTypes))  roleTypes = parsed.roleTypes;
    saveLocal(STORAGE_KEY, applications);
    saveLocal(SECTORS_KEY, sectors);
    saveLocal(TYPES_KEY, roleTypes);
    renderSectorOptions(); renderTypeOptions(); renderSectorsPills(); renderTable();
  }catch(err){ alert('Invalid JSON file.'); }
  importFile.value='';
});

/* --- Modal enlarge behaviour --- */
let modalDailyChart=null;
function openDailyModal(){
  dailyModal.classList.add('show');
  const ctx = document.getElementById('modalDailyCanvas');
  const s = buildDailySeries();
  const cfg = {
    type:'bar',
    data:{
      labels: s.labels.map(x=>parseYMDLocal(x)),
      datasets:[
        { type:'bar', label:'Applications per day', data: s.perDay, yAxisID:'y', backgroundColor: colorVar('--bar'), borderWidth:0 },
        { type:'line', label:'Cumulative total', data: s.cumulative, yAxisID:'y1', borderColor: colorVar('--line'), borderWidth:2, tension:.35, fill:false, pointRadius:0 }
      ]
    },
    options:{
      animation:{ duration:0 },
      scales:{ x:{ type:'time', time:{ unit:'day' } }, y:{ beginAtZero:true }, y1:{ position:'right', beginAtZero:true } },
      plugins:{ legend:{ } },
      maintainAspectRatio:false
    }
  };
  if(modalDailyChart) modalDailyChart.destroy();
  modalDailyChart = new Chart(ctx, cfg);
  document.addEventListener('keydown', escHandler);
}
function closeDailyModal(){ dailyModal.classList.remove('show'); if(modalDailyChart){ modalDailyChart.destroy(); modalDailyChart=null; } document.removeEventListener('keydown', escHandler); }
function escHandler(e){ if(e.key==='Escape') closeDailyModal(); }
dailyWrap.addEventListener('click', openDailyModal);
modalBackdrop.addEventListener('click', closeDailyModal);
modalClose.addEventListener('click', closeDailyModal);

/* --- Init --- */
function init(){
  renderSectorOptions(); renderTypeOptions(); renderSectorsPills();
  sortKeySel.value = currentSort.key; sortDirSel.value = currentSort.dir;
  sectorFilter.value = ''; typeFilter.value=''; chanceFilter.value='';
  if(!document.getElementById('applied').value) document.getElementById('applied').value = todayYMD();
  rangeToInp.value = todayYMD();
  renderTable(); renderCharts();
  const syncBadgeEl = document.getElementById('syncBadge');
  if(syncBadgeEl){ syncBadgeEl.textContent = 'Offline'; syncBadgeEl.className = 'badge off'; }
}
init();

/* In Firebase section we’ll attach cloud sync and override queueCloudSave() */
</script>

<script>
/* ========= v12 Firebase Cloud Sync (overrides queueCloudSave) ========= */
const firebaseConfig = {
  apiKey: "AIzaSyA6U3E6qocjEr1Nx1wAI1d4PGIGKOFm8rc",
  authDomain: "grad-tracker-2b268.firebaseapp.com",
  projectId: "grad-tracker-2b268",
  storageBucket: "grad-tracker-2b268.firebasestorage.app",
  messagingSenderId: "118189138960",
  appId: "1:118189138960:web:3660eb38050e7730329695"
};

let auth=null, db=null, cloudReady=false, saveTimer=null;

function configLooksFilled(){
  return Object.values(firebaseConfig).every(v => v && !/PASTE_HERE/i.test(String(v)));
}
function setBadge(text, cls){
  if(!syncBadge) return;
  syncBadge.textContent = text;
  syncBadge.className = 'badge ' + cls;
}
function updateLastBackup(ts){
  if(!lastBackupEl) return;
  if(!ts){ lastBackupEl.textContent = 'No cloud backup yet'; lastBackupEl.className='badge warn'; return; }
  const d = ts.toLocaleString?.() || ts;
  lastBackupEl.textContent = 'Last cloud backup: ' + d;
  lastBackupEl.className='badge ok';
}

/* Debounced saver */
function queueCloudSave(){
  if(!cloudReady || !auth?.currentUser) return;
  clearTimeout(saveTimer);
  saveTimer = setTimeout(pushToCloud, 600);
}

async function pushToCloud(){
  if(!cloudReady || !auth?.currentUser) return;
  try{
    const ref = db.collection('users').doc(auth.currentUser.uid).collection('tracker').doc('state');
    await ref.set({
      applications, sectors, roleTypes,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge:true });
    setBadge('Synced','ok');
    await autoDailyBackup();
  }catch(err){
    console.warn('Cloud save failed', err);
    setBadge('Sync error','warn');
  }
}

async function autoDailyBackup(){
  if(!auth?.currentUser) return;
  const ymd = todayYMD();
  const bref = db.collection('users').doc(auth.currentUser.uid).collection('backups').doc(ymd);
  await bref.set({
    applications, sectors, roleTypes,
    ts: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge:true });
  updateLastBackup(new Date());
}

async function loadFromCloud(){
  if(!auth?.currentUser) return;
  try{
    const ref = db.collection('users').doc(auth.currentUser.uid).collection('tracker').doc('state');
    const snap = await ref.get();
    if(snap.exists){
      const d = snap.data()||{};
      if(Array.isArray(d.applications)) applications = d.applications;
      if(Array.isArray(d.sectors))      sectors = d.sectors;
      if(Array.isArray(d.roleTypes))    roleTypes = d.roleTypes;
      saveLocal(STORAGE_KEY, applications);
      saveLocal(SECTORS_KEY, sectors);
      saveLocal(TYPES_KEY, roleTypes);
      renderSectorOptions(); renderTypeOptions(); renderSectorsPills(); renderTable();
      setBadge('Loaded from cloud','ok');
      await autoDailyBackup();
    } else {
      await ref.set({ applications, sectors, roleTypes, createdAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
      setBadge('Initialised cloud','ok');
      await autoDailyBackup();
    }
  }catch(err){
    console.warn('Load from cloud failed', err);
    setBadge('Cloud unavailable','warn');
  }
}

/* First-sign-in conflict resolver */
async function resolveCloudConflict(){
  const ref = db.collection('users').doc(auth.currentUser.uid).collection('tracker').doc('state');
  const snap = await ref.get();
  const localApps = applications || [];
  if(snap.exists){
    const d = snap.data()||{};
    const cloudApps = Array.isArray(d.applications)? d.applications : [];
    const different = JSON.stringify(cloudApps) !== JSON.stringify(localApps);
    if(localApps.length && cloudApps.length && different){
      const useCloud = confirm(
        `Cloud has ${cloudApps.length} applications; your device has ${localApps.length}.\n\n` +
        `OK = Load cloud data (recommended if this is your usual device)\n` +
        `Cancel = Keep your local data and upload it to the cloud`
      );
      if(useCloud){
        applications = cloudApps;
        if(Array.isArray(d.sectors))   sectors = d.sectors;
        if(Array.isArray(d.roleTypes)) roleTypes = d.roleTypes;
        saveLocal(STORAGE_KEY, applications);
        saveLocal(SECTORS_KEY, sectors);
        saveLocal(TYPES_KEY, roleTypes);
        renderSectorOptions(); renderTypeOptions(); renderSectorsPills(); renderTable();
        setBadge('Loaded from cloud','ok');
        await autoDailyBackup();
      } else {
        await pushToCloud();
      }
    } else if(cloudApps.length){
      applications = cloudApps;
      if(Array.isArray(d.sectors))   sectors = d.sectors;
      if(Array.isArray(d.roleTypes)) roleTypes = d.roleTypes;
      saveLocal(STORAGE_KEY, applications);
      saveLocal(SECTORS_KEY, sectors);
      saveLocal(TYPES_KEY, roleTypes);
      renderSectorOptions(); renderTypeOptions(); renderSectorsPills(); renderTable();
      setBadge('Loaded from cloud','ok');
      await autoDailyBackup();
    } else {
      await pushToCloud();
      setBadge('Initialised cloud','ok');
    }
  } else {
    await pushToCloud();
    setBadge('Initialised cloud','ok');
  }
}

function setupAuth(){
  const provider = new firebase.auth.GoogleAuthProvider();
  document.getElementById('signinBtn').onclick  = () => auth.signInWithPopup(provider).catch(err => alert('Sign-in failed: ' + err.message));
  document.getElementById('signoutBtn').onclick = () => auth.signOut();

  auth.onAuthStateChanged(async (u)=>{
    if(u){
      document.getElementById('signinBtn').classList.add('hidden');
      document.getElementById('signoutBtn').classList.remove('hidden');
      setBadge('Signed in','ok');
      try{ await resolveCloudConflict(); }catch(e){ await loadFromCloud(); }
    } else {
      document.getElementById('signinBtn').classList.remove('hidden');
      document.getElementById('signoutBtn').classList.add('hidden');
      setBadge('Offline','off');
      updateLastBackup(null);
    }
  });
}

(function initFirebase(){
  if(!window.firebase) return;
  if(!configLooksFilled()){
    setBadge('Offline (add Firebase config)','off');
    return;
  }
  try{
    firebase.initializeApp(firebaseConfig);
    auth = firebase.auth();
    db   = firebase.firestore();
    db.enablePersistence().catch(()=>{ /* ignore persistence errors */ });
    cloudReady = true;
    setBadge('Ready (not signed in)','warn');
    setupAuth();
  }catch(err){
    console.warn('Firebase init failed', err);
    setBadge('Cloud off','off');
  }
})();
</script>

</body>
</html>
```
